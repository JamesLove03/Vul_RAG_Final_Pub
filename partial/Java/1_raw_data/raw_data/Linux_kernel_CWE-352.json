[
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n  private static final long serialVersionUID = -277853572580468505L;\n\n  private static final String MAGIC_PASSWORD = \"******\";\n\n  @SpringBean(name = \"userDao\")\n  private UserDao userDao;\n\n  private final SetupTarget setupMode = SetupTarget.TEST_DATA;\n\n  private final TimeZone timeZone = TimeZone.getDefault();\n\n  private String sysopEMail;\n\n  private String feedbackEMail;\n\n  private String calendarDomain;\n\n  private final String adminUsername = InitDatabaseDao.DEFAULT_ADMIN_USER;\n\n  // @SuppressWarnings(\"unused\")\n  // private String organization;\n\n  @SuppressWarnings(\"unused\")\n  private String password;\n\n  @SuppressWarnings(\"unused\")\n  private String passwordRepeat;\n\n  private String encryptedPassword;\n\n  public SetupForm(final SetupPage parentPage)\n  {\n    super(parentPage, \"setupform\");\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    final GridBuilder gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newFormHeading(getString(\"administration.setup.heading\"));\n    final DivPanel panel = gridBuilder.getPanel();\n    panel.add(new ParTextPanel(panel.newChildId(), getString(\"administration.setup.heading.subtitle\")));\n    {\n      // RadioChoice mode\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.setup.target\"));\n      final DivPanel radioPanel = new DivPanel(fs.newChildId(), DivType.RADIOBOX);\n      fs.add(radioPanel);\n      fs.setLabelFor(radioPanel);\n      final RadioGroupPanel<SetupTarget> radioGroup = new RadioGroupPanel<SetupTarget>(radioPanel.newChildId(), \"setuptarget\",\n          new PropertyModel<SetupTarget>(this, \"setupMode\"));\n      radioPanel.add(radioGroup);\n      for (final SetupTarget target : SetupTarget.values()) {\n        radioGroup.add(new Model<SetupTarget>(target), getString(target.getI18nKey()), getString(target.getI18nKey() + \".tooltip\"));\n      }\n    }\n    // final RequiredMaxLengthTextField organizationField = new RequiredMaxLengthTextField(this, \"organization\", getString(\"organization\"),\n    // new PropertyModel<String>(this, \"organization\"), 100);\n    // add(organizationField);\n    {\n      // User name\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"username\"));\n      fs.add(new RequiredMaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"adminUsername\"), 100));\n    }\n    final PasswordTextField passwordField = new PasswordTextField(PasswordPanel.WICKET_ID, new PropertyModel<String>(this, \"password\")) {\n      @Override\n      protected void onComponentTag(final ComponentTag tag)\n      {\n        super.onComponentTag(tag);\n        if (encryptedPassword == null) {\n          tag.put(\"value\", \"\");\n        } else if (StringUtils.isEmpty(getConvertedInput()) == false) {\n          tag.put(\"value\", MAGIC_PASSWORD);\n        }\n      }\n    };\n    {\n      // Password\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"password\"));\n      passwordField.setRequired(true); // No setReset(true), otherwise uploading and re-entering passwords is a real pain.\n      fs.add(passwordField);\n      WicketUtils.setFocus(passwordField);\n    }\n    {\n      // Password repeat\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"passwordRepeat\"));\n      final PasswordTextField passwordRepeatField = new PasswordTextField(PasswordPanel.WICKET_ID, new PropertyModel<String>(this,\n          \"passwordRepeat\")) {\n        @Override\n        protected void onComponentTag(final ComponentTag tag)\n        {\n          super.onComponentTag(tag);\n          if (encryptedPassword == null) {\n            tag.put(\"value\", \"\");\n          } else if (StringUtils.isEmpty(getConvertedInput()) == false) {\n            tag.put(\"value\", MAGIC_PASSWORD);\n          }\n        }\n      };\n      passwordRepeatField.setRequired(true); // No setReset(true), otherwise uploading and re-entering passwords is a real pain.\n      passwordRepeatField.add(new IValidator<String>() {\n        @Override\n        public void validate(final IValidatable<String> validatable)\n        {\n          final String input = validatable.getValue();\n          final String passwordInput = passwordField.getConvertedInput();\n          if (StringUtils.equals(input, passwordInput) == false) {\n            passwordRepeatField.error(getString(\"user.error.passwordAndRepeatDoesNotMatch\"));\n            encryptedPassword = null;\n            return;\n          }\n          if (MAGIC_PASSWORD.equals(passwordInput) == false || encryptedPassword == null) {\n            final String errorMsgKey = userDao.checkPasswordQuality(passwordInput);\n            if (errorMsgKey != null) {\n              encryptedPassword = null;\n              passwordField.error(getString(errorMsgKey));\n            } else {\n              encryptedPassword = userDao.encryptPassword(passwordInput);\n            }\n          }\n        }\n      });\n      fs.add(passwordRepeatField);\n    }\n    {\n      // Time zone\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.timezone\"));\n      final TimeZonePanel timeZone = new TimeZonePanel(fs.newChildId(), new PropertyModel<TimeZone>(this, \"timeZone\"));\n      fs.setLabelFor(timeZone);\n      fs.add(timeZone);\n      fs.addHelpIcon(getString(\"administration.configuration.param.timezone.description\"));\n    }\n    {\n      // Calendar domain\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.calendarDomain\"));\n      final RequiredMaxLengthTextField textField = new RequiredMaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this,\n          \"calendarDomain\"), ConfigurationDO.PARAM_LENGTH);\n      fs.add(textField);\n      textField.add(new IValidator<String>() {\n        @Override\n        public void validate(final IValidatable<String> validatable)\n        {\n          if (Configuration.isDomainValid(validatable.getValue()) == false) {\n            textField.error(getString(\"validation.error.generic\"));\n          }\n        }\n      });\n      fs.addHelpIcon(getString(\"administration.configuration.param.calendarDomain.description\"));\n    }\n    {\n      // E-Mail sysops\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.systemAdministratorEMail.label\"),\n          getString(\"email\"));\n      fs.add(new MaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"sysopEMail\"), ConfigurationDO.PARAM_LENGTH));\n      fs.addHelpIcon(getString(\"administration.configuration.param.systemAdministratorEMail.description\"));\n    }\n    {\n      // E-Mail sysops\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.feedbackEMail.label\"),\n          getString(\"email\"));\n      fs.add(new MaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"feedbackEMail\"), ConfigurationDO.PARAM_LENGTH));\n      fs.addHelpIcon(getString(\"administration.configuration.param.feedbackEMail.description\"));\n    }\n    final RepeatingView actionButtons = new RepeatingView(\"buttons\");\n    add(actionButtons);\n    {\n      final Button finishButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"finish\")) {\n        @Override\n        public final void onSubmit()\n        {\n          parentPage.finishSetup();\n        }\n      };\n      final SingleButtonPanel finishButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), finishButton,\n          getString(\"administration.setup.finish\"), SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(finishButtonPanel);\n      setDefaultButton(finishButton);\n    }\n  }\n\n  public SetupTarget getSetupMode()\n  {\n    return setupMode;\n  }\n\n  public TimeZone getTimeZone()\n  {\n    return timeZone;\n  }\n\n  /**\n   * @return the calendarDomain\n   */\n  public String getCalendarDomain()\n  {\n    return calendarDomain;\n  }\n\n  public String getSysopEMail()\n  {\n    return sysopEMail;\n  }\n\n  public String getFeedbackEMail()\n  {\n    return feedbackEMail;\n  }\n\n  public String getEncryptedPassword()\n  {\n    return encryptedPassword;\n  }\n\n  public String getAdminUsername()\n  {\n    return adminUsername;\n  }\n}",
    "code_after_change": "{\n  private static final long serialVersionUID = -277853572580468505L;\n\n  private static final String MAGIC_PASSWORD = \"******\";\n\n  @SpringBean(name = \"userDao\")\n  private UserDao userDao;\n\n  private final SetupTarget setupMode = SetupTarget.TEST_DATA;\n\n  private final TimeZone timeZone = TimeZone.getDefault();\n\n  private String sysopEMail;\n\n  private String feedbackEMail;\n\n  private String calendarDomain;\n\n  private final String adminUsername = InitDatabaseDao.DEFAULT_ADMIN_USER;\n\n  // @SuppressWarnings(\"unused\")\n  // private String organization;\n\n  @SuppressWarnings(\"unused\")\n  private String password;\n\n  @SuppressWarnings(\"unused\")\n  private String passwordRepeat;\n\n  private String encryptedPassword;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  public SetupForm(final SetupPage parentPage)\n  {\n    super(parentPage, \"setupform\");\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    final GridBuilder gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newFormHeading(getString(\"administration.setup.heading\"));\n    final DivPanel panel = gridBuilder.getPanel();\n    panel.add(new ParTextPanel(panel.newChildId(), getString(\"administration.setup.heading.subtitle\")));\n    {\n      // RadioChoice mode\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.setup.target\"));\n      final DivPanel radioPanel = new DivPanel(fs.newChildId(), DivType.RADIOBOX);\n      fs.add(radioPanel);\n      fs.setLabelFor(radioPanel);\n      final RadioGroupPanel<SetupTarget> radioGroup = new RadioGroupPanel<SetupTarget>(radioPanel.newChildId(), \"setuptarget\",\n          new PropertyModel<SetupTarget>(this, \"setupMode\"));\n      radioPanel.add(radioGroup);\n      for (final SetupTarget target : SetupTarget.values()) {\n        radioGroup.add(new Model<SetupTarget>(target), getString(target.getI18nKey()), getString(target.getI18nKey() + \".tooltip\"));\n      }\n    }\n    // final RequiredMaxLengthTextField organizationField = new RequiredMaxLengthTextField(this, \"organization\", getString(\"organization\"),\n    // new PropertyModel<String>(this, \"organization\"), 100);\n    // add(organizationField);\n    {\n      // User name\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"username\"));\n      fs.add(new RequiredMaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"adminUsername\"), 100));\n    }\n    final PasswordTextField passwordField = new PasswordTextField(PasswordPanel.WICKET_ID, new PropertyModel<String>(this, \"password\")) {\n      @Override\n      protected void onComponentTag(final ComponentTag tag)\n      {\n        super.onComponentTag(tag);\n        if (encryptedPassword == null) {\n          tag.put(\"value\", \"\");\n        } else if (StringUtils.isEmpty(getConvertedInput()) == false) {\n          tag.put(\"value\", MAGIC_PASSWORD);\n        }\n      }\n    };\n    {\n      // Password\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"password\"));\n      passwordField.setRequired(true); // No setReset(true), otherwise uploading and re-entering passwords is a real pain.\n      fs.add(passwordField);\n      WicketUtils.setFocus(passwordField);\n    }\n    {\n      // Password repeat\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"passwordRepeat\"));\n      final PasswordTextField passwordRepeatField = new PasswordTextField(PasswordPanel.WICKET_ID, new PropertyModel<String>(this,\n          \"passwordRepeat\")) {\n        @Override\n        protected void onComponentTag(final ComponentTag tag)\n        {\n          super.onComponentTag(tag);\n          if (encryptedPassword == null) {\n            tag.put(\"value\", \"\");\n          } else if (StringUtils.isEmpty(getConvertedInput()) == false) {\n            tag.put(\"value\", MAGIC_PASSWORD);\n          }\n        }\n      };\n      passwordRepeatField.setRequired(true); // No setReset(true), otherwise uploading and re-entering passwords is a real pain.\n      passwordRepeatField.add(new IValidator<String>() {\n        @Override\n        public void validate(final IValidatable<String> validatable)\n        {\n          final String input = validatable.getValue();\n          final String passwordInput = passwordField.getConvertedInput();\n          if (StringUtils.equals(input, passwordInput) == false) {\n            passwordRepeatField.error(getString(\"user.error.passwordAndRepeatDoesNotMatch\"));\n            encryptedPassword = null;\n            return;\n          }\n          if (MAGIC_PASSWORD.equals(passwordInput) == false || encryptedPassword == null) {\n            final String errorMsgKey = userDao.checkPasswordQuality(passwordInput);\n            if (errorMsgKey != null) {\n              encryptedPassword = null;\n              passwordField.error(getString(errorMsgKey));\n            } else {\n              encryptedPassword = userDao.encryptPassword(passwordInput);\n            }\n          }\n        }\n      });\n      fs.add(passwordRepeatField);\n    }\n    {\n      // Time zone\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.timezone\"));\n      final TimeZonePanel timeZone = new TimeZonePanel(fs.newChildId(), new PropertyModel<TimeZone>(this, \"timeZone\"));\n      fs.setLabelFor(timeZone);\n      fs.add(timeZone);\n      fs.addHelpIcon(getString(\"administration.configuration.param.timezone.description\"));\n    }\n    {\n      // Calendar domain\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.calendarDomain\"));\n      final RequiredMaxLengthTextField textField = new RequiredMaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this,\n          \"calendarDomain\"), ConfigurationDO.PARAM_LENGTH);\n      fs.add(textField);\n      textField.add(new IValidator<String>() {\n        @Override\n        public void validate(final IValidatable<String> validatable)\n        {\n          if (Configuration.isDomainValid(validatable.getValue()) == false) {\n            textField.error(getString(\"validation.error.generic\"));\n          }\n        }\n      });\n      fs.addHelpIcon(getString(\"administration.configuration.param.calendarDomain.description\"));\n    }\n    {\n      // E-Mail sysops\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.systemAdministratorEMail.label\"),\n          getString(\"email\"));\n      fs.add(new MaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"sysopEMail\"), ConfigurationDO.PARAM_LENGTH));\n      fs.addHelpIcon(getString(\"administration.configuration.param.systemAdministratorEMail.description\"));\n    }\n    {\n      // E-Mail sysops\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.configuration.param.feedbackEMail.label\"),\n          getString(\"email\"));\n      fs.add(new MaxLengthTextField(InputPanel.WICKET_ID, new PropertyModel<String>(this, \"feedbackEMail\"), ConfigurationDO.PARAM_LENGTH));\n      fs.addHelpIcon(getString(\"administration.configuration.param.feedbackEMail.description\"));\n    }\n    final RepeatingView actionButtons = new RepeatingView(\"buttons\");\n    add(actionButtons);\n    {\n      final Button finishButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"finish\")) {\n        @Override\n        public final void onSubmit()\n        {\n          csrfTokenHandler.onSubmit();\n          parentPage.finishSetup();\n        }\n      };\n      final SingleButtonPanel finishButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), finishButton,\n          getString(\"administration.setup.finish\"), SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(finishButtonPanel);\n      setDefaultButton(finishButton);\n    }\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n\n  public SetupTarget getSetupMode()\n  {\n    return setupMode;\n  }\n\n  public TimeZone getTimeZone()\n  {\n    return timeZone;\n  }\n\n  /**\n   * @return the calendarDomain\n   */\n  public String getCalendarDomain()\n  {\n    return calendarDomain;\n  }\n\n  public String getSysopEMail()\n  {\n    return sysopEMail;\n  }\n\n  public String getFeedbackEMail()\n  {\n    return feedbackEMail;\n  }\n\n  public String getEncryptedPassword()\n  {\n    return encryptedPassword;\n  }\n\n  public String getAdminUsername()\n  {\n    return adminUsername;\n  }\n}",
    "patch": "@@ -40,6 +40,7 @@\n import org.projectforge.database.InitDatabaseDao;\n import org.projectforge.user.UserDao;\n import org.projectforge.web.wicket.AbstractForm;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WicketUtils;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n import org.projectforge.web.wicket.components.MaxLengthTextField;\n@@ -86,9 +87,15 @@ public class SetupForm extends AbstractForm<SetupForm, SetupPage>\n \n   private String encryptedPassword;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   public SetupForm(final SetupPage parentPage)\n   {\n     super(parentPage, \"setupform\");\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n   }\n \n   @Override\n@@ -227,6 +234,7 @@ public void validate(final IValidatable<String> validatable)\n         @Override\n         public final void onSubmit()\n         {\n+          csrfTokenHandler.onSubmit();\n           parentPage.finishSetup();\n         }\n       };\n@@ -237,6 +245,13 @@ public final void onSubmit()\n     }\n   }\n \n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n+  }\n+\n   public SetupTarget getSetupMode()\n   {\n     return setupMode;",
    "function_modified_lines": {
      "added": [
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "    csrfTokenHandler = new CsrfTokenHandler(this);\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11959
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.admin;\n\nimport org.apache.wicket.markup.html.form.Button;\nimport org.apache.wicket.markup.html.form.upload.FileUploadField;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.apache.wicket.model.Model;\nimport org.apache.wicket.util.lang.Bytes;\nimport org.projectforge.web.wicket.AbstractForm;\nimport org.projectforge.web.wicket.bootstrap.GridBuilder;\nimport org.projectforge.web.wicket.components.SingleButtonPanel;\nimport org.projectforge.web.wicket.flowlayout.FieldsetPanel;\nimport org.projectforge.web.wicket.flowlayout.FileUploadPanel;\n\npublic class SetupImportForm extends AbstractForm<SetupImportForm, SetupPage>\n{\n  private static final long serialVersionUID = -277853572580468505L;\n\n  protected FileUploadField fileUploadField;\n\n  protected String filename;\n\n  public SetupImportForm(final SetupPage parentPage)\n  {\n    super(parentPage, \"importform\");\n    initUpload(Bytes.megabytes(100));\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    final GridBuilder gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newFormHeading(getString(\"import\"));\n    {\n      // Upload dump file\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.setup.dumpFile\"));\n      fileUploadField = new FileUploadField(FileUploadPanel.WICKET_ID);\n      fs.add(new FileUploadPanel(fs.newChildId(), fileUploadField));\n    }\n    final RepeatingView actionButtons = new RepeatingView(\"buttons\");\n    add(actionButtons);\n    {\n      final Button importButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"import\")) {\n        @Override\n        public final void onSubmit()\n        {\n          parentPage.upload();\n        }\n      };\n      final SingleButtonPanel importButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), importButton, getString(\"import\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(importButtonPanel);\n    }\n  }\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.admin;\n\nimport org.apache.wicket.markup.html.form.Button;\nimport org.apache.wicket.markup.html.form.upload.FileUploadField;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.apache.wicket.model.Model;\nimport org.apache.wicket.util.lang.Bytes;\nimport org.projectforge.web.wicket.AbstractForm;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\nimport org.projectforge.web.wicket.bootstrap.GridBuilder;\nimport org.projectforge.web.wicket.components.SingleButtonPanel;\nimport org.projectforge.web.wicket.flowlayout.FieldsetPanel;\nimport org.projectforge.web.wicket.flowlayout.FileUploadPanel;\n\npublic class SetupImportForm extends AbstractForm<SetupImportForm, SetupPage>\n{\n  private static final long serialVersionUID = -277853572580468505L;\n\n  protected FileUploadField fileUploadField;\n\n  protected String filename;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  public SetupImportForm(final SetupPage parentPage)\n  {\n    super(parentPage, \"importform\");\n    initUpload(Bytes.megabytes(100));\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    final GridBuilder gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newFormHeading(getString(\"import\"));\n    {\n      // Upload dump file\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"administration.setup.dumpFile\"));\n      fileUploadField = new FileUploadField(FileUploadPanel.WICKET_ID);\n      fs.add(new FileUploadPanel(fs.newChildId(), fileUploadField));\n    }\n    final RepeatingView actionButtons = new RepeatingView(\"buttons\");\n    add(actionButtons);\n    {\n      final Button importButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"import\")) {\n        @Override\n        public final void onSubmit()\n        {\n          parentPage.upload();\n        }\n      };\n      final SingleButtonPanel importButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), importButton, getString(\"import\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(importButtonPanel);\n    }\n  }\n}\n",
    "patch": "@@ -29,6 +29,7 @@\n import org.apache.wicket.model.Model;\n import org.apache.wicket.util.lang.Bytes;\n import org.projectforge.web.wicket.AbstractForm;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n import org.projectforge.web.wicket.components.SingleButtonPanel;\n import org.projectforge.web.wicket.flowlayout.FieldsetPanel;\n@@ -42,10 +43,23 @@ public class SetupImportForm extends AbstractForm<SetupImportForm, SetupPage>\n \n   protected String filename;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   public SetupImportForm(final SetupPage parentPage)\n   {\n     super(parentPage, \"importform\");\n     initUpload(Bytes.megabytes(100));\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n+  }\n+\n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n   }\n \n   @Override",
    "function_modified_lines": {
      "added": [
        "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "    csrfTokenHandler = new CsrfTokenHandler(this);\n",
        "  }\n",
        "\n",
        "  @Override\n",
        "  protected void onSubmit()\n",
        "  {\n",
        "    super.onSubmit();\n",
        "    csrfTokenHandler.onSubmit();\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11961
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.admin;\n\nimport java.util.SortedSet;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.markup.html.WebMarkupContainer;\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.Button;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.apache.wicket.model.Model;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.Version;\nimport org.projectforge.continuousdb.UpdateEntry;\nimport org.projectforge.continuousdb.UpdatePreCheckStatus;\nimport org.projectforge.web.HtmlHelper;\nimport org.projectforge.web.wicket.AbstractForm;\nimport org.projectforge.web.wicket.bootstrap.GridBuilder;\nimport org.projectforge.web.wicket.components.SingleButtonPanel;\nimport org.projectforge.web.wicket.flowlayout.CheckBoxPanel;\nimport org.projectforge.web.wicket.flowlayout.FieldsetPanel;\nimport org.projectforge.web.wicket.flowlayout.MyComponentsRepeater;\n\npublic class SystemUpdateForm extends AbstractForm<SystemUpdateForm, SystemUpdatePage>\n{\n  private static final long serialVersionUID = 2492737003121592489L;\n\n  protected WebMarkupContainer scripts;\n\n  public boolean showOldUpdateScripts;\n\n  private GridBuilder gridBuilder;\n\n  /**\n   * List to create content menu in the desired order before creating the RepeatingView.\n   */\n  protected MyComponentsRepeater<SingleButtonPanel> actionButtons;\n\n  public SystemUpdateForm(final SystemUpdatePage parentPage)\n  {\n    super(parentPage);\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newGridPanel();\n    {\n      final FieldsetPanel fs = gridBuilder.newFieldset(\"Show all\");\n      fs.add(new CheckBoxPanel(fs.newChildId(), new PropertyModel<Boolean>(this, \"showOldUpdateScripts\"), null, true) {\n        /**\n         * @see org.projectforge.web.wicket.flowlayout.CheckBoxPanel#onSelectionChanged(java.lang.Boolean)\n         */\n        @Override\n        protected void onSelectionChanged(final Boolean newSelection)\n        {\n          parentPage.refresh();\n        }\n      });\n    }\n    scripts = new WebMarkupContainer(\"scripts\");\n    add(scripts);\n    updateEntryRows();\n\n    actionButtons = new MyComponentsRepeater<SingleButtonPanel>(\"buttons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button refreshButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"refresh\")) {\n        @Override\n        public final void onSubmit()\n        {\n          parentPage.refresh();\n        }\n      };\n      final SingleButtonPanel refreshButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), refreshButton, \"refresh\",\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(refreshButtonPanel);\n      setDefaultButton(refreshButton);\n    }\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void updateEntryRows()\n  {\n    scripts.removeAll();\n    final RepeatingView scriptRows = new RepeatingView(\"scriptRows\");\n    scripts.add(scriptRows);\n    final SortedSet<UpdateEntry> updateEntries = parentPage.myDatabaseUpdater.getSystemUpdater().getUpdateEntries();\n    if (updateEntries == null) {\n      return;\n    }\n    boolean odd = true;\n    for (final UpdateEntry updateEntry : updateEntries) {\n      if (showOldUpdateScripts == false && updateEntry.getPreCheckStatus() == UpdatePreCheckStatus.ALREADY_UPDATED) {\n        continue;\n      }\n      final Version version = updateEntry.getVersion();\n      final WebMarkupContainer item = new WebMarkupContainer(scriptRows.newChildId());\n      scriptRows.add(item);\n      if (odd == true) {\n        item.add(AttributeModifier.append(\"class\", \"odd\"));\n      } else {\n        item.add(AttributeModifier.append(\"class\", \"even\"));\n      }\n      odd = !odd;\n      item.add(new Label(\"regionId\", updateEntry.getRegionId()));\n      if (updateEntry.isInitial() == true) {\n        item.add(new Label(\"version\", \"initial\"));\n      } else {\n        item.add(new Label(\"version\", version.toString()));\n      }\n      final String description = updateEntry.getDescription();\n      item.add(new Label(\"description\", StringUtils.isBlank(description) == true ? \"\" : description));\n      item.add(new Label(\"date\", updateEntry.getDate()));\n      final String preCheckResult = updateEntry.getPreCheckResult();\n      item.add(new Label(\"preCheckResult\", HtmlHelper.escapeHtml(preCheckResult, true)));\n      if (updateEntry.getPreCheckStatus() == UpdatePreCheckStatus.READY_FOR_UPDATE) {\n        final Button updateButton = new Button(\"button\", new Model<String>(\"update\")) {\n          @Override\n          public final void onSubmit()\n          {\n            parentPage.update(updateEntry);\n          }\n        };\n        item.add(new SingleButtonPanel(\"update\", updateButton, \"update\"));\n      } else {\n        final String runningResult = updateEntry.getRunningResult();\n        item.add(new Label(\"update\", HtmlHelper.escapeHtml(runningResult, true)));\n      }\n    }\n  }\n\n  /**\n   * @see org.projectforge.web.wicket.AbstractForm#onBeforeRender()\n   */\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.admin;\n\nimport java.util.SortedSet;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.markup.html.WebMarkupContainer;\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.Button;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.apache.wicket.model.Model;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.Version;\nimport org.projectforge.continuousdb.UpdateEntry;\nimport org.projectforge.continuousdb.UpdatePreCheckStatus;\nimport org.projectforge.web.HtmlHelper;\nimport org.projectforge.web.wicket.AbstractForm;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\nimport org.projectforge.web.wicket.bootstrap.GridBuilder;\nimport org.projectforge.web.wicket.components.SingleButtonPanel;\nimport org.projectforge.web.wicket.flowlayout.CheckBoxPanel;\nimport org.projectforge.web.wicket.flowlayout.FieldsetPanel;\nimport org.projectforge.web.wicket.flowlayout.MyComponentsRepeater;\n\npublic class SystemUpdateForm extends AbstractForm<SystemUpdateForm, SystemUpdatePage>\n{\n  private static final long serialVersionUID = 2492737003121592489L;\n\n  protected WebMarkupContainer scripts;\n\n  public boolean showOldUpdateScripts;\n\n  private GridBuilder gridBuilder;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  /**\n   * List to create content menu in the desired order before creating the RepeatingView.\n   */\n  protected MyComponentsRepeater<SingleButtonPanel> actionButtons;\n\n  public SystemUpdateForm(final SystemUpdatePage parentPage)\n  {\n    super(parentPage);\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    gridBuilder.newGridPanel();\n    {\n      final FieldsetPanel fs = gridBuilder.newFieldset(\"Show all\");\n      fs.add(new CheckBoxPanel(fs.newChildId(), new PropertyModel<Boolean>(this, \"showOldUpdateScripts\"), null, true) {\n        /**\n         * @see org.projectforge.web.wicket.flowlayout.CheckBoxPanel#onSelectionChanged(java.lang.Boolean)\n         */\n        @Override\n        protected void onSelectionChanged(final Boolean newSelection)\n        {\n          parentPage.refresh();\n        }\n      });\n    }\n    scripts = new WebMarkupContainer(\"scripts\");\n    add(scripts);\n    updateEntryRows();\n\n    actionButtons = new MyComponentsRepeater<SingleButtonPanel>(\"buttons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button refreshButton = new Button(SingleButtonPanel.WICKET_ID, new Model<String>(\"refresh\")) {\n        @Override\n        public final void onSubmit()\n        {\n          parentPage.refresh();\n        }\n      };\n      final SingleButtonPanel refreshButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), refreshButton, \"refresh\",\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(refreshButtonPanel);\n      setDefaultButton(refreshButton);\n    }\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void updateEntryRows()\n  {\n    scripts.removeAll();\n    final RepeatingView scriptRows = new RepeatingView(\"scriptRows\");\n    scripts.add(scriptRows);\n    final SortedSet<UpdateEntry> updateEntries = parentPage.myDatabaseUpdater.getSystemUpdater().getUpdateEntries();\n    if (updateEntries == null) {\n      return;\n    }\n    boolean odd = true;\n    for (final UpdateEntry updateEntry : updateEntries) {\n      if (showOldUpdateScripts == false && updateEntry.getPreCheckStatus() == UpdatePreCheckStatus.ALREADY_UPDATED) {\n        continue;\n      }\n      final Version version = updateEntry.getVersion();\n      final WebMarkupContainer item = new WebMarkupContainer(scriptRows.newChildId());\n      scriptRows.add(item);\n      if (odd == true) {\n        item.add(AttributeModifier.append(\"class\", \"odd\"));\n      } else {\n        item.add(AttributeModifier.append(\"class\", \"even\"));\n      }\n      odd = !odd;\n      item.add(new Label(\"regionId\", updateEntry.getRegionId()));\n      if (updateEntry.isInitial() == true) {\n        item.add(new Label(\"version\", \"initial\"));\n      } else {\n        item.add(new Label(\"version\", version.toString()));\n      }\n      final String description = updateEntry.getDescription();\n      item.add(new Label(\"description\", StringUtils.isBlank(description) == true ? \"\" : description));\n      item.add(new Label(\"date\", updateEntry.getDate()));\n      final String preCheckResult = updateEntry.getPreCheckResult();\n      item.add(new Label(\"preCheckResult\", HtmlHelper.escapeHtml(preCheckResult, true)));\n      if (updateEntry.getPreCheckStatus() == UpdatePreCheckStatus.READY_FOR_UPDATE) {\n        final Button updateButton = new Button(\"button\", new Model<String>(\"update\")) {\n          @Override\n          public final void onSubmit()\n          {\n            parentPage.update(updateEntry);\n          }\n        };\n        item.add(new SingleButtonPanel(\"update\", updateButton, \"update\"));\n      } else {\n        final String runningResult = updateEntry.getRunningResult();\n        item.add(new Label(\"update\", HtmlHelper.escapeHtml(runningResult, true)));\n      }\n    }\n  }\n\n  /**\n   * @see org.projectforge.web.wicket.AbstractForm#onBeforeRender()\n   */\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n}\n",
    "patch": "@@ -38,6 +38,7 @@\n import org.projectforge.continuousdb.UpdatePreCheckStatus;\n import org.projectforge.web.HtmlHelper;\n import org.projectforge.web.wicket.AbstractForm;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n import org.projectforge.web.wicket.components.SingleButtonPanel;\n import org.projectforge.web.wicket.flowlayout.CheckBoxPanel;\n@@ -54,6 +55,11 @@ public class SystemUpdateForm extends AbstractForm<SystemUpdateForm, SystemUpdat\n \n   private GridBuilder gridBuilder;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   /**\n    * List to create content menu in the desired order before creating the RepeatingView.\n    */\n@@ -62,6 +68,7 @@ public class SystemUpdateForm extends AbstractForm<SystemUpdateForm, SystemUpdat\n   public SystemUpdateForm(final SystemUpdatePage parentPage)\n   {\n     super(parentPage);\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n   }\n \n   @Override\n@@ -165,4 +172,11 @@ public void onBeforeRender()\n     super.onBeforeRender();\n     actionButtons.render();\n   }\n+\n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n+  }\n }",
    "function_modified_lines": {
      "added": [
        "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "    csrfTokenHandler = new CsrfTokenHandler(this);\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11962
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(NavTopPanel.class);\n\n  private static final long serialVersionUID = -7858806882044188339L;\n\n  private FavoritesMenu favoritesMenu;\n\n  private final AccessChecker accessChecker;\n\n  private final UserXmlPreferencesCache userXmlPreferencesCache;\n\n  private BookmarkDialog bookmarkDialog;\n\n  public NavTopPanel(final String id, final UserXmlPreferencesCache userXmlPreferencesCache, final AccessChecker accessChecker)\n  {\n    super(id);\n    this.userXmlPreferencesCache = userXmlPreferencesCache;\n    this.accessChecker = accessChecker;\n  }\n\n  public void init(final AbstractSecuredPage page)\n  {\n    getMenu();\n    this.favoritesMenu = FavoritesMenu.get();\n    final WebMarkupContainer goMobile = new WebMarkupContainer(\"goMobile\");\n    add(goMobile);\n    if (page.getMySession().isMobileUserAgent() == true) {\n      goMobile.add(new BookmarkablePageLink<Void>(\"link\", MenuMobilePage.class));\n    } else {\n      goMobile.setVisible(false);\n    }\n    final BookmarkablePageLink<Void> layoutSettingsMenuLink = new BookmarkablePageLink<Void>(\"layoutSettingsMenuLink\",\n        LayoutSettingsPage.class);\n    if (UserRights.getAccessChecker().isRestrictedUser() == true) {\n      // Not visibible for restricted users:\n      layoutSettingsMenuLink.setVisible(false);\n    }\n    add(new MenuConfig(\"menuconfig\", getMenu(), favoritesMenu));\n    @SuppressWarnings(\"serial\")\n    final Form<String> searchForm = new Form<String>(\"searchForm\") {\n      private String searchString;\n\n      /**\n       * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n       */\n      @Override\n      protected void onSubmit()\n      {\n        if (StringUtils.isNotBlank(searchString) == true) {\n          final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n          setResponsePage(searchPage);\n        }\n        super.onSubmit();\n      }\n    };\n    add(searchForm);\n    final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n    WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));\n    searchForm.add(searchField);\n    add(layoutSettingsMenuLink);\n    add(new BookmarkablePageLink<Void>(\"feedbackLink\", FeedbackPage.class));\n    {\n      @SuppressWarnings(\"serial\")\n      final AjaxLink<Void> showBookmarkLink = new AjaxLink<Void>(\"showBookmarkLink\") {\n        /**\n         * @see org.apache.wicket.ajax.markup.html.AjaxLink#onClick(org.apache.wicket.ajax.AjaxRequestTarget)\n         */\n        @Override\n        public void onClick(final AjaxRequestTarget target)\n        {\n          bookmarkDialog.open(target);\n          // Redraw the content:\n          bookmarkDialog.redraw().addContent(target);\n        }\n      };\n      add(showBookmarkLink);\n      addBookmarkDialog();\n    }\n    {\n      add(new Label(\"user\", PFUserContext.getUser().getFullname()));\n      if (accessChecker.isRestrictedUser() == true) {\n        // Show ChangePaswordPage as my account for restricted users.\n        final BookmarkablePageLink<Void> changePasswordLink = new BookmarkablePageLink<Void>(\"myAccountLink\", ChangePasswordPage.class);\n        add(changePasswordLink);\n      } else {\n        final BookmarkablePageLink<Void> myAccountLink = new BookmarkablePageLink<Void>(\"myAccountLink\", MyAccountEditPage.class);\n        add(myAccountLink);\n      }\n      final BookmarkablePageLink<Void> documentationLink = new BookmarkablePageLink<Void>(\"documentationLink\", DocumentationPage.class);\n      add(documentationLink);\n\n      @SuppressWarnings(\"serial\")\n      final Link<String> logoutLink = new Link<String>(\"logoutLink\") {\n        @Override\n        public void onClick()\n        {\n          LoginPage.logout((MySession) getSession(), (WebRequest) getRequest(), (WebResponse) getResponse(), userXmlPreferencesCache);\n          setResponsePage(LoginPage.class);\n        };\n      };\n      add(logoutLink);\n    }\n    addCompleteMenu();\n    addFavoriteMenu();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private void addCompleteMenu()\n  {\n    final Label totalMenuSuffixLabel = new MenuSuffixLabel(\"totalMenuCounter\", new Model<Integer>() {\n      @Override\n      public Integer getObject()\n      {\n        int counter = 0;\n        if (menu.getMenuEntries() == null) {\n          return counter;\n        }\n        for (final MenuEntry menuEntry : menu.getMenuEntries()) {\n          final IModel<Integer> newCounterModel = menuEntry.getNewCounterModel();\n          if (newCounterModel != null && newCounterModel.getObject() != null) {\n            counter += newCounterModel.getObject();\n          }\n        }\n        return counter;\n      };\n    });\n    add(totalMenuSuffixLabel);\n\n    final RepeatingView completeMenuCategoryRepeater = new RepeatingView(\"completeMenuCategoryRepeater\");\n    add(completeMenuCategoryRepeater);\n    if (menu.getMenuEntries() != null) {\n      for (final MenuEntry menuEntry : menu.getMenuEntries()) {\n        if (menuEntry.getSubMenuEntries() == null) {\n          continue;\n        }\n        // Now we add a new menu area (title with sub menus):\n        final WebMarkupContainer categoryContainer = new WebMarkupContainer(completeMenuCategoryRepeater.newChildId());\n        completeMenuCategoryRepeater.add(categoryContainer);\n        categoryContainer.add(new Label(\"menuCategoryLabel\", getString(menuEntry.getI18nKey())));\n        final Label areaSuffixLabel = getSuffixLabel(menuEntry);\n        categoryContainer.add(areaSuffixLabel);\n\n        // final WebMarkupContainer subMenuContainer = new WebMarkupContainer(\"subMenu\");\n        // categoryContainer.add(subMenuContainer);\n        if (menuEntry.hasSubMenuEntries() == false) {\n          // subMenuContainer.setVisible(false);\n          continue;\n        }\n\n        final RepeatingView completeSubMenuRepeater = new RepeatingView(\"completeSubMenuRepeater\");\n        categoryContainer.add(completeSubMenuRepeater);\n        for (final MenuEntry subMenuEntry : menuEntry.getSubMenuEntries()) {\n          if (subMenuEntry.getSubMenuEntries() != null) {\n            log.error(\"Oups: sub sub menus not supported: \" + menuEntry.getId() + \" has child menus which are ignored.\");\n          }\n          // Now we add the next menu entry to the area:\n          final WebMarkupContainer subMenuItem = new WebMarkupContainer(completeSubMenuRepeater.newChildId());\n          completeSubMenuRepeater.add(subMenuItem);\n          final AbstractLink link = getMenuEntryLink(subMenuEntry, true);\n          if (link != null) {\n            subMenuItem.add(link);\n          } else {\n            subMenuItem.setVisible(false);\n          }\n        }\n      }\n    }\n\n  }\n\n  private void addFavoriteMenu()\n  {\n    // Favorite menu:\n    final RepeatingView menuRepeater = new RepeatingView(\"menuRepeater\");\n    add(menuRepeater);\n    final Collection<MenuEntry> menuEntries = favoritesMenu.getMenuEntries();\n    if (menuEntries != null) {\n      for (final MenuEntry menuEntry : menuEntries) {\n        // Now we add a new menu area (title with sub menus):\n        final WebMarkupContainer menuItem = new WebMarkupContainer(menuRepeater.newChildId());\n        menuRepeater.add(menuItem);\n        final AbstractLink link = getMenuEntryLink(menuEntry, true);\n        if (link == null) {\n          menuItem.setVisible(false);\n          continue;\n        }\n        menuItem.add(link);\n\n        final WebMarkupContainer subMenuContainer = new WebMarkupContainer(\"subMenu\");\n        menuItem.add(subMenuContainer);\n        final WebMarkupContainer caret = new WebMarkupContainer(\"caret\");\n        link.add(caret);\n        if (menuEntry.hasSubMenuEntries() == false) {\n          subMenuContainer.setVisible(false);\n          caret.setVisible(false);\n          continue;\n        }\n        menuItem.add(AttributeModifier.append(\"class\", \"dropdown\"));\n        link.add(AttributeModifier.append(\"class\", \"dropdown-toggle\"));\n        link.add(AttributeModifier.append(\"data-toggle\", \"dropdown\"));\n        final RepeatingView subMenuRepeater = new RepeatingView(\"subMenuRepeater\");\n        subMenuContainer.add(subMenuRepeater);\n        for (final MenuEntry subMenuEntry : menuEntry.getSubMenuEntries()) {\n          // Now we add the next menu entry to the area:\n          if (subMenuEntry.hasSubMenuEntries() == false) {\n            final WebMarkupContainer subMenuItem = new WebMarkupContainer(subMenuRepeater.newChildId());\n            subMenuRepeater.add(subMenuItem);\n            // Subsubmenu entries aren't yet supported, show only the sub entries without children, otherwise only the children are\n            // displayed.\n            final AbstractLink subLink = getMenuEntryLink(subMenuEntry, true);\n            if (subLink == null) {\n              subMenuItem.setVisible(false);\n              continue;\n            }\n            subMenuItem.add(subLink);\n            continue;\n          }\n\n          // final WebMarkupContainer subsubMenuContainer = new WebMarkupContainer(\"subsubMenu\");\n          // subMenuItem.add(subsubMenuContainer);\n          // if (subMenuEntry.hasSubMenuEntries() == false) {\n          // subsubMenuContainer.setVisible(false);\n          // continue;\n          // }\n          // final RepeatingView subsubMenuRepeater = new RepeatingView(\"subsubMenuRepeater\");\n          // subsubMenuContainer.add(subsubMenuRepeater);\n          for (final MenuEntry subsubMenuEntry : subMenuEntry.getSubMenuEntries()) {\n            // Now we add the next menu entry to the sub menu:\n            final WebMarkupContainer subMenuItem = new WebMarkupContainer(subMenuRepeater.newChildId());\n            subMenuRepeater.add(subMenuItem);\n            // Subsubmenu entries aren't yet supported, show only the sub entries without children, otherwise only the children are\n            // displayed.\n            final AbstractLink subLink = getMenuEntryLink(subsubMenuEntry, true);\n            if (subLink == null) {\n              subMenuItem.setVisible(false);\n              continue;\n            }\n            subMenuItem.add(subLink);\n            // final WebMarkupContainer subsubMenuItem = new WebMarkupContainer(subsubMenuRepeater.newChildId());\n            // subsubMenuRepeater.add(subsubMenuItem);\n            // final AbstractLink subsubLink = getMenuEntryLink(subsubMenuEntry, subsubMenuItem);\n            // subsubMenuItem.add(subsubLink);\n          }\n        }\n      }\n    }\n  }\n\n  private void addBookmarkDialog()\n  {\n    final AbstractSecuredPage parentPage = (AbstractSecuredPage) getPage();\n    bookmarkDialog = new BookmarkDialog(parentPage.newModalDialogId());\n    bookmarkDialog.setOutputMarkupId(true);\n    parentPage.add(bookmarkDialog);\n    bookmarkDialog.init();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class BookmarkDialog extends ModalDialog\n  {\n    /**\n     * @param id\n     */\n    public BookmarkDialog(final String id)\n    {\n      super(id);\n    }\n\n    @Override\n    public void init()\n    {\n      setTitle(getString(\"bookmark.title\"));\n      init(new Form<String>(getFormId()));\n      gridBuilder.newFormHeading(\"\"); // Otherwise it's empty and an IllegalArgumentException is thrown.\n    }\n\n    private BookmarkDialog redraw()\n    {\n      clearContent();\n      final AbstractSecuredPage page = (AbstractSecuredPage) NavTopPanel.this.getPage();\n      {\n        final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"bookmark.directPageLink\")).setLabelSide(false);\n        final TextArea<String> textArea = new TextArea<String>(fs.getTextAreaId(), new Model<String>(page.getPageAsLink()));\n        fs.add(textArea);\n        textArea.add(AttributeModifier.replace(\"onClick\", \"$(this).select();\"));\n      }\n      final PageParameters params = page.getBookmarkableInitialParameters();\n      if (params.isEmpty() == false) {\n        final FieldsetPanel fs = gridBuilder.newFieldset(getString(page.getTitleKey4BookmarkableInitialParameters())).setLabelSide(false);\n        final TextArea<String> textArea = new TextArea<String>(fs.getTextAreaId(), new Model<String>(page.getPageAsLink(params)));\n        fs.add(textArea);\n        textArea.add(AttributeModifier.replace(\"onClick\", \"$(this).select();\"));\n      }\n      return this;\n    }\n  }\n}",
    "code_after_change": "{\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(NavTopPanel.class);\n\n  private static final long serialVersionUID = -7858806882044188339L;\n\n  private FavoritesMenu favoritesMenu;\n\n  private final AccessChecker accessChecker;\n\n  private final UserXmlPreferencesCache userXmlPreferencesCache;\n\n  private BookmarkDialog bookmarkDialog;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private CsrfTokenHandler csrfTokenHandler;\n\n  public NavTopPanel(final String id, final UserXmlPreferencesCache userXmlPreferencesCache, final AccessChecker accessChecker)\n  {\n    super(id);\n    this.userXmlPreferencesCache = userXmlPreferencesCache;\n    this.accessChecker = accessChecker;\n  }\n\n  public void init(final AbstractSecuredPage page)\n  {\n    getMenu();\n    this.favoritesMenu = FavoritesMenu.get();\n    final WebMarkupContainer goMobile = new WebMarkupContainer(\"goMobile\");\n    add(goMobile);\n    if (page.getMySession().isMobileUserAgent() == true) {\n      goMobile.add(new BookmarkablePageLink<Void>(\"link\", MenuMobilePage.class));\n    } else {\n      goMobile.setVisible(false);\n    }\n    final BookmarkablePageLink<Void> layoutSettingsMenuLink = new BookmarkablePageLink<Void>(\"layoutSettingsMenuLink\",\n        LayoutSettingsPage.class);\n    if (UserRights.getAccessChecker().isRestrictedUser() == true) {\n      // Not visibible for restricted users:\n      layoutSettingsMenuLink.setVisible(false);\n    }\n    add(new MenuConfig(\"menuconfig\", getMenu(), favoritesMenu));\n    @SuppressWarnings(\"serial\")\n    final Form<String> searchForm = new Form<String>(\"searchForm\") {\n      private String searchString;\n\n      /**\n       * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n       */\n      @Override\n      protected void onSubmit()\n      {\n        csrfTokenHandler.onSubmit();\n        if (StringUtils.isNotBlank(searchString) == true) {\n          final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n          setResponsePage(searchPage);\n        }\n        super.onSubmit();\n      }\n    };\n    csrfTokenHandler = new CsrfTokenHandler(searchForm);\n    add(searchForm);\n    final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n    WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));\n    searchForm.add(searchField);\n    add(layoutSettingsMenuLink);\n    add(new BookmarkablePageLink<Void>(\"feedbackLink\", FeedbackPage.class));\n    {\n      @SuppressWarnings(\"serial\")\n      final AjaxLink<Void> showBookmarkLink = new AjaxLink<Void>(\"showBookmarkLink\") {\n        /**\n         * @see org.apache.wicket.ajax.markup.html.AjaxLink#onClick(org.apache.wicket.ajax.AjaxRequestTarget)\n         */\n        @Override\n        public void onClick(final AjaxRequestTarget target)\n        {\n          bookmarkDialog.open(target);\n          // Redraw the content:\n          bookmarkDialog.redraw().addContent(target);\n        }\n      };\n      add(showBookmarkLink);\n      addBookmarkDialog();\n    }\n    {\n      add(new Label(\"user\", PFUserContext.getUser().getFullname()));\n      if (accessChecker.isRestrictedUser() == true) {\n        // Show ChangePaswordPage as my account for restricted users.\n        final BookmarkablePageLink<Void> changePasswordLink = new BookmarkablePageLink<Void>(\"myAccountLink\", ChangePasswordPage.class);\n        add(changePasswordLink);\n      } else {\n        final BookmarkablePageLink<Void> myAccountLink = new BookmarkablePageLink<Void>(\"myAccountLink\", MyAccountEditPage.class);\n        add(myAccountLink);\n      }\n      final BookmarkablePageLink<Void> documentationLink = new BookmarkablePageLink<Void>(\"documentationLink\", DocumentationPage.class);\n      add(documentationLink);\n\n      @SuppressWarnings(\"serial\")\n      final Link<String> logoutLink = new Link<String>(\"logoutLink\") {\n        @Override\n        public void onClick()\n        {\n          LoginPage.logout((MySession) getSession(), (WebRequest) getRequest(), (WebResponse) getResponse(), userXmlPreferencesCache);\n          setResponsePage(LoginPage.class);\n        };\n      };\n      add(logoutLink);\n    }\n    addCompleteMenu();\n    addFavoriteMenu();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private void addCompleteMenu()\n  {\n    final Label totalMenuSuffixLabel = new MenuSuffixLabel(\"totalMenuCounter\", new Model<Integer>() {\n      @Override\n      public Integer getObject()\n      {\n        int counter = 0;\n        if (menu.getMenuEntries() == null) {\n          return counter;\n        }\n        for (final MenuEntry menuEntry : menu.getMenuEntries()) {\n          final IModel<Integer> newCounterModel = menuEntry.getNewCounterModel();\n          if (newCounterModel != null && newCounterModel.getObject() != null) {\n            counter += newCounterModel.getObject();\n          }\n        }\n        return counter;\n      };\n    });\n    add(totalMenuSuffixLabel);\n\n    final RepeatingView completeMenuCategoryRepeater = new RepeatingView(\"completeMenuCategoryRepeater\");\n    add(completeMenuCategoryRepeater);\n    if (menu.getMenuEntries() != null) {\n      for (final MenuEntry menuEntry : menu.getMenuEntries()) {\n        if (menuEntry.getSubMenuEntries() == null) {\n          continue;\n        }\n        // Now we add a new menu area (title with sub menus):\n        final WebMarkupContainer categoryContainer = new WebMarkupContainer(completeMenuCategoryRepeater.newChildId());\n        completeMenuCategoryRepeater.add(categoryContainer);\n        categoryContainer.add(new Label(\"menuCategoryLabel\", getString(menuEntry.getI18nKey())));\n        final Label areaSuffixLabel = getSuffixLabel(menuEntry);\n        categoryContainer.add(areaSuffixLabel);\n\n        // final WebMarkupContainer subMenuContainer = new WebMarkupContainer(\"subMenu\");\n        // categoryContainer.add(subMenuContainer);\n        if (menuEntry.hasSubMenuEntries() == false) {\n          // subMenuContainer.setVisible(false);\n          continue;\n        }\n\n        final RepeatingView completeSubMenuRepeater = new RepeatingView(\"completeSubMenuRepeater\");\n        categoryContainer.add(completeSubMenuRepeater);\n        for (final MenuEntry subMenuEntry : menuEntry.getSubMenuEntries()) {\n          if (subMenuEntry.getSubMenuEntries() != null) {\n            log.error(\"Oups: sub sub menus not supported: \" + menuEntry.getId() + \" has child menus which are ignored.\");\n          }\n          // Now we add the next menu entry to the area:\n          final WebMarkupContainer subMenuItem = new WebMarkupContainer(completeSubMenuRepeater.newChildId());\n          completeSubMenuRepeater.add(subMenuItem);\n          final AbstractLink link = getMenuEntryLink(subMenuEntry, true);\n          if (link != null) {\n            subMenuItem.add(link);\n          } else {\n            subMenuItem.setVisible(false);\n          }\n        }\n      }\n    }\n\n  }\n\n  private void addFavoriteMenu()\n  {\n    // Favorite menu:\n    final RepeatingView menuRepeater = new RepeatingView(\"menuRepeater\");\n    add(menuRepeater);\n    final Collection<MenuEntry> menuEntries = favoritesMenu.getMenuEntries();\n    if (menuEntries != null) {\n      for (final MenuEntry menuEntry : menuEntries) {\n        // Now we add a new menu area (title with sub menus):\n        final WebMarkupContainer menuItem = new WebMarkupContainer(menuRepeater.newChildId());\n        menuRepeater.add(menuItem);\n        final AbstractLink link = getMenuEntryLink(menuEntry, true);\n        if (link == null) {\n          menuItem.setVisible(false);\n          continue;\n        }\n        menuItem.add(link);\n\n        final WebMarkupContainer subMenuContainer = new WebMarkupContainer(\"subMenu\");\n        menuItem.add(subMenuContainer);\n        final WebMarkupContainer caret = new WebMarkupContainer(\"caret\");\n        link.add(caret);\n        if (menuEntry.hasSubMenuEntries() == false) {\n          subMenuContainer.setVisible(false);\n          caret.setVisible(false);\n          continue;\n        }\n        menuItem.add(AttributeModifier.append(\"class\", \"dropdown\"));\n        link.add(AttributeModifier.append(\"class\", \"dropdown-toggle\"));\n        link.add(AttributeModifier.append(\"data-toggle\", \"dropdown\"));\n        final RepeatingView subMenuRepeater = new RepeatingView(\"subMenuRepeater\");\n        subMenuContainer.add(subMenuRepeater);\n        for (final MenuEntry subMenuEntry : menuEntry.getSubMenuEntries()) {\n          // Now we add the next menu entry to the area:\n          if (subMenuEntry.hasSubMenuEntries() == false) {\n            final WebMarkupContainer subMenuItem = new WebMarkupContainer(subMenuRepeater.newChildId());\n            subMenuRepeater.add(subMenuItem);\n            // Subsubmenu entries aren't yet supported, show only the sub entries without children, otherwise only the children are\n            // displayed.\n            final AbstractLink subLink = getMenuEntryLink(subMenuEntry, true);\n            if (subLink == null) {\n              subMenuItem.setVisible(false);\n              continue;\n            }\n            subMenuItem.add(subLink);\n            continue;\n          }\n\n          // final WebMarkupContainer subsubMenuContainer = new WebMarkupContainer(\"subsubMenu\");\n          // subMenuItem.add(subsubMenuContainer);\n          // if (subMenuEntry.hasSubMenuEntries() == false) {\n          // subsubMenuContainer.setVisible(false);\n          // continue;\n          // }\n          // final RepeatingView subsubMenuRepeater = new RepeatingView(\"subsubMenuRepeater\");\n          // subsubMenuContainer.add(subsubMenuRepeater);\n          for (final MenuEntry subsubMenuEntry : subMenuEntry.getSubMenuEntries()) {\n            // Now we add the next menu entry to the sub menu:\n            final WebMarkupContainer subMenuItem = new WebMarkupContainer(subMenuRepeater.newChildId());\n            subMenuRepeater.add(subMenuItem);\n            // Subsubmenu entries aren't yet supported, show only the sub entries without children, otherwise only the children are\n            // displayed.\n            final AbstractLink subLink = getMenuEntryLink(subsubMenuEntry, true);\n            if (subLink == null) {\n              subMenuItem.setVisible(false);\n              continue;\n            }\n            subMenuItem.add(subLink);\n            // final WebMarkupContainer subsubMenuItem = new WebMarkupContainer(subsubMenuRepeater.newChildId());\n            // subsubMenuRepeater.add(subsubMenuItem);\n            // final AbstractLink subsubLink = getMenuEntryLink(subsubMenuEntry, subsubMenuItem);\n            // subsubMenuItem.add(subsubLink);\n          }\n        }\n      }\n    }\n  }\n\n  private void addBookmarkDialog()\n  {\n    final AbstractSecuredPage parentPage = (AbstractSecuredPage) getPage();\n    bookmarkDialog = new BookmarkDialog(parentPage.newModalDialogId());\n    bookmarkDialog.setOutputMarkupId(true);\n    parentPage.add(bookmarkDialog);\n    bookmarkDialog.init();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class BookmarkDialog extends ModalDialog\n  {\n    /**\n     * @param id\n     */\n    public BookmarkDialog(final String id)\n    {\n      super(id);\n    }\n\n    @Override\n    public void init()\n    {\n      setTitle(getString(\"bookmark.title\"));\n      init(new Form<String>(getFormId()));\n      gridBuilder.newFormHeading(\"\"); // Otherwise it's empty and an IllegalArgumentException is thrown.\n    }\n\n    private BookmarkDialog redraw()\n    {\n      clearContent();\n      final AbstractSecuredPage page = (AbstractSecuredPage) NavTopPanel.this.getPage();\n      {\n        final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"bookmark.directPageLink\")).setLabelSide(false);\n        final TextArea<String> textArea = new TextArea<String>(fs.getTextAreaId(), new Model<String>(page.getPageAsLink()));\n        fs.add(textArea);\n        textArea.add(AttributeModifier.replace(\"onClick\", \"$(this).select();\"));\n      }\n      final PageParameters params = page.getBookmarkableInitialParameters();\n      if (params.isEmpty() == false) {\n        final FieldsetPanel fs = gridBuilder.newFieldset(getString(page.getTitleKey4BookmarkableInitialParameters())).setLabelSide(false);\n        final TextArea<String> textArea = new TextArea<String>(fs.getTextAreaId(), new Model<String>(page.getPageAsLink(params)));\n        fs.add(textArea);\n        textArea.add(AttributeModifier.replace(\"onClick\", \"$(this).select();\"));\n      }\n      return this;\n    }\n  }\n}",
    "patch": "@@ -59,6 +59,7 @@\n import org.projectforge.web.user.ChangePasswordPage;\n import org.projectforge.web.user.MyAccountEditPage;\n import org.projectforge.web.wicket.AbstractSecuredPage;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.FeedbackPage;\n import org.projectforge.web.wicket.MySession;\n import org.projectforge.web.wicket.WicketUtils;\n@@ -82,6 +83,11 @@ public class NavTopPanel extends NavAbstractPanel\n \n   private BookmarkDialog bookmarkDialog;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private CsrfTokenHandler csrfTokenHandler;\n+\n   public NavTopPanel(final String id, final UserXmlPreferencesCache userXmlPreferencesCache, final AccessChecker accessChecker)\n   {\n     super(id);\n@@ -117,13 +123,15 @@ public void init(final AbstractSecuredPage page)\n       @Override\n       protected void onSubmit()\n       {\n+        csrfTokenHandler.onSubmit();\n         if (StringUtils.isNotBlank(searchString) == true) {\n           final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n           setResponsePage(searchPage);\n         }\n         super.onSubmit();\n       }\n     };\n+    csrfTokenHandler = new CsrfTokenHandler(searchForm);\n     add(searchForm);\n     final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n     WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));",
    "function_modified_lines": {
      "added": [
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private CsrfTokenHandler csrfTokenHandler;\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11964
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n    getMenu();\n    this.favoritesMenu = FavoritesMenu.get();\n    final WebMarkupContainer goMobile = new WebMarkupContainer(\"goMobile\");\n    add(goMobile);\n    if (page.getMySession().isMobileUserAgent() == true) {\n      goMobile.add(new BookmarkablePageLink<Void>(\"link\", MenuMobilePage.class));\n    } else {\n      goMobile.setVisible(false);\n    }\n    final BookmarkablePageLink<Void> layoutSettingsMenuLink = new BookmarkablePageLink<Void>(\"layoutSettingsMenuLink\",\n        LayoutSettingsPage.class);\n    if (UserRights.getAccessChecker().isRestrictedUser() == true) {\n      // Not visibible for restricted users:\n      layoutSettingsMenuLink.setVisible(false);\n    }\n    add(new MenuConfig(\"menuconfig\", getMenu(), favoritesMenu));\n    @SuppressWarnings(\"serial\")\n    final Form<String> searchForm = new Form<String>(\"searchForm\") {\n      private String searchString;\n\n      /**\n       * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n       */\n      @Override\n      protected void onSubmit()\n      {\n        if (StringUtils.isNotBlank(searchString) == true) {\n          final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n          setResponsePage(searchPage);\n        }\n        super.onSubmit();\n      }\n    };\n    add(searchForm);\n    final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n    WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));\n    searchForm.add(searchField);\n    add(layoutSettingsMenuLink);\n    add(new BookmarkablePageLink<Void>(\"feedbackLink\", FeedbackPage.class));\n    {\n      @SuppressWarnings(\"serial\")\n      final AjaxLink<Void> showBookmarkLink = new AjaxLink<Void>(\"showBookmarkLink\") {\n        /**\n         * @see org.apache.wicket.ajax.markup.html.AjaxLink#onClick(org.apache.wicket.ajax.AjaxRequestTarget)\n         */\n        @Override\n        public void onClick(final AjaxRequestTarget target)\n        {\n          bookmarkDialog.open(target);\n          // Redraw the content:\n          bookmarkDialog.redraw().addContent(target);\n        }\n      };\n      add(showBookmarkLink);\n      addBookmarkDialog();\n    }\n    {\n      add(new Label(\"user\", PFUserContext.getUser().getFullname()));\n      if (accessChecker.isRestrictedUser() == true) {\n        // Show ChangePaswordPage as my account for restricted users.\n        final BookmarkablePageLink<Void> changePasswordLink = new BookmarkablePageLink<Void>(\"myAccountLink\", ChangePasswordPage.class);\n        add(changePasswordLink);\n      } else {\n        final BookmarkablePageLink<Void> myAccountLink = new BookmarkablePageLink<Void>(\"myAccountLink\", MyAccountEditPage.class);\n        add(myAccountLink);\n      }\n      final BookmarkablePageLink<Void> documentationLink = new BookmarkablePageLink<Void>(\"documentationLink\", DocumentationPage.class);\n      add(documentationLink);\n\n      @SuppressWarnings(\"serial\")\n      final Link<String> logoutLink = new Link<String>(\"logoutLink\") {\n        @Override\n        public void onClick()\n        {\n          LoginPage.logout((MySession) getSession(), (WebRequest) getRequest(), (WebResponse) getResponse(), userXmlPreferencesCache);\n          setResponsePage(LoginPage.class);\n        };\n      };\n      add(logoutLink);\n    }\n    addCompleteMenu();\n    addFavoriteMenu();\n  }",
    "code_after_change": "{\n    getMenu();\n    this.favoritesMenu = FavoritesMenu.get();\n    final WebMarkupContainer goMobile = new WebMarkupContainer(\"goMobile\");\n    add(goMobile);\n    if (page.getMySession().isMobileUserAgent() == true) {\n      goMobile.add(new BookmarkablePageLink<Void>(\"link\", MenuMobilePage.class));\n    } else {\n      goMobile.setVisible(false);\n    }\n    final BookmarkablePageLink<Void> layoutSettingsMenuLink = new BookmarkablePageLink<Void>(\"layoutSettingsMenuLink\",\n        LayoutSettingsPage.class);\n    if (UserRights.getAccessChecker().isRestrictedUser() == true) {\n      // Not visibible for restricted users:\n      layoutSettingsMenuLink.setVisible(false);\n    }\n    add(new MenuConfig(\"menuconfig\", getMenu(), favoritesMenu));\n    @SuppressWarnings(\"serial\")\n    final Form<String> searchForm = new Form<String>(\"searchForm\") {\n      private String searchString;\n\n      /**\n       * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n       */\n      @Override\n      protected void onSubmit()\n      {\n        csrfTokenHandler.onSubmit();\n        if (StringUtils.isNotBlank(searchString) == true) {\n          final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n          setResponsePage(searchPage);\n        }\n        super.onSubmit();\n      }\n    };\n    csrfTokenHandler = new CsrfTokenHandler(searchForm);\n    add(searchForm);\n    final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n    WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));\n    searchForm.add(searchField);\n    add(layoutSettingsMenuLink);\n    add(new BookmarkablePageLink<Void>(\"feedbackLink\", FeedbackPage.class));\n    {\n      @SuppressWarnings(\"serial\")\n      final AjaxLink<Void> showBookmarkLink = new AjaxLink<Void>(\"showBookmarkLink\") {\n        /**\n         * @see org.apache.wicket.ajax.markup.html.AjaxLink#onClick(org.apache.wicket.ajax.AjaxRequestTarget)\n         */\n        @Override\n        public void onClick(final AjaxRequestTarget target)\n        {\n          bookmarkDialog.open(target);\n          // Redraw the content:\n          bookmarkDialog.redraw().addContent(target);\n        }\n      };\n      add(showBookmarkLink);\n      addBookmarkDialog();\n    }\n    {\n      add(new Label(\"user\", PFUserContext.getUser().getFullname()));\n      if (accessChecker.isRestrictedUser() == true) {\n        // Show ChangePaswordPage as my account for restricted users.\n        final BookmarkablePageLink<Void> changePasswordLink = new BookmarkablePageLink<Void>(\"myAccountLink\", ChangePasswordPage.class);\n        add(changePasswordLink);\n      } else {\n        final BookmarkablePageLink<Void> myAccountLink = new BookmarkablePageLink<Void>(\"myAccountLink\", MyAccountEditPage.class);\n        add(myAccountLink);\n      }\n      final BookmarkablePageLink<Void> documentationLink = new BookmarkablePageLink<Void>(\"documentationLink\", DocumentationPage.class);\n      add(documentationLink);\n\n      @SuppressWarnings(\"serial\")\n      final Link<String> logoutLink = new Link<String>(\"logoutLink\") {\n        @Override\n        public void onClick()\n        {\n          LoginPage.logout((MySession) getSession(), (WebRequest) getRequest(), (WebResponse) getResponse(), userXmlPreferencesCache);\n          setResponsePage(LoginPage.class);\n        };\n      };\n      add(logoutLink);\n    }\n    addCompleteMenu();\n    addFavoriteMenu();\n  }",
    "patch": "@@ -59,6 +59,7 @@\n import org.projectforge.web.user.ChangePasswordPage;\n import org.projectforge.web.user.MyAccountEditPage;\n import org.projectforge.web.wicket.AbstractSecuredPage;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.FeedbackPage;\n import org.projectforge.web.wicket.MySession;\n import org.projectforge.web.wicket.WicketUtils;\n@@ -82,6 +83,11 @@ public class NavTopPanel extends NavAbstractPanel\n \n   private BookmarkDialog bookmarkDialog;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private CsrfTokenHandler csrfTokenHandler;\n+\n   public NavTopPanel(final String id, final UserXmlPreferencesCache userXmlPreferencesCache, final AccessChecker accessChecker)\n   {\n     super(id);\n@@ -117,13 +123,15 @@ public void init(final AbstractSecuredPage page)\n       @Override\n       protected void onSubmit()\n       {\n+        csrfTokenHandler.onSubmit();\n         if (StringUtils.isNotBlank(searchString) == true) {\n           final SearchPage searchPage = new SearchPage(new PageParameters(), searchString);\n           setResponsePage(searchPage);\n         }\n         super.onSubmit();\n       }\n     };\n+    csrfTokenHandler = new CsrfTokenHandler(searchForm);\n     add(searchForm);\n     final TextField<String> searchField = new TextField<String>(\"searchField\", new PropertyModel<String>(searchForm, \"searchString\"));\n     WicketUtils.setPlaceHolderAttribute(searchField, getString(\"search.search\"));",
    "function_modified_lines": {
      "added": [
        "        csrfTokenHandler.onSubmit();\n",
        "    csrfTokenHandler = new CsrfTokenHandler(searchForm);\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11965
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "@SuppressWarnings(\"serial\")\n  protected void init(final Form< ? > form)\n  {\n    this.form = form;\n    mainSubContainer.add(form);\n    form.add(gridContentContainer);\n    form.add(buttonBarContainer);\n    if (showCancelButton == true) {\n      final SingleButtonPanel cancelButton = appendNewAjaxActionButton(new AjaxCallback() {\n        @Override\n        public void callback(final AjaxRequestTarget target)\n        {\n          onCancelButtonSubmit(target);\n          close(target);\n        }\n      }, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      cancelButton.getButton().setDefaultFormProcessing(false);\n    }\n    closeButtonPanel = appendNewAjaxActionButton(new AjaxFormSubmitCallback() {\n\n      @Override\n      public void callback(final AjaxRequestTarget target)\n      {\n        if (onCloseButtonSubmit(target)) {\n          close(target);\n        }\n      }\n\n      @Override\n      public void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        ModalDialog.this.onError(target, form);\n      }\n    }, closeButtonLabel != null ? closeButtonLabel : getString(\"close\"), SingleButtonPanel.NORMAL);\n    buttonBarContainer.add(actionButtons.getRepeatingView());\n    form.setDefaultButton(closeButtonPanel.getButton());\n    if (autoGenerateGridBuilder == true) {\n      gridBuilder = new GridBuilder(gridContentContainer, \"flowform\");\n    }\n    initFeedback(gridContentContainer);\n  }",
    "code_after_change": "{\n    this.form = form;\n    csrfTokenHandler = new CsrfTokenHandler(form);\n    mainSubContainer.add(form);\n    form.add(gridContentContainer);\n    form.add(buttonBarContainer);\n    if (showCancelButton == true) {\n      final SingleButtonPanel cancelButton = appendNewAjaxActionButton(new AjaxCallback() {\n        @Override\n        public void callback(final AjaxRequestTarget target)\n        {\n          csrfTokenHandler.onSubmit();\n          onCancelButtonSubmit(target);\n          close(target);\n        }\n      }, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      cancelButton.getButton().setDefaultFormProcessing(false);\n    }\n    closeButtonPanel = appendNewAjaxActionButton(new AjaxFormSubmitCallback() {\n\n      @Override\n      public void callback(final AjaxRequestTarget target)\n      {\n        csrfTokenHandler.onSubmit();\n        if (onCloseButtonSubmit(target)) {\n          close(target);\n        }\n      }\n\n      @Override\n      public void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        csrfTokenHandler.onSubmit();\n        ModalDialog.this.onError(target, form);\n      }\n    }, closeButtonLabel != null ? closeButtonLabel : getString(\"close\"), SingleButtonPanel.NORMAL);\n    buttonBarContainer.add(actionButtons.getRepeatingView());\n    form.setDefaultButton(closeButtonPanel.getButton());\n    if (autoGenerateGridBuilder == true) {\n      gridBuilder = new GridBuilder(gridContentContainer, \"flowform\");\n    }\n    initFeedback(gridContentContainer);\n  }",
    "patch": "@@ -39,6 +39,7 @@\n import org.apache.wicket.model.IModel;\n import org.apache.wicket.model.Model;\n import org.projectforge.web.core.NavTopPanel;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WicketUtils;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n import org.projectforge.web.wicket.components.SingleButtonPanel;\n@@ -97,6 +98,11 @@ public abstract class ModalDialog extends Panel\n    */\n   protected MyComponentsRepeater<Component> actionButtons;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  protected CsrfTokenHandler csrfTokenHandler;\n+\n   /**\n    * @param id\n    */\n@@ -231,6 +237,7 @@ public ModalDialog wantsNotificationOnClose()\n       @Override\n       protected void onEvent(final AjaxRequestTarget target)\n       {\n+        csrfTokenHandler.onSubmit();\n         handleCloseEvent(target);\n       }\n     });\n@@ -288,6 +295,7 @@ public ModalDialog open(final AjaxRequestTarget target)\n \n   public void close(final AjaxRequestTarget target)\n   {\n+    csrfTokenHandler.onSubmit();\n     target.appendJavaScript(\"$('#\" + getMainContainerMarkupId() + \"').modal('hide');\");\n   }\n \n@@ -366,6 +374,7 @@ public ModalDialog clearContent()\n   protected void init(final Form< ? > form)\n   {\n     this.form = form;\n+    csrfTokenHandler = new CsrfTokenHandler(form);\n     mainSubContainer.add(form);\n     form.add(gridContentContainer);\n     form.add(buttonBarContainer);\n@@ -374,6 +383,7 @@ protected void init(final Form< ? > form)\n         @Override\n         public void callback(final AjaxRequestTarget target)\n         {\n+          csrfTokenHandler.onSubmit();\n           onCancelButtonSubmit(target);\n           close(target);\n         }\n@@ -385,6 +395,7 @@ public void callback(final AjaxRequestTarget target)\n       @Override\n       public void callback(final AjaxRequestTarget target)\n       {\n+        csrfTokenHandler.onSubmit();\n         if (onCloseButtonSubmit(target)) {\n           close(target);\n         }\n@@ -393,6 +404,7 @@ public void callback(final AjaxRequestTarget target)\n       @Override\n       public void onError(final AjaxRequestTarget target, final Form< ? > form)\n       {\n+        csrfTokenHandler.onSubmit();\n         ModalDialog.this.onError(target, form);\n       }\n     }, closeButtonLabel != null ? closeButtonLabel : getString(\"close\"), SingleButtonPanel.NORMAL);\n@@ -416,6 +428,7 @@ private void initFeedback(final WebMarkupContainer container)\n \n   protected void ajaxError(final String error, final AjaxRequestTarget target)\n   {\n+    csrfTokenHandler.onSubmit();\n     form.error(error);\n     target.add(formFeedback);\n   }\n@@ -427,6 +440,7 @@ protected void ajaxError(final String error, final AjaxRequestTarget target)\n    */\n   protected void handleCloseEvent(final AjaxRequestTarget target)\n   {\n+    csrfTokenHandler.onSubmit();\n   }\n \n   /**\n@@ -505,6 +519,7 @@ private SingleButtonPanel addNewAjaxActionButton(final AjaxCallback ajaxCallback\n       @Override\n       protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n       {\n+        csrfTokenHandler.onSubmit();\n         ajaxCallback.callback(target);\n       }\n ",
    "function_modified_lines": {
      "added": [
        "    csrfTokenHandler = new CsrfTokenHandler(form);\n",
        "          csrfTokenHandler.onSubmit();\n",
        "        csrfTokenHandler.onSubmit();\n",
        "        csrfTokenHandler.onSubmit();\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11967
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.SubmitLink;\nimport org.apache.wicket.markup.html.panel.FeedbackPanel;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.projectforge.core.AbstractBaseDO;\nimport org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n\npublic abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\nAbstractMobileForm<O, P>\n{\n  private static final long serialVersionUID = 1836099012618517190L;\n\n  protected O data;\n\n  protected MobileGridBuilder gridBuilder;\n\n  public AbstractMobileEditForm(final P parentPage, final O data)\n  {\n    super(parentPage);\n    this.data = data;\n  }\n\n  public O getData()\n  {\n    return this.data;\n  }\n\n  public void setData(final O data)\n  {\n    this.data = data;\n  }\n\n  public boolean isNew()\n  {\n    return this.data == null || this.data.getId() == null;\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(new FeedbackPanel(\"feedback\").setOutputMarkupId(true));\n    final SubmitLink submitButton = new SubmitLink(\"submitButton\") {\n      @Override\n      public final void onSubmit()\n      {\n        parentPage.save();\n      }\n    };\n    final RepeatingView flowform = new RepeatingView(\"flowform\");\n    add(flowform);\n    gridBuilder = newGridBuilder(flowform);\n\n    add(submitButton);\n    if (isNew() == true) {\n      submitButton.add(new Label(\"label\", getString(\"create\")));\n    } else {\n      submitButton.add(new Label(\"label\", getString(\"update\")));\n    }\n  }\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.SubmitLink;\nimport org.apache.wicket.markup.html.panel.FeedbackPanel;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.projectforge.core.AbstractBaseDO;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\nimport org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n\npublic abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\nAbstractMobileForm<O, P>\n{\n  private static final long serialVersionUID = 1836099012618517190L;\n\n  protected O data;\n\n  protected MobileGridBuilder gridBuilder;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  public AbstractMobileEditForm(final P parentPage, final O data)\n  {\n    super(parentPage);\n    this.data = data;\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n\n  public O getData()\n  {\n    return this.data;\n  }\n\n  public void setData(final O data)\n  {\n    this.data = data;\n  }\n\n  public boolean isNew()\n  {\n    return this.data == null || this.data.getId() == null;\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(new FeedbackPanel(\"feedback\").setOutputMarkupId(true));\n    final SubmitLink submitButton = new SubmitLink(\"submitButton\") {\n      @Override\n      public final void onSubmit()\n      {\n        parentPage.save();\n      }\n    };\n    final RepeatingView flowform = new RepeatingView(\"flowform\");\n    add(flowform);\n    gridBuilder = newGridBuilder(flowform);\n\n    add(submitButton);\n    if (isNew() == true) {\n      submitButton.add(new Label(\"label\", getString(\"create\")));\n    } else {\n      submitButton.add(new Label(\"label\", getString(\"update\")));\n    }\n  }\n}\n",
    "patch": "@@ -28,6 +28,7 @@\n import org.apache.wicket.markup.html.panel.FeedbackPanel;\n import org.apache.wicket.markup.repeater.RepeatingView;\n import org.projectforge.core.AbstractBaseDO;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n \n public abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\n@@ -39,10 +40,23 @@ public abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P ex\n \n   protected MobileGridBuilder gridBuilder;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   public AbstractMobileEditForm(final P parentPage, final O data)\n   {\n     super(parentPage);\n     this.data = data;\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n+  }\n+\n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n   }\n \n   public O getData()",
    "function_modified_lines": {
      "added": [
        "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "    csrfTokenHandler = new CsrfTokenHandler(this);\n",
        "  }\n",
        "\n",
        "  @Override\n",
        "  protected void onSubmit()\n",
        "  {\n",
        "    super.onSubmit();\n",
        "    csrfTokenHandler.onSubmit();\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11969
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.markup.html.form.TextField;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.core.BaseSearchFilter;\n\npublic abstract class AbstractMobileListForm<F extends BaseSearchFilter, P extends AbstractMobileListPage< ? , ? , ? >> extends\nAbstractMobileForm<AbstractMobileListForm< ? , ? >, AbstractMobileListPage< ? , ? , ? >>\n{\n  private static final long serialVersionUID = -2521426347126048630L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(AbstractMobileListForm.class);\n\n  protected F filter;\n\n  @SuppressWarnings(\"unchecked\")\n  public AbstractMobileListForm(final AbstractMobileListPage< ? , ? , ? > parentPage)\n  {\n    super(parentPage);\n    final String userPrefFilterKey = this.getClass().getSimpleName() + \".filter\";\n    try {\n      filter = (F) parentPage.getUserPrefEntry(userPrefFilterKey);\n    } catch (final ClassCastException ex) {\n      log.info(\"Could not restore filter from user prefs (OK, probably new software release): \" + userPrefFilterKey);\n    }\n    if (filter == null) {\n      filter = newFilter();\n      parentPage.putUserPrefEntry(userPrefFilterKey, filter, true);\n    }\n  }\n\n  protected void init()\n  {\n    add(new TextField<String>(\"searchField\", new PropertyModel<String>(filter, \"searchString\")).add(AttributeModifier.replace(\n        \"placeholder\", getString(\"search\"))));\n  }\n\n  protected abstract F newFilter();\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.markup.html.form.TextField;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.core.BaseSearchFilter;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\n\npublic abstract class AbstractMobileListForm<F extends BaseSearchFilter, P extends AbstractMobileListPage< ? , ? , ? >> extends\nAbstractMobileForm<AbstractMobileListForm< ? , ? >, AbstractMobileListPage< ? , ? , ? >>\n{\n  private static final long serialVersionUID = -2521426347126048630L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(AbstractMobileListForm.class);\n\n  protected F filter;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  @SuppressWarnings(\"unchecked\")\n  public AbstractMobileListForm(final AbstractMobileListPage< ? , ? , ? > parentPage)\n  {\n    super(parentPage);\n    final String userPrefFilterKey = this.getClass().getSimpleName() + \".filter\";\n    try {\n      filter = (F) parentPage.getUserPrefEntry(userPrefFilterKey);\n    } catch (final ClassCastException ex) {\n      log.info(\"Could not restore filter from user prefs (OK, probably new software release): \" + userPrefFilterKey);\n    }\n    if (filter == null) {\n      filter = newFilter();\n      parentPage.putUserPrefEntry(userPrefFilterKey, filter, true);\n    }\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n\n  protected void init()\n  {\n    add(new TextField<String>(\"searchField\", new PropertyModel<String>(filter, \"searchString\")).add(AttributeModifier.replace(\n        \"placeholder\", getString(\"search\"))));\n  }\n\n  protected abstract F newFilter();\n}\n",
    "patch": "@@ -27,6 +27,7 @@\n import org.apache.wicket.markup.html.form.TextField;\n import org.apache.wicket.model.PropertyModel;\n import org.projectforge.core.BaseSearchFilter;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n \n public abstract class AbstractMobileListForm<F extends BaseSearchFilter, P extends AbstractMobileListPage< ? , ? , ? >> extends\n AbstractMobileForm<AbstractMobileListForm< ? , ? >, AbstractMobileListPage< ? , ? , ? >>\n@@ -37,6 +38,11 @@ public abstract class AbstractMobileListForm<F extends BaseSearchFilter, P exten\n \n   protected F filter;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   @SuppressWarnings(\"unchecked\")\n   public AbstractMobileListForm(final AbstractMobileListPage< ? , ? , ? > parentPage)\n   {\n@@ -51,6 +57,14 @@ public AbstractMobileListForm(final AbstractMobileListPage< ? , ? , ? > parentPa\n       filter = newFilter();\n       parentPage.putUserPrefEntry(userPrefFilterKey, filter, true);\n     }\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n+  }\n+\n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n   }\n \n   protected void init()",
    "function_modified_lines": {
      "added": [
        "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "    csrfTokenHandler = new CsrfTokenHandler(this);\n",
        "  }\n",
        "\n",
        "  @Override\n",
        "  protected void onSubmit()\n",
        "  {\n",
        "    super.onSubmit();\n",
        "    csrfTokenHandler.onSubmit();\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11970
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n  private static final long serialVersionUID = -203572415793301622L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(TaskTreeForm.class);\n\n  private TaskFilter searchFilter;\n\n  private MyComponentsRepeater<Component> actionButtons;\n\n  private SingleButtonPanel cancelButtonPanel;\n\n  private SingleButtonPanel resetButtonPanel;\n\n  private SingleButtonPanel listViewButtonPanel;\n\n  private SingleButtonPanel searchButtonPanel;\n\n  protected GridBuilder gridBuilder;\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    super.init();\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"searchFilter\"));\n      final TextField<String> searchField = new TextField<String>(InputPanel.WICKET_ID, new PropertyModel<String>(getSearchFilter(),\n          \"searchString\"));\n      searchField.add(WicketUtils.setFocus());\n      fs.add(new InputPanel(fs.newChildId(), searchField));\n      fs.add(new IconPanel(fs.newIconChildId(), IconType.HELP, getString(\"tooltip.lucene.link\")).setOnClickLocation(getRequestCycle(),\n          WebConstants.DOC_LINK_HANDBUCH_LUCENE, true), FieldSetIconPosition.TOP_RIGHT);\n    }\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"label.options\")).suppressLabelForWarning();\n      final DivPanel checkBoxPanel = fs.addNewCheckBoxDiv();\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"notOpened\"),\n          getString(\"task.status.notOpened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"opened\"),\n          getString(\"task.status.opened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"closed\"),\n          getString(\"task.status.closed\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"deleted\"),\n          getString(\"deleted\")));\n    }\n\n    actionButtons = new MyComponentsRepeater<Component>(\"actionButtons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button cancelButton = new Button(\"button\", new Model<String>(\"cancel\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onCancelSubmit();\n        }\n      };\n      cancelButton.setDefaultFormProcessing(false);\n      cancelButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), cancelButton, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      actionButtons.add(cancelButtonPanel);\n    }\n    {\n      final Button resetButton = new Button(\"button\", new Model<String>(\"reset\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onResetSubmit();\n        }\n      };\n      resetButton.setDefaultFormProcessing(false);\n      resetButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), resetButton, getString(\"reset\"), SingleButtonPanel.RESET);\n      actionButtons.add(resetButtonPanel);\n    }\n    {\n      final Button listViewButton = new Button(\"button\", new Model<String>(\"listView\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onListViewSubmit();\n        }\n      };\n\n      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"), SingleButtonPanel.NORMAL);\n      actionButtons.add(listViewButtonPanel);\n    }\n    {\n      final Button searchButton = new Button(\"button\", new Model<String>(\"search\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onSearchSubmit();\n        }\n      };\n      searchButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), searchButton, getString(\"search\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(searchButtonPanel);\n      setDefaultButton(searchButton);\n    }\n    setComponentsVisibility();\n  }\n\n  public TaskTreeForm(final TaskTreePage parentPage)\n  {\n    super(parentPage);\n  }\n\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n\n  protected void setComponentsVisibility()\n  {\n    if (parentPage.isSelectMode() == false) {\n      // Show cancel button only in select mode.\n      cancelButtonPanel.setVisible(false);\n    }\n    searchButtonPanel.setVisible(true);\n    resetButtonPanel.setVisible(true);\n  }\n\n  public TaskFilter getSearchFilter()\n  {\n    if (this.searchFilter == null) {\n      final Object filter = getParentPage().getUserPrefEntry(TaskListForm.class.getName() + \":Filter\");\n      if (filter != null) {\n        try {\n          this.searchFilter = (TaskFilter) filter;\n        } catch (final ClassCastException ex) {\n          // Probably a new software release results in an incompability of old and new filter format.\n          log.info(\"Could not restore filter from user prefs: (old) filter type \"\n              + filter.getClass().getName()\n              + \" is not assignable to (new) filter type TaskFilter (OK, probably new software release).\");\n        }\n      }\n    }\n    if (this.searchFilter == null) {\n      this.searchFilter = new TaskFilter();\n      getParentPage().putUserPrefEntry(TaskListForm.class.getName() + \":Filter\", this.searchFilter, true);\n    }\n    return this.searchFilter;\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    parentPage.refresh();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class MyCheckBoxPanel extends CheckBoxPanel\n  {\n    public MyCheckBoxPanel(final String id, final IModel<Boolean> model, final String labelString)\n    {\n      super(id, model, labelString);\n    }\n\n    @Override\n    protected boolean wantOnSelectionChangedNotifications()\n    {\n      return true;\n    }\n\n    @Override\n    protected void onSelectionChanged(final Boolean newSelection)\n    {\n      parentPage.refresh();\n    }\n  }\n}",
    "code_after_change": "{\n  private static final long serialVersionUID = -203572415793301622L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(TaskTreeForm.class);\n\n  private TaskFilter searchFilter;\n\n  private MyComponentsRepeater<Component> actionButtons;\n\n  private SingleButtonPanel cancelButtonPanel;\n\n  private SingleButtonPanel resetButtonPanel;\n\n  private SingleButtonPanel listViewButtonPanel;\n\n  private SingleButtonPanel searchButtonPanel;\n\n  protected GridBuilder gridBuilder;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    super.init();\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"searchFilter\"));\n      final TextField<String> searchField = new TextField<String>(InputPanel.WICKET_ID, new PropertyModel<String>(getSearchFilter(),\n          \"searchString\"));\n      searchField.add(WicketUtils.setFocus());\n      fs.add(new InputPanel(fs.newChildId(), searchField));\n      fs.add(new IconPanel(fs.newIconChildId(), IconType.HELP, getString(\"tooltip.lucene.link\")).setOnClickLocation(getRequestCycle(),\n          WebConstants.DOC_LINK_HANDBUCH_LUCENE, true), FieldSetIconPosition.TOP_RIGHT);\n    }\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"label.options\")).suppressLabelForWarning();\n      final DivPanel checkBoxPanel = fs.addNewCheckBoxDiv();\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"notOpened\"),\n          getString(\"task.status.notOpened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"opened\"),\n          getString(\"task.status.opened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"closed\"),\n          getString(\"task.status.closed\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"deleted\"),\n          getString(\"deleted\")));\n    }\n\n    actionButtons = new MyComponentsRepeater<Component>(\"actionButtons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button cancelButton = new Button(\"button\", new Model<String>(\"cancel\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onCancelSubmit();\n        }\n      };\n      cancelButton.setDefaultFormProcessing(false);\n      cancelButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), cancelButton, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      actionButtons.add(cancelButtonPanel);\n    }\n    {\n      final Button resetButton = new Button(\"button\", new Model<String>(\"reset\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onResetSubmit();\n        }\n      };\n      resetButton.setDefaultFormProcessing(false);\n      resetButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), resetButton, getString(\"reset\"), SingleButtonPanel.RESET);\n      actionButtons.add(resetButtonPanel);\n    }\n    {\n      final Button listViewButton = new Button(\"button\", new Model<String>(\"listView\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onListViewSubmit();\n        }\n      };\n\n      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"),\n          SingleButtonPanel.NORMAL);\n      actionButtons.add(listViewButtonPanel);\n    }\n    {\n      final Button searchButton = new Button(\"button\", new Model<String>(\"search\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onSearchSubmit();\n        }\n      };\n      searchButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), searchButton, getString(\"search\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(searchButtonPanel);\n      setDefaultButton(searchButton);\n    }\n    setComponentsVisibility();\n  }\n\n  public TaskTreeForm(final TaskTreePage parentPage)\n  {\n    super(parentPage);\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n\n  protected void setComponentsVisibility()\n  {\n    if (parentPage.isSelectMode() == false) {\n      // Show cancel button only in select mode.\n      cancelButtonPanel.setVisible(false);\n    }\n    searchButtonPanel.setVisible(true);\n    resetButtonPanel.setVisible(true);\n  }\n\n  public TaskFilter getSearchFilter()\n  {\n    if (this.searchFilter == null) {\n      final Object filter = getParentPage().getUserPrefEntry(TaskListForm.class.getName() + \":Filter\");\n      if (filter != null) {\n        try {\n          this.searchFilter = (TaskFilter) filter;\n        } catch (final ClassCastException ex) {\n          // Probably a new software release results in an incompability of old and new filter format.\n          log.info(\"Could not restore filter from user prefs: (old) filter type \"\n              + filter.getClass().getName()\n              + \" is not assignable to (new) filter type TaskFilter (OK, probably new software release).\");\n        }\n      }\n    }\n    if (this.searchFilter == null) {\n      this.searchFilter = new TaskFilter();\n      getParentPage().putUserPrefEntry(TaskListForm.class.getName() + \":Filter\", this.searchFilter, true);\n    }\n    return this.searchFilter;\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n    parentPage.refresh();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class MyCheckBoxPanel extends CheckBoxPanel\n  {\n    public MyCheckBoxPanel(final String id, final IModel<Boolean> model, final String labelString)\n    {\n      super(id, model, labelString);\n    }\n\n    @Override\n    protected boolean wantOnSelectionChangedNotifications()\n    {\n      return true;\n    }\n\n    @Override\n    protected void onSelectionChanged(final Boolean newSelection)\n    {\n      parentPage.refresh();\n    }\n  }\n}",
    "patch": "@@ -31,6 +31,7 @@\n import org.apache.wicket.model.PropertyModel;\n import org.projectforge.task.TaskFilter;\n import org.projectforge.web.wicket.AbstractForm;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WebConstants;\n import org.projectforge.web.wicket.WicketUtils;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n@@ -65,6 +66,11 @@ public class TaskTreeForm extends AbstractForm<TaskFilter, TaskTreePage>\n \n   protected GridBuilder gridBuilder;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   @Override\n   @SuppressWarnings(\"serial\")\n   protected void init()\n@@ -131,7 +137,8 @@ public final void onSubmit()\n         }\n       };\n \n-      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"), SingleButtonPanel.NORMAL);\n+      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"),\n+          SingleButtonPanel.NORMAL);\n       actionButtons.add(listViewButtonPanel);\n     }\n     {\n@@ -153,6 +160,7 @@ public final void onSubmit()\n   public TaskTreeForm(final TaskTreePage parentPage)\n   {\n     super(parentPage);\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n   }\n \n   @Override\n@@ -198,6 +206,7 @@ public TaskFilter getSearchFilter()\n   protected void onSubmit()\n   {\n     super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n     parentPage.refresh();\n   }\n ",
    "function_modified_lines": {
      "added": [
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private final CsrfTokenHandler csrfTokenHandler;\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11971
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket;\n\nimport java.io.Serializable;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.Session;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.HiddenField;\nimport org.apache.wicket.model.Model;\nimport org.projectforge.core.InternalErrorException;\n\n/**\n * Every form should use this handler for preventing cross site request forgery attacks.\n * @author Kai Reinhard (k.reinhard@micromata.de)\n * \n */\npublic class CsrfTokenHandler implements Serializable\n{\n  private static final long serialVersionUID = -9129345307409567900L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n\n  private HiddenField<String> csrfTokenField;\n\n  /**\n   * The given form should contain a hidden field named 'csrfToken'.\n   * @param form\n   */\n  public CsrfTokenHandler(final Form< ? > form)\n  {\n    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n  }\n\n  /**\n   * This parameter should be set as hidden field in every formular and should be tested on every submit action for preventing CSRF attacks.\n   * @return the randomized cross site request forgery token.\n   */\n  private String getCsrfSessionToken()\n  {\n    final MySession session = (MySession) Session.get();\n    return session.getCsrfToken();\n  }\n\n  /**\n   * Checks the cross site request forgery token (as posted hidden field) and if it doesn't match an exception is thrown.\n   * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n   */\n  public void onSubmit()\n  {\n    final String sessionCsrfToken = getCsrfSessionToken();\n    final String postedCsrfToken = this.csrfTokenField.getInput();\n    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + postedCsrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket;\n\nimport java.io.Serializable;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.Session;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.HiddenField;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.core.InternalErrorException;\n\n/**\n * Every form should use this handler for preventing cross site request forgery attacks.\n * @author Kai Reinhard (k.reinhard@micromata.de)\n * \n */\npublic class CsrfTokenHandler implements Serializable\n{\n  private static final long serialVersionUID = -9129345307409567900L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n\n  private final String csrfToken;\n\n  /**\n   * The given form should contain a hidden field named 'csrfToken'.\n   * @param form\n   */\n  public CsrfTokenHandler(final Form< ? > form)\n  {\n    csrfToken = getCsrfSessionToken();\n    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n  }\n\n  /**\n   * This parameter should be set as hidden field in every formular and should be tested on every submit action for preventing CSRF attacks.\n   * @return the randomized cross site request forgery token.\n   */\n  private String getCsrfSessionToken()\n  {\n    final MySession session = (MySession) Session.get();\n    return session.getCsrfToken();\n  }\n\n  /**\n   * Checks the cross site request forgery token (as posted hidden field) and if it doesn't match an exception is thrown.\n   * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n   */\n  public void onSubmit()\n  {\n    final String sessionCsrfToken = getCsrfSessionToken();\n    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + csrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }\n}\n",
    "patch": "@@ -29,7 +29,7 @@\n import org.apache.wicket.Session;\n import org.apache.wicket.markup.html.form.Form;\n import org.apache.wicket.markup.html.form.HiddenField;\n-import org.apache.wicket.model.Model;\n+import org.apache.wicket.model.PropertyModel;\n import org.projectforge.core.InternalErrorException;\n \n /**\n@@ -43,15 +43,16 @@ public class CsrfTokenHandler implements Serializable\n \n   private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n \n-  private HiddenField<String> csrfTokenField;\n+  private final String csrfToken;\n \n   /**\n    * The given form should contain a hidden field named 'csrfToken'.\n    * @param form\n    */\n   public CsrfTokenHandler(final Form< ? > form)\n   {\n-    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n+    csrfToken = getCsrfSessionToken();\n+    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n   }\n \n   /**\n@@ -71,12 +72,11 @@ private String getCsrfSessionToken()\n   public void onSubmit()\n   {\n     final String sessionCsrfToken = getCsrfSessionToken();\n-    final String postedCsrfToken = this.csrfTokenField.getInput();\n-    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n+    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n       log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n           + sessionCsrfToken\n           + \", posted csrf token=\"\n-          + postedCsrfToken);\n+          + csrfToken);\n       throw new InternalErrorException(\"errorpage.csrfError\");\n     }\n   }",
    "function_modified_lines": {
      "added": [
        "import org.apache.wicket.model.PropertyModel;\n",
        "  private final String csrfToken;\n",
        "    csrfToken = getCsrfSessionToken();\n",
        "    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n"
      ],
      "deleted": [
        "import org.apache.wicket.model.Model;\n",
        "  private HiddenField<String> csrfTokenField;\n",
        "    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11972
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n    final String sessionCsrfToken = getCsrfSessionToken();\n    final String postedCsrfToken = this.csrfTokenField.getInput();\n    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + postedCsrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }",
    "code_after_change": "{\n    final String sessionCsrfToken = getCsrfSessionToken();\n    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + csrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }",
    "patch": "@@ -29,7 +29,7 @@\n import org.apache.wicket.Session;\n import org.apache.wicket.markup.html.form.Form;\n import org.apache.wicket.markup.html.form.HiddenField;\n-import org.apache.wicket.model.Model;\n+import org.apache.wicket.model.PropertyModel;\n import org.projectforge.core.InternalErrorException;\n \n /**\n@@ -43,15 +43,16 @@ public class CsrfTokenHandler implements Serializable\n \n   private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n \n-  private HiddenField<String> csrfTokenField;\n+  private final String csrfToken;\n \n   /**\n    * The given form should contain a hidden field named 'csrfToken'.\n    * @param form\n    */\n   public CsrfTokenHandler(final Form< ? > form)\n   {\n-    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n+    csrfToken = getCsrfSessionToken();\n+    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n   }\n \n   /**\n@@ -71,12 +72,11 @@ private String getCsrfSessionToken()\n   public void onSubmit()\n   {\n     final String sessionCsrfToken = getCsrfSessionToken();\n-    final String postedCsrfToken = this.csrfTokenField.getInput();\n-    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n+    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n       log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n           + sessionCsrfToken\n           + \", posted csrf token=\"\n-          + postedCsrfToken);\n+          + csrfToken);\n       throw new InternalErrorException(\"errorpage.csrfError\");\n     }\n   }",
    "function_modified_lines": {
      "added": [
        "    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n",
        "          + csrfToken);\n"
      ],
      "deleted": [
        "    final String postedCsrfToken = this.csrfTokenField.getInput();\n",
        "    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n",
        "          + postedCsrfToken);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11973
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket.components;\n\nimport java.io.Serializable;\n\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.ajax.AjaxRequestTarget;\nimport org.apache.wicket.ajax.markup.html.form.AjaxSubmitLink;\nimport org.apache.wicket.markup.html.WebMarkupContainer;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.TextArea;\nimport org.apache.wicket.markup.html.panel.Panel;\nimport org.apache.wicket.model.CompoundPropertyModel;\nimport org.projectforge.web.wicket.WicketUtils;\n\n/**\n * The panel which includes the drop behavior for several files. If the dropped file (string) was sucessfully importet, the hook method\n * {@link #onStringImport(AjaxRequestTarget, String, String)} is called.\n * \n * @author Johannes Unterstein (j.unterstein@micromata.de)\n * \n */\npublic abstract class DropFileContainer extends Panel\n{\n  private static final long serialVersionUID = 3622467918922963503L;\n\n  private final WebMarkupContainer main;\n  private final String mimeType;\n\n  /**\n   * @param id\n   */\n  public DropFileContainer(final String id)\n  {\n    this(id, null);\n  }\n\n  public DropFileContainer(final String id, final String mimeType) {\n    super(id);\n    this.mimeType = mimeType;\n    main = new WebMarkupContainer(\"main\");\n    add(main);\n  }\n\n  /**\n   * @see org.apache.wicket.Component#onInitialize()\n   */\n  @Override\n  protected void onInitialize()\n  {\n    super.onInitialize();\n    final Form<FormBean> hiddenForm = new Form<FormBean>(\"hiddenForm\", new CompoundPropertyModel<FormBean>(new FormBean()));\n    hiddenForm.add(AttributeModifier.replace(\"data-mimetype\", mimeType));\n    main.add(hiddenForm);\n    hiddenForm.add(new TextArea<String>(\"importString\"));\n    hiddenForm.add(new TextArea<String>(\"importFileName\"));\n    hiddenForm.add(new AjaxSubmitLink(\"submitButton\") {\n      private static final long serialVersionUID = 6140567784494429257L;\n\n      @Override\n      protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        final FormBean modelObject = hiddenForm.getModel().getObject();\n        onStringImport(target, modelObject.importFileName, modelObject.importString);\n      }\n\n      @Override\n      protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        // nothing to do here\n      }\n\n    });\n  }\n\n  /**\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String content)\n  {\n    WicketUtils.addTooltip(main, content);\n    return this;\n  }\n\n  /**\n   * @param title\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String title, final String content)\n  {\n    WicketUtils.addTooltip(main, title, content);\n    return this;\n  }\n\n  protected abstract void onStringImport(final AjaxRequestTarget target, final String filename, final String content);\n\n  /**\n   * Just the form model\n   * \n   */\n  private class FormBean implements Serializable\n  {\n    private static final long serialVersionUID = 4250094235574838882L;\n\n    private String importString;\n\n    private String importFileName;\n  }\n}\n",
    "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket.components;\n\nimport java.io.Serializable;\n\nimport org.apache.wicket.AttributeModifier;\nimport org.apache.wicket.ajax.AjaxRequestTarget;\nimport org.apache.wicket.ajax.markup.html.form.AjaxSubmitLink;\nimport org.apache.wicket.markup.html.WebMarkupContainer;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.TextArea;\nimport org.apache.wicket.markup.html.panel.Panel;\nimport org.apache.wicket.model.CompoundPropertyModel;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\nimport org.projectforge.web.wicket.WicketUtils;\n\n/**\n * The panel which includes the drop behavior for several files. If the dropped file (string) was sucessfully importet, the hook method\n * {@link #onStringImport(AjaxRequestTarget, String, String)} is called.\n * \n * @author Johannes Unterstein (j.unterstein@micromata.de)\n * \n */\npublic abstract class DropFileContainer extends Panel\n{\n  private static final long serialVersionUID = 3622467918922963503L;\n\n  private final WebMarkupContainer main;\n\n  private final String mimeType;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private  CsrfTokenHandler csrfTokenHandler;\n\n  /**\n   * @param id\n   */\n  public DropFileContainer(final String id)\n  {\n    this(id, null);\n  }\n\n  public DropFileContainer(final String id, final String mimeType)\n  {\n    super(id);\n    this.mimeType = mimeType;\n    main = new WebMarkupContainer(\"main\");\n    add(main);\n  }\n\n  /**\n   * @see org.apache.wicket.Component#onInitialize()\n   */\n  @Override\n  protected void onInitialize()\n  {\n    super.onInitialize();\n    final Form<FormBean> hiddenForm = new Form<FormBean>(\"hiddenForm\", new CompoundPropertyModel<FormBean>(new FormBean()));\n    hiddenForm.add(AttributeModifier.replace(\"data-mimetype\", mimeType));\n    main.add(hiddenForm);\n    hiddenForm.add(new TextArea<String>(\"importString\"));\n    hiddenForm.add(new TextArea<String>(\"importFileName\"));\n    hiddenForm.add(new AjaxSubmitLink(\"submitButton\") {\n      private static final long serialVersionUID = 6140567784494429257L;\n\n      @Override\n      protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        csrfTokenHandler.onSubmit();\n        final FormBean modelObject = hiddenForm.getModel().getObject();\n        onStringImport(target, modelObject.importFileName, modelObject.importString);\n      }\n\n      @Override\n      protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        // nothing to do here\n      }\n\n    });\n    csrfTokenHandler = new CsrfTokenHandler(hiddenForm);\n  }\n\n  /**\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String content)\n  {\n    WicketUtils.addTooltip(main, content);\n    return this;\n  }\n\n  /**\n   * @param title\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String title, final String content)\n  {\n    WicketUtils.addTooltip(main, title, content);\n    return this;\n  }\n\n  protected abstract void onStringImport(final AjaxRequestTarget target, final String filename, final String content);\n\n  /**\n   * Just the form model\n   * \n   */\n  private class FormBean implements Serializable\n  {\n    private static final long serialVersionUID = 4250094235574838882L;\n\n    private String importString;\n\n    private String importFileName;\n  }\n}\n",
    "patch": "@@ -33,6 +33,7 @@\n import org.apache.wicket.markup.html.form.TextArea;\n import org.apache.wicket.markup.html.panel.Panel;\n import org.apache.wicket.model.CompoundPropertyModel;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WicketUtils;\n \n /**\n@@ -47,8 +48,14 @@ public abstract class DropFileContainer extends Panel\n   private static final long serialVersionUID = 3622467918922963503L;\n \n   private final WebMarkupContainer main;\n+\n   private final String mimeType;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private  CsrfTokenHandler csrfTokenHandler;\n+\n   /**\n    * @param id\n    */\n@@ -57,7 +64,8 @@ public DropFileContainer(final String id)\n     this(id, null);\n   }\n \n-  public DropFileContainer(final String id, final String mimeType) {\n+  public DropFileContainer(final String id, final String mimeType)\n+  {\n     super(id);\n     this.mimeType = mimeType;\n     main = new WebMarkupContainer(\"main\");\n@@ -82,6 +90,7 @@ protected void onInitialize()\n       @Override\n       protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n       {\n+        csrfTokenHandler.onSubmit();\n         final FormBean modelObject = hiddenForm.getModel().getObject();\n         onStringImport(target, modelObject.importFileName, modelObject.importString);\n       }\n@@ -93,6 +102,7 @@ protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n       }\n \n     });\n+    csrfTokenHandler = new CsrfTokenHandler(hiddenForm);\n   }\n \n   /**",
    "function_modified_lines": {
      "added": [
        "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
        "\n",
        "  /**\n",
        "   * Cross site request forgery token.\n",
        "   */\n",
        "  private  CsrfTokenHandler csrfTokenHandler;\n",
        "\n",
        "  public DropFileContainer(final String id, final String mimeType)\n",
        "  {\n"
      ],
      "deleted": [
        "  public DropFileContainer(final String id, final String mimeType) {\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11974
  },
  {
    "cve_id": "CVE-2013-7251",
    "code_before_change": "{\n  private static final long serialVersionUID = 3622467918922963503L;\n\n  private final WebMarkupContainer main;\n  private final String mimeType;\n\n  /**\n   * @param id\n   */\n  public DropFileContainer(final String id)\n  {\n    this(id, null);\n  }\n\n  public DropFileContainer(final String id, final String mimeType) {\n    super(id);\n    this.mimeType = mimeType;\n    main = new WebMarkupContainer(\"main\");\n    add(main);\n  }\n\n  /**\n   * @see org.apache.wicket.Component#onInitialize()\n   */\n  @Override\n  protected void onInitialize()\n  {\n    super.onInitialize();\n    final Form<FormBean> hiddenForm = new Form<FormBean>(\"hiddenForm\", new CompoundPropertyModel<FormBean>(new FormBean()));\n    hiddenForm.add(AttributeModifier.replace(\"data-mimetype\", mimeType));\n    main.add(hiddenForm);\n    hiddenForm.add(new TextArea<String>(\"importString\"));\n    hiddenForm.add(new TextArea<String>(\"importFileName\"));\n    hiddenForm.add(new AjaxSubmitLink(\"submitButton\") {\n      private static final long serialVersionUID = 6140567784494429257L;\n\n      @Override\n      protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        final FormBean modelObject = hiddenForm.getModel().getObject();\n        onStringImport(target, modelObject.importFileName, modelObject.importString);\n      }\n\n      @Override\n      protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        // nothing to do here\n      }\n\n    });\n  }\n\n  /**\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String content)\n  {\n    WicketUtils.addTooltip(main, content);\n    return this;\n  }\n\n  /**\n   * @param title\n   * @param content\n   * @return this for chaining.\n   */\n  public DropFileContainer setTooltip(final String title, final String content)\n  {\n    WicketUtils.addTooltip(main, title, content);\n    return this;\n  }\n\n  protected abstract void onStringImport(final AjaxRequestTarget target, final String filename, final String content);\n\n  /**\n   * Just the form model\n   * \n   */\n  private class FormBean implements Serializable\n  {\n    private static final long serialVersionUID = 4250094235574838882L;\n\n    private String importString;\n\n    private String importFileName;\n  }\n}",
    "code_after_change": "{\n    super.onInitialize();\n    final Form<FormBean> hiddenForm = new Form<FormBean>(\"hiddenForm\", new CompoundPropertyModel<FormBean>(new FormBean()));\n    hiddenForm.add(AttributeModifier.replace(\"data-mimetype\", mimeType));\n    main.add(hiddenForm);\n    hiddenForm.add(new TextArea<String>(\"importString\"));\n    hiddenForm.add(new TextArea<String>(\"importFileName\"));\n    hiddenForm.add(new AjaxSubmitLink(\"submitButton\") {\n      private static final long serialVersionUID = 6140567784494429257L;\n\n      @Override\n      protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        csrfTokenHandler.onSubmit();\n        final FormBean modelObject = hiddenForm.getModel().getObject();\n        onStringImport(target, modelObject.importFileName, modelObject.importString);\n      }\n\n      @Override\n      protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n      {\n        // nothing to do here\n      }\n\n    });\n    csrfTokenHandler = new CsrfTokenHandler(hiddenForm);\n  }",
    "patch": "@@ -33,6 +33,7 @@\n import org.apache.wicket.markup.html.form.TextArea;\n import org.apache.wicket.markup.html.panel.Panel;\n import org.apache.wicket.model.CompoundPropertyModel;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WicketUtils;\n \n /**\n@@ -47,8 +48,14 @@ public abstract class DropFileContainer extends Panel\n   private static final long serialVersionUID = 3622467918922963503L;\n \n   private final WebMarkupContainer main;\n+\n   private final String mimeType;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private  CsrfTokenHandler csrfTokenHandler;\n+\n   /**\n    * @param id\n    */\n@@ -57,7 +64,8 @@ public DropFileContainer(final String id)\n     this(id, null);\n   }\n \n-  public DropFileContainer(final String id, final String mimeType) {\n+  public DropFileContainer(final String id, final String mimeType)\n+  {\n     super(id);\n     this.mimeType = mimeType;\n     main = new WebMarkupContainer(\"main\");\n@@ -82,6 +90,7 @@ protected void onInitialize()\n       @Override\n       protected void onSubmit(final AjaxRequestTarget target, final Form< ? > form)\n       {\n+        csrfTokenHandler.onSubmit();\n         final FormBean modelObject = hiddenForm.getModel().getObject();\n         onStringImport(target, modelObject.importFileName, modelObject.importString);\n       }\n@@ -93,6 +102,7 @@ protected void onError(final AjaxRequestTarget target, final Form< ? > form)\n       }\n \n     });\n+    csrfTokenHandler = new CsrfTokenHandler(hiddenForm);\n   }\n \n   /**",
    "function_modified_lines": {
      "added": [
        "        csrfTokenHandler.onSubmit();\n",
        "    csrfTokenHandler = new CsrfTokenHandler(hiddenForm);\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
    "id": 11975
  },
  {
    "cve_id": "CVE-2021-25930",
    "code_before_change": "if (data == null) {\n                    m_users.remove(oldName);\n                    throw new Exception(\"UserFactory:rename the data contained for old user \" + oldName + \" is null\");\n                } else {\n                    // Rename the user in the user map.\n                    m_users.remove(oldName);\n                    data.setUserId(newName);\n                    m_users.put(newName, data);\n        \n                    // Refresh the groups config first\n                    m_groupManager.update();\n                    \n                    // Rename the user in the group.\n                    m_groupManager.renameUser(oldName, newName);\n        \n                    // Rename the user in the view.\n                    // viewFactory.renameUser(oldName, newName);\n                }",
    "code_after_change": "{\n                    if (m_users.containsKey(newName)) {\n                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n                    }\n\n                    // Rename the user in the user map.\n                    m_users.remove(oldName);\n                    data.setUserId(newName);\n                    m_users.put(newName, data);\n        \n                    // Refresh the groups config first\n                    m_groupManager.update();\n                    \n                    // Rename the user in the group.\n                    m_groupManager.renameUser(oldName, newName);\n        \n                    // Rename the user in the view.\n                    // viewFactory.renameUser(oldName, newName);\n                }",
    "patch": "@@ -995,6 +995,10 @@ public void renameUser(final String oldName, final String newName) throws Except\n                     m_users.remove(oldName);\n                     throw new Exception(\"UserFactory:rename the data contained for old user \" + oldName + \" is null\");\n                 } else {\n+                    if (m_users.containsKey(newName)) {\n+                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n+                    }\n+\n                     // Rename the user in the user map.\n                     m_users.remove(oldName);\n                     data.setUserId(newName);",
    "function_modified_lines": {
      "added": [
        "                    if (m_users.containsKey(newName)) {\n",
        "                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n",
        "                    }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection, and since there is no validation of an existing user name while renaming a user. As a result, privileges of the renamed user are being overwritten by the old user and the old user is being deleted from the user list.",
    "id": 12040
  },
  {
    "cve_id": "CVE-2021-25931",
    "code_before_change": "if (data == null) {\n                    m_users.remove(oldName);\n                    throw new Exception(\"UserFactory:rename the data contained for old user \" + oldName + \" is null\");\n                } else {\n                    // Rename the user in the user map.\n                    m_users.remove(oldName);\n                    data.setUserId(newName);\n                    m_users.put(newName, data);\n        \n                    // Refresh the groups config first\n                    m_groupManager.update();\n                    \n                    // Rename the user in the group.\n                    m_groupManager.renameUser(oldName, newName);\n        \n                    // Rename the user in the view.\n                    // viewFactory.renameUser(oldName, newName);\n                }",
    "code_after_change": "{\n                    if (m_users.containsKey(newName)) {\n                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n                    }\n\n                    // Rename the user in the user map.\n                    m_users.remove(oldName);\n                    data.setUserId(newName);\n                    m_users.put(newName, data);\n        \n                    // Refresh the groups config first\n                    m_groupManager.update();\n                    \n                    // Rename the user in the group.\n                    m_groupManager.renameUser(oldName, newName);\n        \n                    // Rename the user in the view.\n                    // viewFactory.renameUser(oldName, newName);\n                }",
    "patch": "@@ -995,6 +995,10 @@ public void renameUser(final String oldName, final String newName) throws Except\n                     m_users.remove(oldName);\n                     throw new Exception(\"UserFactory:rename the data contained for old user \" + oldName + \" is null\");\n                 } else {\n+                    if (m_users.containsKey(newName)) {\n+                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n+                    }\n+\n                     // Rename the user in the user map.\n                     m_users.remove(oldName);\n                     data.setUserId(newName);",
    "function_modified_lines": {
      "added": [
        "                    if (m_users.containsKey(newName)) {\n",
        "                        throw new Exception(\"UserFactory: cannot rename user \" + oldName + \". An user with the given name \" + newName + \" already exists\");\n",
        "                    }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection at `/opennms/admin/userGroupView/users/updateUser`. This flaw allows assigning `ROLE_ADMIN` security role to a normal user. Using this flaw, an attacker can trick the admin user to assign administrator privileges to a normal user by enticing him to click upon an attacker-controlled website.",
    "id": 12041
  },
  {
    "cve_id": "CVE-2021-25930",
    "code_before_change": "{\n        try {\n            UserFactory.init();\n        } catch (Throwable e) {\n            throw new ServletException(\"AddNewUserServlet: Error initialising user factory.\" + e);\n        }\n        UserManager userFactory = UserFactory.getInstance();\n\n        String userID = request.getParameter(\"userID\");\n        String password = request.getParameter(\"pass1\");\n\n        boolean hasUser = false;\n        try {\n            hasUser = userFactory.hasUser(userID);\n        } catch (Throwable e) {\n            throw new ServletException(\"can't determine if user \" + userID + \" already exists in users.xml.\", e);\n        }\n\n        if (hasUser) {\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/newUser.jsp?action=redo\");\n            dispatcher.forward(request, response);\n        } else {\n            final Password pass = new Password();\n            pass.setEncryptedPassword(UserFactory.getInstance().encryptedPassword(password, true));\n            pass.setSalt(true);\n\n            final User newUser = new User();\n            newUser.setUserId(userID);\n            newUser.setPassword(pass);\n\n            final HttpSession userSession = request.getSession(false);\n            userSession.setAttribute(\"user.modifyUser.jsp\", newUser);\n\n            // forward the request for proper display\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/modifyUser.jsp\");\n            dispatcher.forward(request, response);\n        }\n    }",
    "code_after_change": "{\n        try {\n            UserFactory.init();\n        } catch (Throwable e) {\n            throw new ServletException(\"AddNewUserServlet: Error initialising user factory.\" + e);\n        }\n        UserManager userFactory = UserFactory.getInstance();\n\n        String userID = request.getParameter(\"userID\");\n\n        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        String password = request.getParameter(\"pass1\");\n\n        boolean hasUser = false;\n        try {\n            hasUser = userFactory.hasUser(userID);\n        } catch (Throwable e) {\n            throw new ServletException(\"can't determine if user \" + userID + \" already exists in users.xml.\", e);\n        }\n\n        if (hasUser) {\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/newUser.jsp?action=redo\");\n            dispatcher.forward(request, response);\n        } else {\n            final Password pass = new Password();\n            pass.setEncryptedPassword(UserFactory.getInstance().encryptedPassword(password, true));\n            pass.setSalt(true);\n\n            final User newUser = new User();\n            newUser.setUserId(userID);\n            newUser.setPassword(pass);\n\n            final HttpSession userSession = request.getSession(false);\n            userSession.setAttribute(\"user.modifyUser.jsp\", newUser);\n\n            // forward the request for proper display\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/modifyUser.jsp\");\n            dispatcher.forward(request, response);\n        }\n    }",
    "patch": "@@ -69,6 +69,11 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         UserManager userFactory = UserFactory.getInstance();\n \n         String userID = request.getParameter(\"userID\");\n+\n+        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         String password = request.getParameter(\"pass1\");\n \n         boolean hasUser = false;",
    "function_modified_lines": {
      "added": [
        "\n",
        "        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection, and since there is no validation of an existing user name while renaming a user. As a result, privileges of the renamed user are being overwritten by the old user and the old user is being deleted from the user list.",
    "id": 12053
  },
  {
    "cve_id": "CVE-2021-25930",
    "code_before_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
    "code_after_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
    "patch": "@@ -60,6 +60,10 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         String userID = request.getParameter(\"userID\");\n         String newID = request.getParameter(\"newID\");\n \n+        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         // now save to the xml file\n         try {\n             UserManager userFactory = UserFactory.getInstance();",
    "function_modified_lines": {
      "added": [
        "        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection, and since there is no validation of an existing user name while renaming a user. As a result, privileges of the renamed user are being overwritten by the old user and the old user is being deleted from the user list.",
    "id": 12054
  },
  {
    "cve_id": "CVE-2021-25930",
    "code_before_change": "{    \n                \n        String groupName = request.getParameter(\"groupName\");\n        String groupComment = request.getParameter(\"groupComment\");\n        if (groupComment == null) {\n            groupComment = \"\";\n        }\n\n        boolean hasGroup = false;\n        try {\n            hasGroup = m_groupRepository.groupExists(groupName);\n        } catch (Throwable e) {\n            throw new ServletException(\"Can't determine if group \" + groupName + \" already exists in groups.xml.\", e);\n        }\n        \n        if (hasGroup) {\n            return new ModelAndView(\"admin/userGroupView/groups/newGroup\", \"action\", \"redo\");            \n        } else {\n            WebGroup newGroup = new WebGroup();\n            newGroup.setName(groupName);\n            newGroup.setComments(groupComment);\n            \n            return editGroup(request, newGroup);\n        }\n    }",
    "code_after_change": "{    \n                \n        String groupName = request.getParameter(\"groupName\");\n        String groupComment = request.getParameter(\"groupComment\");\n        if (groupComment == null) {\n            groupComment = \"\";\n        }\n\n        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n        }\n\n        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n        }\n\n        boolean hasGroup = false;\n        try {\n            hasGroup = m_groupRepository.groupExists(groupName);\n        } catch (Throwable e) {\n            throw new ServletException(\"Can't determine if group \" + groupName + \" already exists in groups.xml.\", e);\n        }\n        \n        if (hasGroup) {\n            return new ModelAndView(\"admin/userGroupView/groups/newGroup\", \"action\", \"redo\");            \n        } else {\n            WebGroup newGroup = new WebGroup();\n            newGroup.setName(groupName);\n            newGroup.setComments(groupComment);\n            \n            return editGroup(request, newGroup);\n        }\n    }",
    "patch": "@@ -151,7 +151,11 @@ private ModelAndView renameGroup(HttpServletRequest request, HttpServletResponse\n         \n         String oldName = request.getParameter(\"groupName\");\n         String newName = request.getParameter(\"newName\");\n-        \n+\n+        if (newName != null && newName.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n+        }\n+\n         if (StringUtils.hasText(oldName) && StringUtils.hasText(newName)) {\n             m_groupRepository.renameGroup(oldName, newName);\n         }\n@@ -312,6 +316,14 @@ private ModelAndView addGroup(HttpServletRequest request, HttpServletResponse re\n             groupComment = \"\";\n         }\n \n+        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n+        }\n+\n+        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n+        }\n+\n         boolean hasGroup = false;\n         try {\n             hasGroup = m_groupRepository.groupExists(groupName);",
    "function_modified_lines": {
      "added": [
        "        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n",
        "        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection, and since there is no validation of an existing user name while renaming a user. As a result, privileges of the renamed user are being overwritten by the old user and the old user is being deleted from the user list.",
    "id": 12055
  },
  {
    "cve_id": "CVE-2021-25931",
    "code_before_change": "{\n        try {\n            UserFactory.init();\n        } catch (Throwable e) {\n            throw new ServletException(\"AddNewUserServlet: Error initialising user factory.\" + e);\n        }\n        UserManager userFactory = UserFactory.getInstance();\n\n        String userID = request.getParameter(\"userID\");\n        String password = request.getParameter(\"pass1\");\n\n        boolean hasUser = false;\n        try {\n            hasUser = userFactory.hasUser(userID);\n        } catch (Throwable e) {\n            throw new ServletException(\"can't determine if user \" + userID + \" already exists in users.xml.\", e);\n        }\n\n        if (hasUser) {\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/newUser.jsp?action=redo\");\n            dispatcher.forward(request, response);\n        } else {\n            final Password pass = new Password();\n            pass.setEncryptedPassword(UserFactory.getInstance().encryptedPassword(password, true));\n            pass.setSalt(true);\n\n            final User newUser = new User();\n            newUser.setUserId(userID);\n            newUser.setPassword(pass);\n\n            final HttpSession userSession = request.getSession(false);\n            userSession.setAttribute(\"user.modifyUser.jsp\", newUser);\n\n            // forward the request for proper display\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/modifyUser.jsp\");\n            dispatcher.forward(request, response);\n        }\n    }",
    "code_after_change": "{\n        try {\n            UserFactory.init();\n        } catch (Throwable e) {\n            throw new ServletException(\"AddNewUserServlet: Error initialising user factory.\" + e);\n        }\n        UserManager userFactory = UserFactory.getInstance();\n\n        String userID = request.getParameter(\"userID\");\n\n        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        String password = request.getParameter(\"pass1\");\n\n        boolean hasUser = false;\n        try {\n            hasUser = userFactory.hasUser(userID);\n        } catch (Throwable e) {\n            throw new ServletException(\"can't determine if user \" + userID + \" already exists in users.xml.\", e);\n        }\n\n        if (hasUser) {\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/newUser.jsp?action=redo\");\n            dispatcher.forward(request, response);\n        } else {\n            final Password pass = new Password();\n            pass.setEncryptedPassword(UserFactory.getInstance().encryptedPassword(password, true));\n            pass.setSalt(true);\n\n            final User newUser = new User();\n            newUser.setUserId(userID);\n            newUser.setPassword(pass);\n\n            final HttpSession userSession = request.getSession(false);\n            userSession.setAttribute(\"user.modifyUser.jsp\", newUser);\n\n            // forward the request for proper display\n            RequestDispatcher dispatcher = this.getServletContext().getRequestDispatcher(\"/admin/userGroupView/users/modifyUser.jsp\");\n            dispatcher.forward(request, response);\n        }\n    }",
    "patch": "@@ -69,6 +69,11 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         UserManager userFactory = UserFactory.getInstance();\n \n         String userID = request.getParameter(\"userID\");\n+\n+        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         String password = request.getParameter(\"pass1\");\n \n         boolean hasUser = false;",
    "function_modified_lines": {
      "added": [
        "\n",
        "        if (userID != null && userID.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection at `/opennms/admin/userGroupView/users/updateUser`. This flaw allows assigning `ROLE_ADMIN` security role to a normal user. Using this flaw, an attacker can trick the admin user to assign administrator privileges to a normal user by enticing him to click upon an attacker-controlled website.",
    "id": 12057
  },
  {
    "cve_id": "CVE-2021-25931",
    "code_before_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
    "code_after_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
    "patch": "@@ -60,6 +60,10 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         String userID = request.getParameter(\"userID\");\n         String newID = request.getParameter(\"newID\");\n \n+        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         // now save to the xml file\n         try {\n             UserManager userFactory = UserFactory.getInstance();",
    "function_modified_lines": {
      "added": [
        "        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection at `/opennms/admin/userGroupView/users/updateUser`. This flaw allows assigning `ROLE_ADMIN` security role to a normal user. Using this flaw, an attacker can trick the admin user to assign administrator privileges to a normal user by enticing him to click upon an attacker-controlled website.",
    "id": 12058
  },
  {
    "cve_id": "CVE-2021-25931",
    "code_before_change": "{    \n                \n        String groupName = request.getParameter(\"groupName\");\n        String groupComment = request.getParameter(\"groupComment\");\n        if (groupComment == null) {\n            groupComment = \"\";\n        }\n\n        boolean hasGroup = false;\n        try {\n            hasGroup = m_groupRepository.groupExists(groupName);\n        } catch (Throwable e) {\n            throw new ServletException(\"Can't determine if group \" + groupName + \" already exists in groups.xml.\", e);\n        }\n        \n        if (hasGroup) {\n            return new ModelAndView(\"admin/userGroupView/groups/newGroup\", \"action\", \"redo\");            \n        } else {\n            WebGroup newGroup = new WebGroup();\n            newGroup.setName(groupName);\n            newGroup.setComments(groupComment);\n            \n            return editGroup(request, newGroup);\n        }\n    }",
    "code_after_change": "{    \n                \n        String groupName = request.getParameter(\"groupName\");\n        String groupComment = request.getParameter(\"groupComment\");\n        if (groupComment == null) {\n            groupComment = \"\";\n        }\n\n        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n        }\n\n        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n        }\n\n        boolean hasGroup = false;\n        try {\n            hasGroup = m_groupRepository.groupExists(groupName);\n        } catch (Throwable e) {\n            throw new ServletException(\"Can't determine if group \" + groupName + \" already exists in groups.xml.\", e);\n        }\n        \n        if (hasGroup) {\n            return new ModelAndView(\"admin/userGroupView/groups/newGroup\", \"action\", \"redo\");            \n        } else {\n            WebGroup newGroup = new WebGroup();\n            newGroup.setName(groupName);\n            newGroup.setComments(groupComment);\n            \n            return editGroup(request, newGroup);\n        }\n    }",
    "patch": "@@ -151,7 +151,11 @@ private ModelAndView renameGroup(HttpServletRequest request, HttpServletResponse\n         \n         String oldName = request.getParameter(\"groupName\");\n         String newName = request.getParameter(\"newName\");\n-        \n+\n+        if (newName != null && newName.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n+        }\n+\n         if (StringUtils.hasText(oldName) && StringUtils.hasText(newName)) {\n             m_groupRepository.renameGroup(oldName, newName);\n         }\n@@ -312,6 +316,14 @@ private ModelAndView addGroup(HttpServletRequest request, HttpServletResponse re\n             groupComment = \"\";\n         }\n \n+        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n+        }\n+\n+        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n+        }\n+\n         boolean hasGroup = false;\n         try {\n             hasGroup = m_groupRepository.groupExists(groupName);",
    "function_modified_lines": {
      "added": [
        "        if (groupName != null && groupName.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"Group ID must not contain any HTML markup.\");\n",
        "        }\n",
        "\n",
        "        if (groupComment != null && groupComment.matches(\".*[&<>\\\"`']+.*\")) {\n",
        "            throw new ServletException(\"Group comment must not contain any HTML markup.\");\n",
        "        }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection at `/opennms/admin/userGroupView/users/updateUser`. This flaw allows assigning `ROLE_ADMIN` security role to a normal user. Using this flaw, an attacker can trick the admin user to assign administrator privileges to a normal user by enticing him to click upon an attacker-controlled website.",
    "id": 12059
  },
  {
    "cve_id": "CVE-2020-7780",
    "code_before_change": "{\n\n    protected Route buildRoute(HttpSessionAwareDirectives<String> testDirectives, SessionContinuity<String> oneOff, SessionContinuity<String> refreshable, SetSessionTransport sessionTransport, CsrfCheckMode<String> csrfCheckMode) {\n        return route(\n            testDirectives.randomTokenCsrfProtection(csrfCheckMode, () ->\n                route(\n                    get(() ->\n                        path(\"site\", () ->\n                            complete(\"ok\")\n                        )\n                    ),\n                    post(() ->\n                        route(\n                            path(\"login\", () ->\n                                testDirectives.setNewCsrfToken(csrfCheckMode, () ->\n                                    complete(\"ok\"))),\n                            path(\"transfer_money\", () ->\n                                complete(\"ok\")\n                            )\n                        )\n                    )\n                )\n            )\n        );\n\n    }\n\n    @Test\n    public void shouldSetTheCsrfCookieOnTheFirstGetRequestOnly() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpResponse response = testRouteResult.response();\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(response);\n        Assert.assertNotNull(csrfCookie.value());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.GET(\"/site\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpResponse response2 = testRouteResult2.response();\n        HttpCookie cookieValues2 = getCsrfTokenCookieValues(response2);\n        Assert.assertNull(cookieValues2);\n\n    }\n\n    @Test\n    public void shouldRejectRequestsIfTheCsrfCookieDoesNotMatchTheHeaderValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, \"something else\"))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.FORBIDDEN);\n    }\n\n    @Test\n    public void shouldRejectRequestsIfTheCsrfCookieIsNotSet() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\"));\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.FORBIDDEN);\n\n\n    }\n\n    @Test\n    public void shouldAcceptRequestsIfTheCsrfCookieMatchesTheHeaderValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n    }\n\n    @Test\n    public void shouldAcceptRequestsIfTheCsrfCookieMatchesTheFormFieldValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderAndFormMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        final FormData formData = FormData.create(\n            Pair.create(csrfSubmittedName, csrfCookie.value())\n        );\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\").withEntity(formData.toEntity())\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n    }\n\n    @Test\n    public void shouldSetANewCsrfCookieWhenRequested() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/login\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpCookie csrfCookie2 = getCsrfTokenCookieValues(testRouteResult2.response());\n        Assert.assertNotEquals(csrfCookie.value(), csrfCookie2.value());\n\n    }\n\n}",
    "code_after_change": "{\n\n    protected Route buildRoute(HttpSessionAwareDirectives<String> testDirectives, SessionContinuity<String> oneOff, SessionContinuity<String> refreshable, SetSessionTransport sessionTransport, CsrfCheckMode<String> csrfCheckMode) {\n        return route(\n            testDirectives.randomTokenCsrfProtection(csrfCheckMode, () ->\n                route(\n                    get(() ->\n                        path(\"site\", () ->\n                            complete(\"ok\")\n                        )\n                    ),\n                    post(() ->\n                        route(\n                            path(\"login\", () ->\n                                testDirectives.setNewCsrfToken(csrfCheckMode, () ->\n                                    complete(\"ok\"))),\n                            path(\"transfer_money\", () ->\n                                complete(\"ok\")\n                            )\n                        )\n                    )\n                )\n            )\n        );\n\n    }\n\n    @Test\n    public void shouldSetTheCsrfCookieOnTheFirstGetRequestOnly() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpResponse response = testRouteResult.response();\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(response);\n        Assert.assertNotNull(csrfCookie.value());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.GET(\"/site\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpResponse response2 = testRouteResult2.response();\n        HttpCookie cookieValues2 = getCsrfTokenCookieValues(response2);\n        Assert.assertNull(cookieValues2);\n\n    }\n\n    @Test\n    public void shouldRejectRequestsIfTheCsrfCookieDoesNotMatchTheHeaderValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, \"something else\"))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.FORBIDDEN);\n    }\n\n    @Test\n    public void shouldRejectRequestsIfTheCsrfCookieIsNotSet() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\"));\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.FORBIDDEN);\n\n\n    }\n\n    @Test\n    public void shouldRejectRequestsIfTheCsrfCookieAndTheHeaderAreEmpty() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n          .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n          .assertStatusCode(StatusCodes.OK);\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n          .run(HttpRequest.POST(\"/transfer_money\")\n            .addHeader(Cookie.create(csrfCookieName, \"\"))\n            .addHeader(RawHeader.create(csrfSubmittedName, \"\"))\n          );\n\n        // then\n        testRouteResult2\n          .assertStatusCode(StatusCodes.FORBIDDEN);\n\n    }\n\n    @Test\n    public void shouldAcceptRequestsIfTheCsrfCookieMatchesTheHeaderValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n    }\n\n    @Test\n    public void shouldAcceptRequestsIfTheCsrfCookieMatchesTheFormFieldValue() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderAndFormMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        final FormData formData = FormData.create(\n            Pair.create(csrfSubmittedName, csrfCookie.value())\n        );\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/transfer_money\").withEntity(formData.toEntity())\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n    }\n\n    @Test\n    public void shouldSetANewCsrfCookieWhenRequested() {\n        // given\n        final Route route = createCsrfRouteWithCheckHeaderMode();\n\n        // when\n        TestRouteResult testRouteResult = testRoute(route)\n            .run(HttpRequest.GET(\"/site\"));\n\n        // then\n        testRouteResult\n            .assertStatusCode(StatusCodes.OK);\n\n        // and\n        HttpCookie csrfCookie = getCsrfTokenCookieValues(testRouteResult.response());\n\n        /* second request */\n        // when\n        TestRouteResult testRouteResult2 = testRoute(route)\n            .run(HttpRequest.POST(\"/login\")\n                .addHeader(Cookie.create(csrfCookieName, csrfCookie.value()))\n                .addHeader(RawHeader.create(csrfSubmittedName, csrfCookie.value()))\n            );\n\n        // then\n        testRouteResult2\n            .assertStatusCode(StatusCodes.OK)\n            .assertEntity(\"ok\");\n\n        // and\n        HttpCookie csrfCookie2 = getCsrfTokenCookieValues(testRouteResult2.response());\n        Assert.assertNotEquals(csrfCookie.value(), csrfCookie2.value());\n\n    }\n\n}",
    "patch": "@@ -135,6 +135,33 @@ public void shouldRejectRequestsIfTheCsrfCookieIsNotSet() {\n \n     }\n \n+    @Test\n+    public void shouldRejectRequestsIfTheCsrfCookieAndTheHeaderAreEmpty() {\n+        // given\n+        final Route route = createCsrfRouteWithCheckHeaderMode();\n+\n+        // when\n+        TestRouteResult testRouteResult = testRoute(route)\n+          .run(HttpRequest.GET(\"/site\"));\n+\n+        // then\n+        testRouteResult\n+          .assertStatusCode(StatusCodes.OK);\n+\n+        /* second request */\n+        // when\n+        TestRouteResult testRouteResult2 = testRoute(route)\n+          .run(HttpRequest.POST(\"/transfer_money\")\n+            .addHeader(Cookie.create(csrfCookieName, \"\"))\n+            .addHeader(RawHeader.create(csrfSubmittedName, \"\"))\n+          );\n+\n+        // then\n+        testRouteResult2\n+          .assertStatusCode(StatusCodes.FORBIDDEN);\n+\n+    }\n+\n     @Test\n     public void shouldAcceptRequestsIfTheCsrfCookieMatchesTheHeaderValue() {\n         // given",
    "function_modified_lines": {
      "added": [
        "    @Test\n",
        "    public void shouldRejectRequestsIfTheCsrfCookieAndTheHeaderAreEmpty() {\n",
        "        // given\n",
        "        final Route route = createCsrfRouteWithCheckHeaderMode();\n",
        "\n",
        "        // when\n",
        "        TestRouteResult testRouteResult = testRoute(route)\n",
        "          .run(HttpRequest.GET(\"/site\"));\n",
        "\n",
        "        // then\n",
        "        testRouteResult\n",
        "          .assertStatusCode(StatusCodes.OK);\n",
        "\n",
        "        /* second request */\n",
        "        // when\n",
        "        TestRouteResult testRouteResult2 = testRoute(route)\n",
        "          .run(HttpRequest.POST(\"/transfer_money\")\n",
        "            .addHeader(Cookie.create(csrfCookieName, \"\"))\n",
        "            .addHeader(RawHeader.create(csrfSubmittedName, \"\"))\n",
        "          );\n",
        "\n",
        "        // then\n",
        "        testRouteResult2\n",
        "          .assertStatusCode(StatusCodes.FORBIDDEN);\n",
        "\n",
        "    }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "This affects the package com.softwaremill.akka-http-session:core_2.13 before 0.5.11; the package com.softwaremill.akka-http-session:core_2.12 before 0.5.11; the package com.softwaremill.akka-http-session:core_2.11 before 0.5.11. For older versions, endpoints protected by randomTokenCsrfProtection could be bypassed with an empty X-XSRF-TOKEN header and an empty XSRF-TOKEN cookie.",
    "id": 12191
  },
  {
    "cve_id": "CVE-2023-29213",
    "code_before_change": "{\n        Object[] parameters;\n        if (invocationOnMockRender.getArguments().length > i) {\n            Object argument = invocationOnMockRender.getArgument(i);\n            if (argument instanceof String) {\n                parameters = new Object[] { argument };\n            } else {\n                parameters = (Object[]) argument;\n            }\n        } else {\n            parameters = new Object[] {};\n        }\n        return parameters;\n    }",
    "code_after_change": "{\n        Object[] parameters;\n        Object[] arguments = invocationOnMockRender.getArguments();\n        if (arguments.length > i) {\n            parameters = Arrays.copyOfRange(arguments, i, arguments.length);\n        } else {\n            parameters = new Object[] {};\n        }\n        return parameters;\n    }",
    "patch": "@@ -127,13 +127,9 @@ private static String renderString(String translationKey, Object[] parameters)\n     private static Object[] getVarArgs(InvocationOnMock invocationOnMockRender, int i)\n     {\n         Object[] parameters;\n-        if (invocationOnMockRender.getArguments().length > i) {\n-            Object argument = invocationOnMockRender.getArgument(i);\n-            if (argument instanceof String) {\n-                parameters = new Object[] { argument };\n-            } else {\n-                parameters = (Object[]) argument;\n-            }\n+        Object[] arguments = invocationOnMockRender.getArguments();\n+        if (arguments.length > i) {\n+            parameters = Arrays.copyOfRange(arguments, i, arguments.length);\n         } else {\n             parameters = new Object[] {};\n         }",
    "function_modified_lines": {
      "added": [
        "        Object[] arguments = invocationOnMockRender.getArguments();\n",
        "        if (arguments.length > i) {\n",
        "            parameters = Arrays.copyOfRange(arguments, i, arguments.length);\n"
      ],
      "deleted": [
        "        if (invocationOnMockRender.getArguments().length > i) {\n",
        "            Object argument = invocationOnMockRender.getArgument(i);\n",
        "            if (argument instanceof String) {\n",
        "                parameters = new Object[] { argument };\n",
        "            } else {\n",
        "                parameters = (Object[]) argument;\n",
        "            }\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. In affected versions of `org.xwiki.platform:xwiki-platform-logging-ui` it is possible to trick a user with programming rights into visiting a constructed url where e.g., by embedding an image with this URL in a document that is viewed by a user with programming rights which will evaluate an expression in the constructed url and execute it. This issue has been addressed in versions 13.10.11, 14.4.7, and 14.10. Users are advised to upgrade. There are no known workarounds for this vulnerability.\n",
    "id": 12321
  },
  {
    "cve_id": "CVE-2023-46242",
    "code_before_change": "/*\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n */\npackage com.xpn.xwiki.web;\n\nimport javax.inject.Named;\n\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.mockito.Mock;\nimport org.xwiki.model.reference.DocumentReference;\nimport org.xwiki.store.TemporaryAttachmentSessionsManager;\nimport org.xwiki.test.junit5.mockito.InjectMockComponents;\nimport org.xwiki.test.junit5.mockito.MockComponent;\nimport org.xwiki.user.UserReference;\nimport org.xwiki.user.UserReferenceResolver;\nimport org.xwiki.user.UserReferenceSerializer;\n\nimport com.xpn.xwiki.XWikiException;\nimport com.xpn.xwiki.doc.XWikiDocument;\nimport com.xpn.xwiki.test.MockitoOldcore;\nimport com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;\nimport com.xpn.xwiki.test.junit5.mockito.OldcoreTest;\nimport com.xpn.xwiki.test.reference.ReferenceComponentList;\n\nimport static org.junit.jupiter.api.Assertions.assertSame;\nimport static org.mockito.Mockito.mock;\nimport static org.mockito.Mockito.when;\n\n/**\n * Validate {@link EditAction}.\n * \n * @version $Id$\n */\n@OldcoreTest\n@ReferenceComponentList\npublic class EditActionTest\n{\n    private static final DocumentReference USER_DOCUMENT_REFERENCE = new DocumentReference(\"wiki\", \"XWiki\", \"user\");\n\n    private static final UserReference USER_REFERENCE = mock(UserReference.class);\n\n    private static final UserReference OTHERUSER_REFERENCE = mock(UserReference.class);\n\n    @InjectMockComponents\n    private EditAction action;\n\n    @InjectMockitoOldcore\n    private MockitoOldcore oldcore;\n\n    @MockComponent\n    private TemporaryAttachmentSessionsManager temporaryAttachmentSessionsManager;\n\n    @MockComponent\n    @Named(\"document\")\n    private UserReferenceResolver<DocumentReference> documentReferenceUserReferenceResolver;\n\n    @MockComponent\n    @Named(\"document\")\n    private UserReferenceSerializer<DocumentReference> documentReferenceUserReferenceSerializer;\n\n    @Mock\n    private XWikiRequest request;\n\n    @BeforeEach\n    public void beforeEach()\n    {\n        when(this.documentReferenceUserReferenceResolver.resolve(USER_DOCUMENT_REFERENCE)).thenReturn(USER_REFERENCE);\n        when(this.documentReferenceUserReferenceSerializer.serialize(USER_REFERENCE)).thenReturn(USER_DOCUMENT_REFERENCE);\n\n        this.oldcore.getXWikiContext().setUserReference(USER_DOCUMENT_REFERENCE);\n    }\n\n    private String initAndRenderAction() throws XWikiException\n    {\n        EditForm form = new EditForm();\n        form.reset(this.request);\n\n        this.oldcore.getXWikiContext().setForm(form);\n\n        return this.action.render(this.oldcore.getXWikiContext());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentDoesNotExist() throws XWikiException\n    {\n        XWikiDocument document = oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(USER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(USER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(USER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(USER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentExist() throws XWikiException\n    {\n        XWikiDocument document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        document.getAuthors().setCreator(OTHERUSER_REFERENCE);\n        document.getAuthors().setContentAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setEffectiveMetadataAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setOriginalMetadataAuthor(OTHERUSER_REFERENCE);\n        this.oldcore.getSpyXWiki().saveDocument(document, this.oldcore.getXWikiContext());\n\n        document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n        this.oldcore.getXWikiContext().put(\"tdoc\", document);\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentExistAndContentIsModified() throws XWikiException\n    {\n        XWikiDocument document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        document.getAuthors().setCreator(OTHERUSER_REFERENCE);\n        document.getAuthors().setContentAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setEffectiveMetadataAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setOriginalMetadataAuthor(OTHERUSER_REFERENCE);\n        this.oldcore.getSpyXWiki().saveDocument(document, this.oldcore.getXWikiContext());\n\n        document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n        this.oldcore.getXWikiContext().put(\"tdoc\", document);\n\n        when(this.request.getParameter(\"content\")).thenReturn(\"modified content\");\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(USER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n    }\n}\n",
    "code_after_change": "/*\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n */\npackage com.xpn.xwiki.web;\n\nimport java.util.Map;\n\nimport javax.inject.Named;\n\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\nimport org.mockito.Mock;\nimport org.xwiki.csrf.CSRFToken;\nimport org.xwiki.model.reference.DocumentReference;\nimport org.xwiki.store.TemporaryAttachmentSessionsManager;\nimport org.xwiki.test.junit5.mockito.InjectMockComponents;\nimport org.xwiki.test.junit5.mockito.MockComponent;\nimport org.xwiki.user.UserReference;\nimport org.xwiki.user.UserReferenceResolver;\nimport org.xwiki.user.UserReferenceSerializer;\n\nimport com.xpn.xwiki.XWikiException;\nimport com.xpn.xwiki.doc.XWikiDocument;\nimport com.xpn.xwiki.test.MockitoOldcore;\nimport com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;\nimport com.xpn.xwiki.test.junit5.mockito.OldcoreTest;\nimport com.xpn.xwiki.test.reference.ReferenceComponentList;\n\nimport static org.junit.jupiter.api.Assertions.assertEquals;\nimport static org.junit.jupiter.api.Assertions.assertSame;\nimport static org.mockito.Mockito.mock;\nimport static org.mockito.Mockito.when;\n\n/**\n * Validate {@link EditAction}.\n * \n * @version $Id$\n */\n@OldcoreTest\n@ReferenceComponentList\npublic class EditActionTest\n{\n    private static final DocumentReference USER_DOCUMENT_REFERENCE = new DocumentReference(\"wiki\", \"XWiki\", \"user\");\n\n    private static final UserReference USER_REFERENCE = mock(UserReference.class);\n\n    private static final UserReference OTHERUSER_REFERENCE = mock(UserReference.class);\n\n    @InjectMockComponents\n    private EditAction action;\n\n    @InjectMockitoOldcore\n    private MockitoOldcore oldcore;\n\n    @MockComponent\n    private TemporaryAttachmentSessionsManager temporaryAttachmentSessionsManager;\n\n    @MockComponent\n    @Named(\"document\")\n    private UserReferenceResolver<DocumentReference> documentReferenceUserReferenceResolver;\n\n    @MockComponent\n    @Named(\"document\")\n    private UserReferenceSerializer<DocumentReference> documentReferenceUserReferenceSerializer;\n\n    @MockComponent\n    private CSRFToken csrf;\n\n    @Mock\n    private XWikiRequest request;\n\n    @BeforeEach\n    public void beforeEach()\n    {\n        when(this.documentReferenceUserReferenceResolver.resolve(USER_DOCUMENT_REFERENCE)).thenReturn(USER_REFERENCE);\n        when(this.documentReferenceUserReferenceSerializer.serialize(USER_REFERENCE)).thenReturn(USER_DOCUMENT_REFERENCE);\n\n        this.oldcore.getXWikiContext().setUserReference(USER_DOCUMENT_REFERENCE);\n\n        this.oldcore.getXWikiContext().setRequest(new XWikiServletRequestStub.Builder().\n            setRequestParameters(Map.of(\"form_token\", new String[] {\"tokenvalue\"})).build());\n    }\n\n    private String initAndRenderAction() throws XWikiException\n    {\n        EditForm form = new EditForm();\n        form.reset(this.request);\n\n        this.oldcore.getXWikiContext().setForm(form);\n\n        return this.action.render(this.oldcore.getXWikiContext());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentDoesNotExist() throws XWikiException\n    {\n        XWikiDocument document = oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(USER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(USER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(USER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(USER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentExist() throws XWikiException\n    {\n        XWikiDocument document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        document.getAuthors().setCreator(OTHERUSER_REFERENCE);\n        document.getAuthors().setContentAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setEffectiveMetadataAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setOriginalMetadataAuthor(OTHERUSER_REFERENCE);\n        this.oldcore.getSpyXWiki().saveDocument(document, this.oldcore.getXWikiContext());\n\n        document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n        this.oldcore.getXWikiContext().put(\"tdoc\", document);\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentExistAndContentIsModifiedAndInvalidValidCSRF() throws XWikiException\n    {\n        documentAuthorsWhenDocumentExistAndContentIsModified(false);\n    }\n\n    @Test\n    void documentAuthorsWhenDocumentExistAndContentIsModifiedAndValidCSRF() throws XWikiException\n    {\n        documentAuthorsWhenDocumentExistAndContentIsModified(true);\n    }\n\n    void documentAuthorsWhenDocumentExistAndContentIsModified(boolean validToken) throws XWikiException\n    {\n        XWikiDocument document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        document.getAuthors().setCreator(OTHERUSER_REFERENCE);\n        document.getAuthors().setContentAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setEffectiveMetadataAuthor(OTHERUSER_REFERENCE);\n        document.getAuthors().setOriginalMetadataAuthor(OTHERUSER_REFERENCE);\n        this.oldcore.getSpyXWiki().saveDocument(document, this.oldcore.getXWikiContext());\n\n        document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n            this.oldcore.getXWikiContext());\n        this.oldcore.getXWikiContext().setDoc(document);\n        this.oldcore.getXWikiContext().put(\"tdoc\", document);\n\n        when(this.request.getParameter(\"content\")).thenReturn(\"modified content\");\n\n        when(this.csrf.isTokenValid(\"tokenvalue\")).thenReturn(validToken);\n\n        initAndRenderAction();\n\n        document = this.oldcore.getXWikiContext().getDoc();\n\n        assertSame(USER_REFERENCE, document.getAuthors().getContentAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getCreator());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n        assertSame(OTHERUSER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n        assertEquals(!validToken, document.isRestricted());\n    }\n}\n",
    "patch": "@@ -19,11 +19,14 @@\n  */\n package com.xpn.xwiki.web;\n \n+import java.util.Map;\n+\n import javax.inject.Named;\n \n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.mockito.Mock;\n+import org.xwiki.csrf.CSRFToken;\n import org.xwiki.model.reference.DocumentReference;\n import org.xwiki.store.TemporaryAttachmentSessionsManager;\n import org.xwiki.test.junit5.mockito.InjectMockComponents;\n@@ -39,6 +42,7 @@\n import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;\n import com.xpn.xwiki.test.reference.ReferenceComponentList;\n \n+import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertSame;\n import static org.mockito.Mockito.mock;\n import static org.mockito.Mockito.when;\n@@ -75,6 +79,9 @@ public class EditActionTest\n     @Named(\"document\")\n     private UserReferenceSerializer<DocumentReference> documentReferenceUserReferenceSerializer;\n \n+    @MockComponent\n+    private CSRFToken csrf;\n+\n     @Mock\n     private XWikiRequest request;\n \n@@ -85,6 +92,9 @@ public void beforeEach()\n         when(this.documentReferenceUserReferenceSerializer.serialize(USER_REFERENCE)).thenReturn(USER_DOCUMENT_REFERENCE);\n \n         this.oldcore.getXWikiContext().setUserReference(USER_DOCUMENT_REFERENCE);\n+\n+        this.oldcore.getXWikiContext().setRequest(new XWikiServletRequestStub.Builder().\n+            setRequestParameters(Map.of(\"form_token\", new String[] {\"tokenvalue\"})).build());\n     }\n \n     private String initAndRenderAction() throws XWikiException\n@@ -141,7 +151,18 @@ void documentAuthorsWhenDocumentExist() throws XWikiException\n     }\n \n     @Test\n-    void documentAuthorsWhenDocumentExistAndContentIsModified() throws XWikiException\n+    void documentAuthorsWhenDocumentExistAndContentIsModifiedAndInvalidValidCSRF() throws XWikiException\n+    {\n+        documentAuthorsWhenDocumentExistAndContentIsModified(false);\n+    }\n+\n+    @Test\n+    void documentAuthorsWhenDocumentExistAndContentIsModifiedAndValidCSRF() throws XWikiException\n+    {\n+        documentAuthorsWhenDocumentExistAndContentIsModified(true);\n+    }\n+\n+    void documentAuthorsWhenDocumentExistAndContentIsModified(boolean validToken) throws XWikiException\n     {\n         XWikiDocument document = this.oldcore.getSpyXWiki().getDocument(new DocumentReference(\"wiki\", \"space\", \"page\"),\n             this.oldcore.getXWikiContext());\n@@ -158,6 +179,8 @@ void documentAuthorsWhenDocumentExistAndContentIsModified() throws XWikiExceptio\n \n         when(this.request.getParameter(\"content\")).thenReturn(\"modified content\");\n \n+        when(this.csrf.isTokenValid(\"tokenvalue\")).thenReturn(validToken);\n+\n         initAndRenderAction();\n \n         document = this.oldcore.getXWikiContext().getDoc();\n@@ -166,5 +189,6 @@ void documentAuthorsWhenDocumentExistAndContentIsModified() throws XWikiExceptio\n         assertSame(OTHERUSER_REFERENCE, document.getAuthors().getCreator());\n         assertSame(OTHERUSER_REFERENCE, document.getAuthors().getEffectiveMetadataAuthor());\n         assertSame(OTHERUSER_REFERENCE, document.getAuthors().getOriginalMetadataAuthor());\n+        assertEquals(!validToken, document.isRestricted());\n     }\n }",
    "function_modified_lines": {
      "added": [
        "import java.util.Map;\n",
        "\n",
        "import org.xwiki.csrf.CSRFToken;\n",
        "import static org.junit.jupiter.api.Assertions.assertEquals;\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. In affected versions it's possible to execute a content with the right of any user via a crafted URL. A user must have `programming` privileges in order to exploit this vulnerability. This issue has been patched in XWiki 14.10.7 and 15.2RC1. Users are advised to upgrade. There are no known workarounds for for this vulnerability.",
    "id": 12389
  },
  {
    "cve_id": "CVE-2023-37277",
    "code_before_change": "{\n    private String wikiName;\n\n    private List<String> spaces;\n\n    private String pageName;\n\n    private DocumentReference reference;\n\n    @Before\n    @Override\n    public void setUp() throws Exception\n    {\n        super.setUp();\n\n        this.wikiName = getWiki();\n        this.spaces = Arrays.asList(getTestClassName());\n        this.pageName = getTestMethodName();\n\n        this.reference = new DocumentReference(this.wikiName, this.spaces, this.pageName);\n\n        // Create a clean test page.\n        this.testUtils.rest().delete(this.reference);\n        this.testUtils.rest().savePage(this.reference);\n    }\n\n    @Override\n    @Test\n    public void testRepresentation() throws Exception\n    {\n        /* Everything is done in test methods */\n    }\n\n    @Test\n    public void testPOSTComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        Comment comment = objectFactory.createComment();\n        comment.setText(\"Comment\");\n\n        PostMethod postMethod = executePostXml(commentsUri, comment, TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(),\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlain() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testGETComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (Comment comment : comments.getComments()) {\n            checkLinks(comment);\n        }\n    }\n\n    @Test\n    public void testGETCommentsAtPreviousVersions() throws Exception\n    {\n        String pageHistoryUri = buildURI(PageHistoryResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(pageHistoryUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        History history = (History) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (HistorySummary historySummary : history.getHistorySummaries()) {\n            getMethod = executeGet(getFirstLinkByRelation(historySummary, Relations.PAGE).getHref());\n            Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n            Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n            if (getFirstLinkByRelation(page, Relations.COMMENTS) != null) {\n                getMethod = executeGet(getFirstLinkByRelation(page, Relations.COMMENTS).getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n            }\n        }\n    }\n\n    @Test\n    public void testPOSTCommentFormUrlEncoded() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        NameValuePair[] nameValuePairs = new NameValuePair[1];\n        nameValuePairs[0] = new NameValuePair(\"text\", \"Comment\");\n\n        PostMethod postMethod = executePostForm(commentsUri, nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n}",
    "code_after_change": "{\n    private String wikiName;\n\n    private List<String> spaces;\n\n    private String pageName;\n\n    private DocumentReference reference;\n\n    @Before\n    @Override\n    public void setUp() throws Exception\n    {\n        super.setUp();\n\n        this.wikiName = getWiki();\n        this.spaces = Arrays.asList(getTestClassName());\n        this.pageName = getTestMethodName();\n\n        this.reference = new DocumentReference(this.wikiName, this.spaces, this.pageName);\n\n        // Create a clean test page.\n        this.testUtils.rest().delete(this.reference);\n        this.testUtils.rest().savePage(this.reference);\n    }\n\n    @Override\n    @Test\n    public void testRepresentation() throws Exception\n    {\n        /* Everything is done in test methods */\n    }\n\n    @Test\n    public void testPOSTComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        Comment comment = objectFactory.createComment();\n        comment.setText(\"Comment\");\n\n        PostMethod postMethod = executePostXml(commentsUri, comment, TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(),\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlain() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments, comments.getComments().size());\n    }\n\n    @Test\n    public void testGETComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (Comment comment : comments.getComments()) {\n            checkLinks(comment);\n        }\n    }\n\n    @Test\n    public void testGETCommentsAtPreviousVersions() throws Exception\n    {\n        String pageHistoryUri = buildURI(PageHistoryResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(pageHistoryUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        History history = (History) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (HistorySummary historySummary : history.getHistorySummaries()) {\n            getMethod = executeGet(getFirstLinkByRelation(historySummary, Relations.PAGE).getHref());\n            Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n            Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n            if (getFirstLinkByRelation(page, Relations.COMMENTS) != null) {\n                getMethod = executeGet(getFirstLinkByRelation(page, Relations.COMMENTS).getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n            }\n        }\n    }\n\n    @Test\n    public void testPOSTCommentFormUrlEncoded() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        NameValuePair[] nameValuePairs = new NameValuePair[1];\n        nameValuePairs[0] = new NameValuePair(\"text\", \"Comment\");\n\n        PostMethod postMethod = executePostForm(commentsUri, nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n}",
    "patch": "@@ -128,6 +128,31 @@ public void testPOSTCommentWithTextPlain() throws Exception\n         Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n     }\n \n+    @Test\n+    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n+    {\n+        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n+\n+        GetMethod getMethod = executeGet(commentsUri);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+\n+        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+\n+        int numberOfComments = comments.getComments().size();\n+\n+        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n+            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n+        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n+        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n+\n+        getMethod = executeGet(commentsUri);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+\n+        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+\n+        Assert.assertEquals(numberOfComments, comments.getComments().size());\n+    }\n+\n     @Test\n     public void testGETComment() throws Exception\n     {",
    "function_modified_lines": {
      "added": [
        "    @Test\n",
        "    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n",
        "    {\n",
        "        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n",
        "\n",
        "        GetMethod getMethod = executeGet(commentsUri);\n",
        "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
        "\n",
        "        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
        "\n",
        "        int numberOfComments = comments.getComments().size();\n",
        "\n",
        "        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n",
        "            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n",
        "        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n",
        "        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n",
        "\n",
        "        getMethod = executeGet(commentsUri);\n",
        "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
        "\n",
        "        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
        "\n",
        "        Assert.assertEquals(numberOfComments, comments.getComments().size());\n",
        "    }\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The REST API allows executing all actions via POST requests and accepts `text/plain`, `multipart/form-data` or `application/www-form-urlencoded` as content types which can be sent via regular HTML forms, thus allowing cross-site request forgery. With the interaction of a user with programming rights, this allows remote code execution through script macros and thus impacts the integrity, availability and confidentiality of the whole XWiki installation. For regular cookie-based authentication, the vulnerability is mitigated by SameSite cookie restrictions but as of March 2023, these are not enabled by default in Firefox and Safari. The vulnerability has been patched in XWiki 14.10.8 and 15.2 by requiring a CSRF token header for certain request types that are susceptible to CSRF attacks.\n\n",
    "id": 12390
  },
  {
    "cve_id": "CVE-2023-37277",
    "code_before_change": "        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_ACCEPTED, postMethod.getStatusCode());\n\n        Object updatedObjectSummary = (Object) unmarshaller.unmarshal(postMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(updatedObjectSummary, \"tags\").getValue());\n        Assert.assertEquals(object.getClassName(), updatedObjectSummary.getClassName());\n        Assert.assertEquals(object.getNumber(), updatedObjectSummary.getNumber());\n    }\n\n    @Test\n    public void testPOSTObjectFormUrlEncoded() throws Exception\n    {\n        final String TAG_VALUE = \"TAG\";\n\n        NameValuePair[] nameValuePairs = new NameValuePair[2];\n        nameValuePairs[0] = new NameValuePair(\"className\", \"XWiki.TagClass\");\n        nameValuePairs[1] = new NameValuePair(\"property#tags\", TAG_VALUE);\n\n        PostMethod postMethod = executePostForm(\n            buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName).toString(), nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        Object object = (Object) unmarshaller.unmarshal(postMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(object, \"tags\").getValue());\n\n        GetMethod getMethod = executeGet(buildURI(ObjectResource.class, getWiki(), this.spaces, this.pageName,\n            object.getClassName(), object.getNumber()).toString());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        object = (Object) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(object, \"tags\").getValue());\n    }\n\n    @Test\n    public void testPUTPropertyFormUrlEncoded() throws Exception\n    {\n        final String TAG_VALUE = UUID.randomUUID().toString();\n\n        /* Make sure that an Object with the TagClass exists. */\n        createObjectIfDoesNotExists(\"XWiki.TagClass\", this.spaces, this.pageName);\n\n        GetMethod getMethod =\n            executeGet(buildURI(PageResource.class, getWiki(), this.spaces, this.pageName).toString());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n        Link link = getFirstLinkByRelation(page, Relations.OBJECTS);\n        Assert.assertNotNull(link);\n\n        getMethod = executeGet(link.getHref());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Objects objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertFalse(objects.getObjectSummaries().isEmpty());\n\n        Object currentObject = null;\n\n        for (ObjectSummary objectSummary : objects.getObjectSummaries()) {\n            if (objectSummary.getClassName().equals(\"XWiki.TagClass\")) {\n                link = getFirstLinkByRelation(objectSummary, Relations.OBJECT);\n                Assert.assertNotNull(link);\n                getMethod = executeGet(link.getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n                currentObject = (Object) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n                break;\n            }\n        }\n\n        Assert.assertNotNull(currentObject);",
    "code_after_change": "        Object updatedObjectSummary = (Object) unmarshaller.unmarshal(postMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(updatedObjectSummary, \"tags\").getValue());\n        Assert.assertEquals(object.getClassName(), updatedObjectSummary.getClassName());\n        Assert.assertEquals(object.getNumber(), updatedObjectSummary.getNumber());\n    }\n\n    @Test\n    public void testPOSTObjectFormUrlEncoded() throws Exception\n    {\n        final String TAG_VALUE = \"TAG\";\n\n        NameValuePair[] nameValuePairs = new NameValuePair[2];\n        nameValuePairs[0] = new NameValuePair(\"className\", \"XWiki.TagClass\");\n        nameValuePairs[1] = new NameValuePair(\"property#tags\", TAG_VALUE);\n\n        PostMethod postMethod = executePostForm(\n            buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName).toString(), nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        Object object = (Object) unmarshaller.unmarshal(postMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(object, \"tags\").getValue());\n\n        GetMethod getMethod = executeGet(buildURI(ObjectResource.class, getWiki(), this.spaces, this.pageName,\n            object.getClassName(), object.getNumber()).toString());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        object = (Object) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(TAG_VALUE, getProperty(object, \"tags\").getValue());\n    }\n\n    @Test\n    public void testPOSTObjectFormUrlEncodedNoCSRF() throws Exception\n    {\n        final String tagValue = \"TAG\";\n        NameValuePair[] nameValuePairs = new NameValuePair[2];\n        String className = \"XWiki.TagClass\";\n        nameValuePairs[0] = new NameValuePair(\"className\", className);\n        nameValuePairs[1] = new NameValuePair(\"property#tags\", tagValue);\n\n        String objectGetURI = buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName, className);\n\n        // Count objects before to ensure nothing is added on the failed request.\n        GetMethod getMethod = executeGet(objectGetURI);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n        Objects objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n        int numObjects = objects.getObjectSummaries().size();\n\n        PostMethod postMethod = executePostForm(\n            buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName), nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n\n        getMethod = executeGet(objectGetURI);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n        Assert.assertEquals(numObjects, objects.getObjectSummaries().size());\n    }\n\n\n    @Test\n    public void testPUTPropertyFormUrlEncoded() throws Exception\n    {\n        final String TAG_VALUE = UUID.randomUUID().toString();\n\n        /* Make sure that an Object with the TagClass exists. */\n        createObjectIfDoesNotExists(\"XWiki.TagClass\", this.spaces, this.pageName);\n\n        GetMethod getMethod =\n            executeGet(buildURI(PageResource.class, getWiki(), this.spaces, this.pageName).toString());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n        Link link = getFirstLinkByRelation(page, Relations.OBJECTS);\n        Assert.assertNotNull(link);\n\n        getMethod = executeGet(link.getHref());\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Objects objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertFalse(objects.getObjectSummaries().isEmpty());\n\n        Object currentObject = null;\n\n        for (ObjectSummary objectSummary : objects.getObjectSummaries()) {\n            if (objectSummary.getClassName().equals(\"XWiki.TagClass\")) {\n                link = getFirstLinkByRelation(objectSummary, Relations.OBJECT);\n                Assert.assertNotNull(link);\n                getMethod = executeGet(link.getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n                currentObject = (Object) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n                break;\n            }\n        }",
    "patch": "@@ -520,6 +520,37 @@ public void testPOSTObjectFormUrlEncoded() throws Exception\n         Assert.assertEquals(TAG_VALUE, getProperty(object, \"tags\").getValue());\n     }\n \n+    @Test\n+    public void testPOSTObjectFormUrlEncodedNoCSRF() throws Exception\n+    {\n+        final String tagValue = \"TAG\";\n+        NameValuePair[] nameValuePairs = new NameValuePair[2];\n+        String className = \"XWiki.TagClass\";\n+        nameValuePairs[0] = new NameValuePair(\"className\", className);\n+        nameValuePairs[1] = new NameValuePair(\"property#tags\", tagValue);\n+\n+        String objectGetURI = buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName, className);\n+\n+        // Count objects before to ensure nothing is added on the failed request.\n+        GetMethod getMethod = executeGet(objectGetURI);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+        Objects objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+        int numObjects = objects.getObjectSummaries().size();\n+\n+        PostMethod postMethod = executePostForm(\n+            buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName), nameValuePairs,\n+            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n+        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n+        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n+\n+        getMethod = executeGet(objectGetURI);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+\n+        objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+        Assert.assertEquals(numObjects, objects.getObjectSummaries().size());\n+    }\n+\n+\n     @Test\n     public void testPUTPropertyFormUrlEncoded() throws Exception\n     {",
    "function_modified_lines": {
      "added": [
        "    @Test\n",
        "    public void testPOSTObjectFormUrlEncodedNoCSRF() throws Exception\n",
        "    {\n",
        "        final String tagValue = \"TAG\";\n",
        "        NameValuePair[] nameValuePairs = new NameValuePair[2];\n",
        "        String className = \"XWiki.TagClass\";\n",
        "        nameValuePairs[0] = new NameValuePair(\"className\", className);\n",
        "        nameValuePairs[1] = new NameValuePair(\"property#tags\", tagValue);\n",
        "\n",
        "        String objectGetURI = buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName, className);\n",
        "\n",
        "        // Count objects before to ensure nothing is added on the failed request.\n",
        "        GetMethod getMethod = executeGet(objectGetURI);\n",
        "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
        "        Objects objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
        "        int numObjects = objects.getObjectSummaries().size();\n",
        "\n",
        "        PostMethod postMethod = executePostForm(\n",
        "            buildURI(ObjectsResource.class, getWiki(), this.spaces, this.pageName), nameValuePairs,\n",
        "            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n",
        "        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n",
        "        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n",
        "\n",
        "        getMethod = executeGet(objectGetURI);\n",
        "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
        "\n",
        "        objects = (Objects) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
        "        Assert.assertEquals(numObjects, objects.getObjectSummaries().size());\n",
        "    }\n",
        "\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The REST API allows executing all actions via POST requests and accepts `text/plain`, `multipart/form-data` or `application/www-form-urlencoded` as content types which can be sent via regular HTML forms, thus allowing cross-site request forgery. With the interaction of a user with programming rights, this allows remote code execution through script macros and thus impacts the integrity, availability and confidentiality of the whole XWiki installation. For regular cookie-based authentication, the vulnerability is mitigated by SameSite cookie restrictions but as of March 2023, these are not enabled by default in Firefox and Safari. The vulnerability has been patched in XWiki 14.10.8 and 15.2 by requiring a CSRF token header for certain request types that are susceptible to CSRF attacks.\n\n",
    "id": 12391
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    /**\n     * The name of the parent parameter.\n     */\n    private static final String PARENT = \"parent\";\n\n    /**\n     * The name of the space reference parameter.\n     */\n    private static final String SPACE_REFERENCE = \"spaceReference\";\n\n    /**\n     * The name parameter.\n     */\n    private static final String NAME = \"name\";\n\n    /**\n     * The name of the template field inside the template provider, or the template parameter which can be sent\n     * directly, without passing through the template provider.\n     */\n    private static final String TEMPLATE = \"template\";\n\n    /**\n     * Internal name for a flag determining if we are creating a Nested Space or a terminal document.\n     */\n    private static final String IS_SPACE = \"isSpace\";\n\n    /**\n     * Space homepage document name.\n     */\n    private static final String WEBHOME = \"WebHome\";\n\n    /**\n     * Local entity reference serializer hint.\n     */\n    private static final String LOCAL_SERIALIZER_HINT = \"local\";\n\n    /**\n     * The action to perform when creating a new page from a template.\n     *\n     * @version $Id$\n     */\n    private enum ActionOnCreate\n    {\n        /**\n         * Go to edit mode without saving.\n         */\n        EDIT(\"edit\"),\n\n        /**\n         * Save and then go to edit mode.\n         */\n        SAVE_AND_EDIT(\"saveandedit\"),\n\n        /**\n         * Save and then go to view mode.\n         */\n        SAVE_AND_VIEW(\"saveandview\");\n\n        private static final Map<String, ActionOnCreate> BY_ACTION = new HashMap<>();\n\n        static {\n            for (ActionOnCreate actionOnCreate : values()) {\n                BY_ACTION.put(actionOnCreate.action, actionOnCreate);\n            }\n        }\n\n        private final String action;\n\n        ActionOnCreate(String action)\n        {\n            this.action = action;\n        }\n\n        public static ActionOnCreate valueOfAction(String action)",
    "code_after_change": "     */\n    private static final String PARENT = \"parent\";\n\n    /**\n     * The name of the space reference parameter.\n     */\n    private static final String SPACE_REFERENCE = \"spaceReference\";\n\n    /**\n     * The name parameter.\n     */\n    private static final String NAME = \"name\";\n\n    /**\n     * The name of the template field inside the template provider, or the template parameter which can be sent\n     * directly, without passing through the template provider.\n     */\n    private static final String TEMPLATE = \"template\";\n\n    /**\n     * Internal name for a flag determining if we are creating a Nested Space or a terminal document.\n     */\n    private static final String IS_SPACE = \"isSpace\";\n\n    /**\n     * Space homepage document name.\n     */\n    private static final String WEBHOME = \"WebHome\";\n\n    /**\n     * Local entity reference serializer hint.\n     */\n    private static final String LOCAL_SERIALIZER_HINT = \"local\";\n\n    @Inject\n    private CSRFToken csrf;\n\n    /**\n     * The action to perform when creating a new page from a template.\n     *\n     * @version $Id$\n     */\n    private enum ActionOnCreate\n    {\n        /**\n         * Go to edit mode without saving.\n         */\n        EDIT(\"edit\"),\n\n        /**\n         * Save and then go to edit mode.\n         */\n        SAVE_AND_EDIT(\"saveandedit\"),\n\n        /**\n         * Save and then go to view mode.\n         */\n        SAVE_AND_VIEW(\"saveandview\");\n\n        private static final Map<String, ActionOnCreate> BY_ACTION = new HashMap<>();\n\n        static {\n            for (ActionOnCreate actionOnCreate : values()) {\n                BY_ACTION.put(actionOnCreate.action, actionOnCreate);\n            }\n        }\n\n        private final String action;\n\n        ActionOnCreate(String action)\n        {\n            this.action = action;\n        }",
    "patch": "@@ -23,6 +23,7 @@\n import java.util.Locale;\n import java.util.Map;\n \n+import javax.inject.Inject;\n import javax.inject.Named;\n import javax.inject.Provider;\n import javax.inject.Singleton;\n@@ -96,6 +97,9 @@ public class CreateAction extends XWikiAction\n      */\n     private static final String LOCAL_SERIALIZER_HINT = \"local\";\n \n+    @Inject\n+    private CSRFToken csrf;\n+\n     /**\n      * The action to perform when creating a new page from a template.\n      *\n@@ -185,9 +189,12 @@ public String render(XWikiContext context) throws XWikiException\n         checkRights(newDocumentReference.getLastSpaceReference(), context);\n \n         // Check if the document to create already exists and if it respects the name strategy\n+        // Also check the CSRF token.\n         XWikiDocument newDocument = context.getWiki().getDocument(newDocumentReference, context);\n         if (handler.isDocumentAlreadyExisting(newDocument) || handler.isDocumentPathTooLong(newDocumentReference)\n-            || !this.isEntityReferenceNameValid(newDocumentReference)) {\n+            || !this.isEntityReferenceNameValid(newDocumentReference)\n+            || !this.csrf.isTokenValid(context.getRequest().getParameter(\"form_token\")))\n+        {\n             return CREATE_TEMPLATE;\n         }\n \n@@ -334,8 +341,7 @@ private String getRedirectParameters(String parent, String title, String templat\n             redirectParams += \"&title=\" + Util.encodeURI(title, null);\n         }\n         // Both the save and the edit action might require a CSRF token\n-        CSRFToken csrf = Utils.getComponent(CSRFToken.class);\n-        redirectParams += \"&form_token=\" + Util.encodeURI(csrf.getToken(), null);\n+        redirectParams += \"&form_token=\" + Util.encodeURI(this.csrf.getToken(), null);\n \n         return redirectParams;\n     }",
    "function_modified_lines": {
      "added": [
        "    @Inject\n",
        "    private CSRFToken csrf;\n",
        "\n"
      ],
      "deleted": []
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12431
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    Query mockTemplateProvidersQuery;\n\n    @BeforeEach\n    public void beforeEach() throws Exception\n    {\n        this.context = this.oldcore.getXWikiContext();\n\n        Utils.setComponentManager(this.oldcore.getMocker());\n\n        QueryManager mockSecureQueryManager =\n            this.oldcore.getMocker().registerMockComponent((Type) QueryManager.class, \"secure\");\n\n        this.mockTemplateProvidersQuery = mock(Query.class);\n        when(mockSecureQueryManager.createQuery(any(), any())).thenReturn(this.mockTemplateProvidersQuery);\n        when(this.mockTemplateProvidersQuery.execute()).thenReturn(Collections.emptyList());\n\n        when(this.oldcore.getMockContextualAuthorizationManager().hasAccess(any(Right.class),\n            any(EntityReference.class))).thenReturn(true);\n\n        Provider<DocumentReference> mockDocumentReferenceProvider =\n            this.oldcore.getMocker().registerMockComponent(DocumentReference.TYPE_PROVIDER);\n        when(mockDocumentReferenceProvider.get())\n            .thenReturn(new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\"));\n\n        this.mockURLFactory = mock(XWikiURLFactory.class);\n        this.context.setURLFactory(this.mockURLFactory);\n\n        this.mockRequest = mock(XWikiRequest.class);\n        this.context.setRequest(this.mockRequest);\n\n        this.mockResponse = mock(XWikiResponse.class);\n        this.context.setResponse(this.mockResponse);\n\n        when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n\n        this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n    }\n\n    @Test\n    void newDocumentFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentButNonTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token432\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Pass the tocreate=nonterminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLWhenNoType() throws Exception\n    {\n        // No type has been set by the user\n        when(mockRequest.get(\"type\")).thenReturn(null);\n\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertEquals(\"create\", result);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "code_after_change": "    @BeforeEach\n    public void beforeEach() throws Exception\n    {\n        this.context = this.oldcore.getXWikiContext();\n\n        Utils.setComponentManager(this.oldcore.getMocker());\n\n        QueryManager mockSecureQueryManager =\n            this.oldcore.getMocker().registerMockComponent((Type) QueryManager.class, \"secure\");\n\n        this.mockTemplateProvidersQuery = mock(Query.class);\n        when(mockSecureQueryManager.createQuery(any(), any())).thenReturn(this.mockTemplateProvidersQuery);\n        when(this.mockTemplateProvidersQuery.execute()).thenReturn(Collections.emptyList());\n\n        when(this.oldcore.getMockContextualAuthorizationManager().hasAccess(any(Right.class),\n            any(EntityReference.class))).thenReturn(true);\n\n        Provider<DocumentReference> mockDocumentReferenceProvider =\n            this.oldcore.getMocker().registerMockComponent(DocumentReference.TYPE_PROVIDER);\n        when(mockDocumentReferenceProvider.get())\n            .thenReturn(new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\"));\n\n        this.mockURLFactory = mock(XWikiURLFactory.class);\n        this.context.setURLFactory(this.mockURLFactory);\n\n        this.mockRequest = mock(XWikiRequest.class);\n        this.context.setRequest(this.mockRequest);\n\n        this.mockResponse = mock(XWikiResponse.class);\n        this.context.setResponse(this.mockResponse);\n\n        when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n\n        this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n\n        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n    }\n\n    @Test\n    void newDocumentFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentFromURLWithInvalidToken() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        this.context.setDoc(document);\n\n        // Submit an invalid token\n        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n\n        // Run the action\n        String result = this.action.render(this.context);\n\n        // The tests are below this line!\n\n        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n        // form token.\n        assertEquals(\"create\", result);\n\n        // Verify that we got until the token validation.\n        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n            any(XWikiContext.class));\n    }\n\n    @Test\n    void newDocumentButNonTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Pass the tocreate=nonterminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Verify that the token has been validated.\n        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLWhenNoType() throws Exception\n    {\n        // No type has been set by the user\n        when(mockRequest.get(\"type\")).thenReturn(null);\n\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertEquals(\"create\", result);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "\n",
        "        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n",
        "        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n",
        "        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n",
        "    @Test\n",
        "    void newDocumentFromURLWithInvalidToken() throws Exception\n",
        "    {\n",
        "        // new document = xwiki:X.Y\n",
        "        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n",
        "        XWikiDocument document = mock(XWikiDocument.class);\n",
        "        when(document.getDocumentReference()).thenReturn(documentReference);\n",
        "        when(document.isNew()).thenReturn(true);\n",
        "        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n",
        "        this.context.setDoc(document);\n",
        "\n",
        "        // Submit an invalid token\n",
        "        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n",
        "\n",
        "        // Run the action\n",
        "        String result = this.action.render(this.context);\n",
        "\n",
        "        // The tests are below this line!\n",
        "\n",
        "        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n",
        "        // form token.\n",
        "        assertEquals(\"create\", result);\n",
        "\n",
        "        // Verify that we got until the token validation.\n",
        "        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n",
        "\n",
        "        // We should not get this far so no redirect should be done, just the template will be rendered.\n",
        "        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n",
        "            any(XWikiContext.class));\n",
        "    }\n",
        "\n",
        "        // Verify that the token has been validated.\n",
        "        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n",
        "\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n"
      ],
      "deleted": [
        "        String csrfTokenValue = \"token42\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token432\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12432
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "\n    @Test\n    void newDocumentFromURLWhenNoType() throws Exception\n    {\n        // No type has been set by the user\n        when(mockRequest.get(\"type\")).thenReturn(null);\n\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertEquals(\"create\", result);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4234\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token34342\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n        // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeButTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4234343\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Pass the tocreate=terminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelSpaceButTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Pass the tocreate=terminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // Note: We can not create the \"X\" terminal document, since it is already at the top level of the hierarchy and\n        // none was able to be deducted from the given information. The user needs to specify more info in order to\n        // continue.\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUINoName() throws Exception\n    {\n        // current document = xwiki:Main.WebHome",
    "code_after_change": "            \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLWhenNoType() throws Exception\n    {\n        // No type has been set by the user\n        when(mockRequest.get(\"type\")).thenReturn(null);\n\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertEquals(\"create\", result);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n        // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeButTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Pass the tocreate=terminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void newDocumentWebHomeTopLevelSpaceButTerminalFromURL() throws Exception\n    {\n        // new document = xwiki:X.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Pass the tocreate=terminal request parameter\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // Note: We can not create the \"X\" terminal document, since it is already at the top level of the hierarchy and\n        // none was able to be deducted from the given information. The user needs to specify more info in order to\n        // continue.\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUINoName() throws Exception\n    {\n        // current document = xwiki:Main.WebHome",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "        String csrfTokenValue = \"token4234\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token34342\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n",
        "        String csrfTokenValue = \"token4234343\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12433
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424345\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42124343\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424334466\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");",
    "code_after_change": "        // The tests are below this line!\n\n        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n",
        "        String csrfTokenValue = \"token42124343\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12434
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42124343\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424334466\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token429988\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");",
    "code_after_change": "        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n",
        "        String csrfTokenValue = \"token424334466\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12435
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424334466\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token429988\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUIButAlreadyExisting() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        // Mock it as existing in the DB as well with non-empty content\n        oldcore.getDocuments().put(new DocumentReference(documentReference, Locale.ROOT), document);\n        when(document.getContent()).thenReturn(\"Some non-empty content\");\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        // No diference if it was a non-terminal document, just easier to mock since we already have Main.WebHome set",
    "code_after_change": "        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUIButAlreadyExisting() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        // Mock it as existing in the DB as well with non-empty content\n        oldcore.getDocuments().put(new DocumentReference(documentReference, Locale.ROOT), document);\n        when(document.getContent()).thenReturn(\"Some non-empty content\");\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        // No diference if it was a non-terminal document, just easier to mock since we already have Main.WebHome set\n        // up.\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"Main\");",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token429988\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12436
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "{\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42009\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI name=Y\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }",
    "code_after_change": "{\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI name=Y\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "        String csrfTokenValue = \"token42009\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n",
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12437
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "            context);\n    }\n\n    /*\n     * Deprecated parameters\n     */\n\n    @Test\n    void existingDocumentFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4233311\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&page=Y\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token422112455\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42778900\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");",
    "code_after_change": "        verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    /*\n     * Deprecated parameters\n     */\n\n    @Test\n    void existingDocumentFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&page=Y\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token422112455\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12438
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token422112455\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42778900\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4344119982\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");",
    "code_after_change": "        assertNull(result);\n\n        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token42778900\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12439
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42778900\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4344119982\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n        // parameter is ignored.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token425553\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X.Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");",
    "code_after_change": "        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n        // parameter is ignored.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X.Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token4344119982\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12440
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4344119982\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n        // parameter is ignored.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token425553\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X.Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    /*\n     * Template providers\n     */\n\n    @Test\n    void existingDocumentFromUITemplateProviderExistingButNoneSelected() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y",
    "code_after_change": "\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n        // parameter is ignored.\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X.Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    /*\n     * Template providers\n     */\n\n    @Test\n    void existingDocumentFromUITemplateProviderExistingButNoneSelected() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
      ],
      "deleted": [
        "            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
        "        String csrfTokenValue = \"token425553\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12441
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42988733\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4222113555\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "code_after_change": "        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token4222113555\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12442
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4222113555\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4200983331\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42234456\";",
    "code_after_change": "    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token4200983331\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12443
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4200983331\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42234456\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n",
    "code_after_change": "            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token42234456\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12444
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42234456\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n        String csrfTokenValue = \"token4298833\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n        String templateDocumentFullName = \"XWiki.MyTemplate\";\n        DocumentReference templateDocumentReference =\n            new DocumentReference(\"MyTemplate\", Arrays.asList(\"XWiki\"), \"xwiki\");\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"template\")).thenReturn(\"XWiki.MyTemplate\");\n\n        // Mock the passed template document as existing.\n        mockTemplateDocumentExisting(templateDocumentFullName, templateDocumentReference);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome and using the template specified in the request.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "code_after_change": "    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n        String templateDocumentFullName = \"XWiki.MyTemplate\";\n        DocumentReference templateDocumentReference =\n            new DocumentReference(\"MyTemplate\", Arrays.asList(\"XWiki\"), \"xwiki\");\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"template\")).thenReturn(\"XWiki.MyTemplate\");\n\n        // Mock the passed template document as existing.\n        mockTemplateDocumentExisting(templateDocumentFullName, templateDocumentReference);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome and using the template specified in the request.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token4298833\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12445
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n        String csrfTokenValue = \"token4298833\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n        String templateDocumentFullName = \"XWiki.MyTemplate\";\n        DocumentReference templateDocumentReference =\n            new DocumentReference(\"MyTemplate\", Arrays.asList(\"XWiki\"), \"xwiki\");\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"template\")).thenReturn(\"XWiki.MyTemplate\");\n\n        // Mock the passed template document as existing.\n        mockTemplateDocumentExisting(templateDocumentFullName, templateDocumentReference);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome and using the template specified in the request.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4244112\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);",
    "code_after_change": "\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n        String templateDocumentFullName = \"XWiki.MyTemplate\";\n        DocumentReference templateDocumentReference =\n            new DocumentReference(\"MyTemplate\", Arrays.asList(\"XWiki\"), \"xwiki\");\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"template\")).thenReturn(\"XWiki.MyTemplate\");\n\n        // Mock the passed template document as existing.\n        mockTemplateDocumentExisting(templateDocumentFullName, templateDocumentReference);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome and using the template specified in the request.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token4244112\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12446
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4244112\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token422555987\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);",
    "code_after_change": "    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token422555987\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12447
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token422555987\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424111553\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n        // template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);",
    "code_after_change": "    void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n        // template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token424111553\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12448
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424111553\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n        // template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42008733\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);",
    "code_after_change": "    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n        // template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        String spaceReferenceString = \"X\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(spaceReferenceString);\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider that creates terminal documents.\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token42008733\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12449
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token423366\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal, since the template provider did not specify a \"terminal\"\n        // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverriddenFromUIToNonTerminal()\n        throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4265677398\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, since even if the template provider did not\n        // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n        // document. Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);",
    "code_after_change": "    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal, since the template provider did not specify a \"terminal\"\n        // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverriddenFromUIToNonTerminal()\n        throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, since even if the template provider did not\n        // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n        // document. Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token4265677398\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12451
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "        throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4265677398\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, since even if the template provider did not\n        // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n        // document. Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token421198337\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);",
    "code_after_change": "    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverriddenFromUIToNonTerminal()\n        throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"page\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal, since even if the template provider did not\n        // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n        // document. Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token421198337\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12452
  },
  {
    "cve_id": "CVE-2023-40572",
    "code_before_change": "    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token421198337\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token429866333\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n        // compatibility resolutions. Also using the template extracted from the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedWithSaveAndEdit() throws Exception\n    {\n        // Mock the document to create.\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.getDocumentReferenceWithLocale()).thenReturn(documentReference);",
    "code_after_change": "    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n        // compatibility resolutions. Also using the template extracted from the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedWithSaveAndEdit() throws Exception\n    {\n        // Mock the document to create.\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.getDocumentReferenceWithLocale()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);",
    "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
    "function_modified_lines": {
      "added": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
      ],
      "deleted": [
        "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
        "        String csrfTokenValue = \"token429866333\";\n",
        "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
      ]
    },
    "lang": "Java",
    "cwe": [
      "CWE-352"
    ],
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
    "id": 12453
  }
]