[
    {
        "cve_id": "CVE-2013-7251",
        "code_before_change": "{\n  private static final long serialVersionUID = -203572415793301622L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(TaskTreeForm.class);\n\n  private TaskFilter searchFilter;\n\n  private MyComponentsRepeater<Component> actionButtons;\n\n  private SingleButtonPanel cancelButtonPanel;\n\n  private SingleButtonPanel resetButtonPanel;\n\n  private SingleButtonPanel listViewButtonPanel;\n\n  private SingleButtonPanel searchButtonPanel;\n\n  protected GridBuilder gridBuilder;\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    super.init();\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"searchFilter\"));\n      final TextField<String> searchField = new TextField<String>(InputPanel.WICKET_ID, new PropertyModel<String>(getSearchFilter(),\n          \"searchString\"));\n      searchField.add(WicketUtils.setFocus());\n      fs.add(new InputPanel(fs.newChildId(), searchField));\n      fs.add(new IconPanel(fs.newIconChildId(), IconType.HELP, getString(\"tooltip.lucene.link\")).setOnClickLocation(getRequestCycle(),\n          WebConstants.DOC_LINK_HANDBUCH_LUCENE, true), FieldSetIconPosition.TOP_RIGHT);\n    }\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"label.options\")).suppressLabelForWarning();\n      final DivPanel checkBoxPanel = fs.addNewCheckBoxDiv();\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"notOpened\"),\n          getString(\"task.status.notOpened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"opened\"),\n          getString(\"task.status.opened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"closed\"),\n          getString(\"task.status.closed\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"deleted\"),\n          getString(\"deleted\")));\n    }\n\n    actionButtons = new MyComponentsRepeater<Component>(\"actionButtons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button cancelButton = new Button(\"button\", new Model<String>(\"cancel\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onCancelSubmit();\n        }\n      };\n      cancelButton.setDefaultFormProcessing(false);\n      cancelButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), cancelButton, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      actionButtons.add(cancelButtonPanel);\n    }\n    {\n      final Button resetButton = new Button(\"button\", new Model<String>(\"reset\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onResetSubmit();\n        }\n      };\n      resetButton.setDefaultFormProcessing(false);\n      resetButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), resetButton, getString(\"reset\"), SingleButtonPanel.RESET);\n      actionButtons.add(resetButtonPanel);\n    }\n    {\n      final Button listViewButton = new Button(\"button\", new Model<String>(\"listView\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onListViewSubmit();\n        }\n      };\n\n      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"), SingleButtonPanel.NORMAL);\n      actionButtons.add(listViewButtonPanel);\n    }\n    {\n      final Button searchButton = new Button(\"button\", new Model<String>(\"search\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onSearchSubmit();\n        }\n      };\n      searchButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), searchButton, getString(\"search\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(searchButtonPanel);\n      setDefaultButton(searchButton);\n    }\n    setComponentsVisibility();\n  }\n\n  public TaskTreeForm(final TaskTreePage parentPage)\n  {\n    super(parentPage);\n  }\n\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n\n  protected void setComponentsVisibility()\n  {\n    if (parentPage.isSelectMode() == false) {\n      // Show cancel button only in select mode.\n      cancelButtonPanel.setVisible(false);\n    }\n    searchButtonPanel.setVisible(true);\n    resetButtonPanel.setVisible(true);\n  }\n\n  public TaskFilter getSearchFilter()\n  {\n    if (this.searchFilter == null) {\n      final Object filter = getParentPage().getUserPrefEntry(TaskListForm.class.getName() + \":Filter\");\n      if (filter != null) {\n        try {\n          this.searchFilter = (TaskFilter) filter;\n        } catch (final ClassCastException ex) {\n          // Probably a new software release results in an incompability of old and new filter format.\n          log.info(\"Could not restore filter from user prefs: (old) filter type \"\n              + filter.getClass().getName()\n              + \" is not assignable to (new) filter type TaskFilter (OK, probably new software release).\");\n        }\n      }\n    }\n    if (this.searchFilter == null) {\n      this.searchFilter = new TaskFilter();\n      getParentPage().putUserPrefEntry(TaskListForm.class.getName() + \":Filter\", this.searchFilter, true);\n    }\n    return this.searchFilter;\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    parentPage.refresh();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class MyCheckBoxPanel extends CheckBoxPanel\n  {\n    public MyCheckBoxPanel(final String id, final IModel<Boolean> model, final String labelString)\n    {\n      super(id, model, labelString);\n    }\n\n    @Override\n    protected boolean wantOnSelectionChangedNotifications()\n    {\n      return true;\n    }\n\n    @Override\n    protected void onSelectionChanged(final Boolean newSelection)\n    {\n      parentPage.refresh();\n    }\n  }\n}",
        "code_after_change": "{\n  private static final long serialVersionUID = -203572415793301622L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(TaskTreeForm.class);\n\n  private TaskFilter searchFilter;\n\n  private MyComponentsRepeater<Component> actionButtons;\n\n  private SingleButtonPanel cancelButtonPanel;\n\n  private SingleButtonPanel resetButtonPanel;\n\n  private SingleButtonPanel listViewButtonPanel;\n\n  private SingleButtonPanel searchButtonPanel;\n\n  protected GridBuilder gridBuilder;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  @Override\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    super.init();\n    add(createFeedbackPanel());\n    gridBuilder = newGridBuilder(this, \"flowform\");\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"searchFilter\"));\n      final TextField<String> searchField = new TextField<String>(InputPanel.WICKET_ID, new PropertyModel<String>(getSearchFilter(),\n          \"searchString\"));\n      searchField.add(WicketUtils.setFocus());\n      fs.add(new InputPanel(fs.newChildId(), searchField));\n      fs.add(new IconPanel(fs.newIconChildId(), IconType.HELP, getString(\"tooltip.lucene.link\")).setOnClickLocation(getRequestCycle(),\n          WebConstants.DOC_LINK_HANDBUCH_LUCENE, true), FieldSetIconPosition.TOP_RIGHT);\n    }\n    {\n      gridBuilder.newSplitPanel(GridSize.COL50);\n      final FieldsetPanel fs = gridBuilder.newFieldset(getString(\"label.options\")).suppressLabelForWarning();\n      final DivPanel checkBoxPanel = fs.addNewCheckBoxDiv();\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"notOpened\"),\n          getString(\"task.status.notOpened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"opened\"),\n          getString(\"task.status.opened\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"closed\"),\n          getString(\"task.status.closed\")));\n      checkBoxPanel.add(new MyCheckBoxPanel(checkBoxPanel.newChildId(), new PropertyModel<Boolean>(getSearchFilter(), \"deleted\"),\n          getString(\"deleted\")));\n    }\n\n    actionButtons = new MyComponentsRepeater<Component>(\"actionButtons\");\n    add(actionButtons.getRepeatingView());\n    {\n      final Button cancelButton = new Button(\"button\", new Model<String>(\"cancel\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onCancelSubmit();\n        }\n      };\n      cancelButton.setDefaultFormProcessing(false);\n      cancelButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), cancelButton, getString(\"cancel\"), SingleButtonPanel.CANCEL);\n      actionButtons.add(cancelButtonPanel);\n    }\n    {\n      final Button resetButton = new Button(\"button\", new Model<String>(\"reset\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onResetSubmit();\n        }\n      };\n      resetButton.setDefaultFormProcessing(false);\n      resetButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), resetButton, getString(\"reset\"), SingleButtonPanel.RESET);\n      actionButtons.add(resetButtonPanel);\n    }\n    {\n      final Button listViewButton = new Button(\"button\", new Model<String>(\"listView\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onListViewSubmit();\n        }\n      };\n\n      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"),\n          SingleButtonPanel.NORMAL);\n      actionButtons.add(listViewButtonPanel);\n    }\n    {\n      final Button searchButton = new Button(\"button\", new Model<String>(\"search\")) {\n        @Override\n        public final void onSubmit()\n        {\n          getParentPage().onSearchSubmit();\n        }\n      };\n      searchButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), searchButton, getString(\"search\"),\n          SingleButtonPanel.DEFAULT_SUBMIT);\n      actionButtons.add(searchButtonPanel);\n      setDefaultButton(searchButton);\n    }\n    setComponentsVisibility();\n  }\n\n  public TaskTreeForm(final TaskTreePage parentPage)\n  {\n    super(parentPage);\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  public void onBeforeRender()\n  {\n    super.onBeforeRender();\n    actionButtons.render();\n  }\n\n  protected void setComponentsVisibility()\n  {\n    if (parentPage.isSelectMode() == false) {\n      // Show cancel button only in select mode.\n      cancelButtonPanel.setVisible(false);\n    }\n    searchButtonPanel.setVisible(true);\n    resetButtonPanel.setVisible(true);\n  }\n\n  public TaskFilter getSearchFilter()\n  {\n    if (this.searchFilter == null) {\n      final Object filter = getParentPage().getUserPrefEntry(TaskListForm.class.getName() + \":Filter\");\n      if (filter != null) {\n        try {\n          this.searchFilter = (TaskFilter) filter;\n        } catch (final ClassCastException ex) {\n          // Probably a new software release results in an incompability of old and new filter format.\n          log.info(\"Could not restore filter from user prefs: (old) filter type \"\n              + filter.getClass().getName()\n              + \" is not assignable to (new) filter type TaskFilter (OK, probably new software release).\");\n        }\n      }\n    }\n    if (this.searchFilter == null) {\n      this.searchFilter = new TaskFilter();\n      getParentPage().putUserPrefEntry(TaskListForm.class.getName() + \":Filter\", this.searchFilter, true);\n    }\n    return this.searchFilter;\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n    parentPage.refresh();\n  }\n\n  @SuppressWarnings(\"serial\")\n  private class MyCheckBoxPanel extends CheckBoxPanel\n  {\n    public MyCheckBoxPanel(final String id, final IModel<Boolean> model, final String labelString)\n    {\n      super(id, model, labelString);\n    }\n\n    @Override\n    protected boolean wantOnSelectionChangedNotifications()\n    {\n      return true;\n    }\n\n    @Override\n    protected void onSelectionChanged(final Boolean newSelection)\n    {\n      parentPage.refresh();\n    }\n  }\n}",
        "patch": "@@ -31,6 +31,7 @@\n import org.apache.wicket.model.PropertyModel;\n import org.projectforge.task.TaskFilter;\n import org.projectforge.web.wicket.AbstractForm;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.WebConstants;\n import org.projectforge.web.wicket.WicketUtils;\n import org.projectforge.web.wicket.bootstrap.GridBuilder;\n@@ -65,6 +66,11 @@ public class TaskTreeForm extends AbstractForm<TaskFilter, TaskTreePage>\n \n   protected GridBuilder gridBuilder;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   @Override\n   @SuppressWarnings(\"serial\")\n   protected void init()\n@@ -131,7 +137,8 @@ public final void onSubmit()\n         }\n       };\n \n-      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"), SingleButtonPanel.NORMAL);\n+      listViewButtonPanel = new SingleButtonPanel(actionButtons.newChildId(), listViewButton, getString(\"listView\"),\n+          SingleButtonPanel.NORMAL);\n       actionButtons.add(listViewButtonPanel);\n     }\n     {\n@@ -153,6 +160,7 @@ public final void onSubmit()\n   public TaskTreeForm(final TaskTreePage parentPage)\n   {\n     super(parentPage);\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n   }\n \n   @Override\n@@ -198,6 +206,7 @@ public TaskFilter getSearchFilter()\n   protected void onSubmit()\n   {\n     super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n     parentPage.refresh();\n   }\n ",
        "function_modified_lines": {
            "added": [
                "  /**\n",
                "   * Cross site request forgery token.\n",
                "   */\n",
                "  private final CsrfTokenHandler csrfTokenHandler;\n",
                "\n"
            ],
            "deleted": []
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
        "id": 11971
    },
    {
        "cve_id": "CVE-2013-7251",
        "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.SubmitLink;\nimport org.apache.wicket.markup.html.panel.FeedbackPanel;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.projectforge.core.AbstractBaseDO;\nimport org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n\npublic abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\nAbstractMobileForm<O, P>\n{\n  private static final long serialVersionUID = 1836099012618517190L;\n\n  protected O data;\n\n  protected MobileGridBuilder gridBuilder;\n\n  public AbstractMobileEditForm(final P parentPage, final O data)\n  {\n    super(parentPage);\n    this.data = data;\n  }\n\n  public O getData()\n  {\n    return this.data;\n  }\n\n  public void setData(final O data)\n  {\n    this.data = data;\n  }\n\n  public boolean isNew()\n  {\n    return this.data == null || this.data.getId() == null;\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(new FeedbackPanel(\"feedback\").setOutputMarkupId(true));\n    final SubmitLink submitButton = new SubmitLink(\"submitButton\") {\n      @Override\n      public final void onSubmit()\n      {\n        parentPage.save();\n      }\n    };\n    final RepeatingView flowform = new RepeatingView(\"flowform\");\n    add(flowform);\n    gridBuilder = newGridBuilder(flowform);\n\n    add(submitButton);\n    if (isNew() == true) {\n      submitButton.add(new Label(\"label\", getString(\"create\")));\n    } else {\n      submitButton.add(new Label(\"label\", getString(\"update\")));\n    }\n  }\n}\n",
        "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.mobile;\n\nimport org.apache.wicket.markup.html.basic.Label;\nimport org.apache.wicket.markup.html.form.SubmitLink;\nimport org.apache.wicket.markup.html.panel.FeedbackPanel;\nimport org.apache.wicket.markup.repeater.RepeatingView;\nimport org.projectforge.core.AbstractBaseDO;\nimport org.projectforge.web.wicket.CsrfTokenHandler;\nimport org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n\npublic abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\nAbstractMobileForm<O, P>\n{\n  private static final long serialVersionUID = 1836099012618517190L;\n\n  protected O data;\n\n  protected MobileGridBuilder gridBuilder;\n\n  /**\n   * Cross site request forgery token.\n   */\n  private final CsrfTokenHandler csrfTokenHandler;\n\n  public AbstractMobileEditForm(final P parentPage, final O data)\n  {\n    super(parentPage);\n    this.data = data;\n    csrfTokenHandler = new CsrfTokenHandler(this);\n  }\n\n  @Override\n  protected void onSubmit()\n  {\n    super.onSubmit();\n    csrfTokenHandler.onSubmit();\n  }\n\n  public O getData()\n  {\n    return this.data;\n  }\n\n  public void setData(final O data)\n  {\n    this.data = data;\n  }\n\n  public boolean isNew()\n  {\n    return this.data == null || this.data.getId() == null;\n  }\n\n  @SuppressWarnings(\"serial\")\n  protected void init()\n  {\n    add(new FeedbackPanel(\"feedback\").setOutputMarkupId(true));\n    final SubmitLink submitButton = new SubmitLink(\"submitButton\") {\n      @Override\n      public final void onSubmit()\n      {\n        parentPage.save();\n      }\n    };\n    final RepeatingView flowform = new RepeatingView(\"flowform\");\n    add(flowform);\n    gridBuilder = newGridBuilder(flowform);\n\n    add(submitButton);\n    if (isNew() == true) {\n      submitButton.add(new Label(\"label\", getString(\"create\")));\n    } else {\n      submitButton.add(new Label(\"label\", getString(\"update\")));\n    }\n  }\n}\n",
        "patch": "@@ -28,6 +28,7 @@\n import org.apache.wicket.markup.html.panel.FeedbackPanel;\n import org.apache.wicket.markup.repeater.RepeatingView;\n import org.projectforge.core.AbstractBaseDO;\n+import org.projectforge.web.wicket.CsrfTokenHandler;\n import org.projectforge.web.wicket.mobileflowlayout.MobileGridBuilder;\n \n public abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P extends AbstractMobileEditPage< ? , ? , ? >> extends\n@@ -39,10 +40,23 @@ public abstract class AbstractMobileEditForm<O extends AbstractBaseDO< ? >, P ex\n \n   protected MobileGridBuilder gridBuilder;\n \n+  /**\n+   * Cross site request forgery token.\n+   */\n+  private final CsrfTokenHandler csrfTokenHandler;\n+\n   public AbstractMobileEditForm(final P parentPage, final O data)\n   {\n     super(parentPage);\n     this.data = data;\n+    csrfTokenHandler = new CsrfTokenHandler(this);\n+  }\n+\n+  @Override\n+  protected void onSubmit()\n+  {\n+    super.onSubmit();\n+    csrfTokenHandler.onSubmit();\n   }\n \n   public O getData()",
        "function_modified_lines": {
            "added": [
                "import org.projectforge.web.wicket.CsrfTokenHandler;\n",
                "  /**\n",
                "   * Cross site request forgery token.\n",
                "   */\n",
                "  private final CsrfTokenHandler csrfTokenHandler;\n",
                "\n",
                "    csrfTokenHandler = new CsrfTokenHandler(this);\n",
                "  }\n",
                "\n",
                "  @Override\n",
                "  protected void onSubmit()\n",
                "  {\n",
                "    super.onSubmit();\n",
                "    csrfTokenHandler.onSubmit();\n"
            ],
            "deleted": []
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
        "id": 11969
    },
    {
        "cve_id": "CVE-2013-7251",
        "code_before_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket;\n\nimport java.io.Serializable;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.Session;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.HiddenField;\nimport org.apache.wicket.model.Model;\nimport org.projectforge.core.InternalErrorException;\n\n/**\n * Every form should use this handler for preventing cross site request forgery attacks.\n * @author Kai Reinhard (k.reinhard@micromata.de)\n * \n */\npublic class CsrfTokenHandler implements Serializable\n{\n  private static final long serialVersionUID = -9129345307409567900L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n\n  private HiddenField<String> csrfTokenField;\n\n  /**\n   * The given form should contain a hidden field named 'csrfToken'.\n   * @param form\n   */\n  public CsrfTokenHandler(final Form< ? > form)\n  {\n    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n  }\n\n  /**\n   * This parameter should be set as hidden field in every formular and should be tested on every submit action for preventing CSRF attacks.\n   * @return the randomized cross site request forgery token.\n   */\n  private String getCsrfSessionToken()\n  {\n    final MySession session = (MySession) Session.get();\n    return session.getCsrfToken();\n  }\n\n  /**\n   * Checks the cross site request forgery token (as posted hidden field) and if it doesn't match an exception is thrown.\n   * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n   */\n  public void onSubmit()\n  {\n    final String sessionCsrfToken = getCsrfSessionToken();\n    final String postedCsrfToken = this.csrfTokenField.getInput();\n    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + postedCsrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }\n}\n",
        "code_after_change": "/////////////////////////////////////////////////////////////////////////////\n//\n// Project ProjectForge Community Edition\n//         www.projectforge.org\n//\n// Copyright (C) 2001-2013 Kai Reinhard (k.reinhard@micromata.de)\n//\n// ProjectForge is dual-licensed.\n//\n// This community edition is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License as published\n// by the Free Software Foundation; version 3 of the License.\n//\n// This community edition is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General\n// Public License for more details.\n//\n// You should have received a copy of the GNU General Public License along\n// with this program; if not, see http://www.gnu.org/licenses/.\n//\n/////////////////////////////////////////////////////////////////////////////\n\npackage org.projectforge.web.wicket;\n\nimport java.io.Serializable;\n\nimport org.apache.commons.lang.StringUtils;\nimport org.apache.wicket.Session;\nimport org.apache.wicket.markup.html.form.Form;\nimport org.apache.wicket.markup.html.form.HiddenField;\nimport org.apache.wicket.model.PropertyModel;\nimport org.projectforge.core.InternalErrorException;\n\n/**\n * Every form should use this handler for preventing cross site request forgery attacks.\n * @author Kai Reinhard (k.reinhard@micromata.de)\n * \n */\npublic class CsrfTokenHandler implements Serializable\n{\n  private static final long serialVersionUID = -9129345307409567900L;\n\n  private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n\n  private final String csrfToken;\n\n  /**\n   * The given form should contain a hidden field named 'csrfToken'.\n   * @param form\n   */\n  public CsrfTokenHandler(final Form< ? > form)\n  {\n    csrfToken = getCsrfSessionToken();\n    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n  }\n\n  /**\n   * This parameter should be set as hidden field in every formular and should be tested on every submit action for preventing CSRF attacks.\n   * @return the randomized cross site request forgery token.\n   */\n  private String getCsrfSessionToken()\n  {\n    final MySession session = (MySession) Session.get();\n    return session.getCsrfToken();\n  }\n\n  /**\n   * Checks the cross site request forgery token (as posted hidden field) and if it doesn't match an exception is thrown.\n   * @see org.apache.wicket.markup.html.form.Form#onSubmit()\n   */\n  public void onSubmit()\n  {\n    final String sessionCsrfToken = getCsrfSessionToken();\n    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n      log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n          + sessionCsrfToken\n          + \", posted csrf token=\"\n          + csrfToken);\n      throw new InternalErrorException(\"errorpage.csrfError\");\n    }\n  }\n}\n",
        "patch": "@@ -29,7 +29,7 @@\n import org.apache.wicket.Session;\n import org.apache.wicket.markup.html.form.Form;\n import org.apache.wicket.markup.html.form.HiddenField;\n-import org.apache.wicket.model.Model;\n+import org.apache.wicket.model.PropertyModel;\n import org.projectforge.core.InternalErrorException;\n \n /**\n@@ -43,15 +43,16 @@ public class CsrfTokenHandler implements Serializable\n \n   private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(CsrfTokenHandler.class);\n \n-  private HiddenField<String> csrfTokenField;\n+  private final String csrfToken;\n \n   /**\n    * The given form should contain a hidden field named 'csrfToken'.\n    * @param form\n    */\n   public CsrfTokenHandler(final Form< ? > form)\n   {\n-    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n+    csrfToken = getCsrfSessionToken();\n+    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n   }\n \n   /**\n@@ -71,12 +72,11 @@ private String getCsrfSessionToken()\n   public void onSubmit()\n   {\n     final String sessionCsrfToken = getCsrfSessionToken();\n-    final String postedCsrfToken = this.csrfTokenField.getInput();\n-    if (StringUtils.equals(sessionCsrfToken, postedCsrfToken) == false) {\n+    if (StringUtils.equals(sessionCsrfToken, csrfToken) == false) {\n       log.error(\"Cross site request forgery alert. csrf token doesn't match! session csrf token=\"\n           + sessionCsrfToken\n           + \", posted csrf token=\"\n-          + postedCsrfToken);\n+          + csrfToken);\n       throw new InternalErrorException(\"errorpage.csrfError\");\n     }\n   }",
        "function_modified_lines": {
            "added": [
                "import org.apache.wicket.model.PropertyModel;\n",
                "  private final String csrfToken;\n",
                "    csrfToken = getCsrfSessionToken();\n",
                "    form.add(new HiddenField<String>(\"csrfToken\", new PropertyModel<String>(this, \"csrfToken\")));\n"
            ],
            "deleted": [
                "import org.apache.wicket.model.Model;\n",
                "  private HiddenField<String> csrfTokenField;\n",
                "    form.add(csrfTokenField = new HiddenField<String>(\"csrfToken\", Model.of(getCsrfSessionToken())));\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "Multiple cross-site request forgery (CSRF) vulnerabilities in ProjectForge before 5.3 allow remote attackers to hijack the authentication of arbitrary users via vectors related to (1) web/admin/, (2) web/core/, (3) web/dialog/, (4) web/fibu/, (5) web/mobile/, (6) web/task/, or (7) web/wicket/.",
        "id": 11972
    },
    {
        "cve_id": "CVE-2021-25930",
        "code_before_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
        "code_after_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
        "patch": "@@ -60,6 +60,10 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         String userID = request.getParameter(\"userID\");\n         String newID = request.getParameter(\"newID\");\n \n+        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         // now save to the xml file\n         try {\n             UserManager userFactory = UserFactory.getInstance();",
        "function_modified_lines": {
            "added": [
                "        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n",
                "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
                "        }\n",
                "\n"
            ],
            "deleted": []
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection, and since there is no validation of an existing user name while renaming a user. As a result, privileges of the renamed user are being overwritten by the old user and the old user is being deleted from the user list.",
        "id": 12054
    },
    {
        "cve_id": "CVE-2021-25931",
        "code_before_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
        "code_after_change": "{\n        String userID = request.getParameter(\"userID\");\n        String newID = request.getParameter(\"newID\");\n\n        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n            throw new ServletException(\"User ID must not contain any HTML markup.\");\n        }\n\n        // now save to the xml file\n        try {\n            UserManager userFactory = UserFactory.getInstance();\n            userFactory.renameUser(userID, newID);\n        } catch (Throwable e) {\n            throw new ServletException(\"Error renaming user \" + userID + \" to \" + newID, e);\n        }\n\n        response.sendRedirect(\"list.jsp\");\n    }",
        "patch": "@@ -60,6 +60,10 @@ public void doPost(HttpServletRequest request, HttpServletResponse response) thr\n         String userID = request.getParameter(\"userID\");\n         String newID = request.getParameter(\"newID\");\n \n+        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n+            throw new ServletException(\"User ID must not contain any HTML markup.\");\n+        }\n+\n         // now save to the xml file\n         try {\n             UserManager userFactory = UserFactory.getInstance();",
        "function_modified_lines": {
            "added": [
                "        if (newID != null && newID.matches(\".*[&<>\\\"`']+.*\")) {\n",
                "            throw new ServletException(\"User ID must not contain any HTML markup.\");\n",
                "        }\n",
                "\n"
            ],
            "deleted": []
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "In OpenNMS Horizon, versions opennms-1-0-stable through opennms-27.1.0-1; OpenNMS Meridian, versions meridian-foundation-2015.1.0-1 through meridian-foundation-2019.1.18-1; meridian-foundation-2020.1.0-1 through meridian-foundation-2020.1.6-1 are vulnerable to CSRF, due to no CSRF protection at `/opennms/admin/userGroupView/users/updateUser`. This flaw allows assigning `ROLE_ADMIN` security role to a normal user. Using this flaw, an attacker can trick the admin user to assign administrator privileges to a normal user by enticing him to click upon an attacker-controlled website.",
        "id": 12058
    },
    {
        "cve_id": "CVE-2023-37277",
        "code_before_change": "{\n    private String wikiName;\n\n    private List<String> spaces;\n\n    private String pageName;\n\n    private DocumentReference reference;\n\n    @Before\n    @Override\n    public void setUp() throws Exception\n    {\n        super.setUp();\n\n        this.wikiName = getWiki();\n        this.spaces = Arrays.asList(getTestClassName());\n        this.pageName = getTestMethodName();\n\n        this.reference = new DocumentReference(this.wikiName, this.spaces, this.pageName);\n\n        // Create a clean test page.\n        this.testUtils.rest().delete(this.reference);\n        this.testUtils.rest().savePage(this.reference);\n    }\n\n    @Override\n    @Test\n    public void testRepresentation() throws Exception\n    {\n        /* Everything is done in test methods */\n    }\n\n    @Test\n    public void testPOSTComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        Comment comment = objectFactory.createComment();\n        comment.setText(\"Comment\");\n\n        PostMethod postMethod = executePostXml(commentsUri, comment, TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(),\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlain() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testGETComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (Comment comment : comments.getComments()) {\n            checkLinks(comment);\n        }\n    }\n\n    @Test\n    public void testGETCommentsAtPreviousVersions() throws Exception\n    {\n        String pageHistoryUri = buildURI(PageHistoryResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(pageHistoryUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        History history = (History) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (HistorySummary historySummary : history.getHistorySummaries()) {\n            getMethod = executeGet(getFirstLinkByRelation(historySummary, Relations.PAGE).getHref());\n            Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n            Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n            if (getFirstLinkByRelation(page, Relations.COMMENTS) != null) {\n                getMethod = executeGet(getFirstLinkByRelation(page, Relations.COMMENTS).getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n            }\n        }\n    }\n\n    @Test\n    public void testPOSTCommentFormUrlEncoded() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        NameValuePair[] nameValuePairs = new NameValuePair[1];\n        nameValuePairs[0] = new NameValuePair(\"text\", \"Comment\");\n\n        PostMethod postMethod = executePostForm(commentsUri, nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n}",
        "code_after_change": "{\n    private String wikiName;\n\n    private List<String> spaces;\n\n    private String pageName;\n\n    private DocumentReference reference;\n\n    @Before\n    @Override\n    public void setUp() throws Exception\n    {\n        super.setUp();\n\n        this.wikiName = getWiki();\n        this.spaces = Arrays.asList(getTestClassName());\n        this.pageName = getTestMethodName();\n\n        this.reference = new DocumentReference(this.wikiName, this.spaces, this.pageName);\n\n        // Create a clean test page.\n        this.testUtils.rest().delete(this.reference);\n        this.testUtils.rest().savePage(this.reference);\n    }\n\n    @Override\n    @Test\n    public void testRepresentation() throws Exception\n    {\n        /* Everything is done in test methods */\n    }\n\n    @Test\n    public void testPOSTComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        Comment comment = objectFactory.createComment();\n        comment.setText(\"Comment\");\n\n        PostMethod postMethod = executePostXml(commentsUri, comment, TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(),\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlain() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n\n    @Test\n    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments, comments.getComments().size());\n    }\n\n    @Test\n    public void testGETComment() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (Comment comment : comments.getComments()) {\n            checkLinks(comment);\n        }\n    }\n\n    @Test\n    public void testGETCommentsAtPreviousVersions() throws Exception\n    {\n        String pageHistoryUri = buildURI(PageHistoryResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(pageHistoryUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        History history = (History) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        for (HistorySummary historySummary : history.getHistorySummaries()) {\n            getMethod = executeGet(getFirstLinkByRelation(historySummary, Relations.PAGE).getHref());\n            Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n            Page page = (Page) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n            if (getFirstLinkByRelation(page, Relations.COMMENTS) != null) {\n                getMethod = executeGet(getFirstLinkByRelation(page, Relations.COMMENTS).getHref());\n                Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n            }\n        }\n    }\n\n    @Test\n    public void testPOSTCommentFormUrlEncoded() throws Exception\n    {\n        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n\n        GetMethod getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        int numberOfComments = comments.getComments().size();\n\n        NameValuePair[] nameValuePairs = new NameValuePair[1];\n        nameValuePairs[0] = new NameValuePair(\"text\", \"Comment\");\n\n        PostMethod postMethod = executePostForm(commentsUri, nameValuePairs,\n            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword());\n        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_CREATED, postMethod.getStatusCode());\n\n        getMethod = executeGet(commentsUri);\n        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n\n        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n\n        Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n    }\n}",
        "patch": "@@ -128,6 +128,31 @@ public void testPOSTCommentWithTextPlain() throws Exception\n         Assert.assertEquals(numberOfComments + 1, comments.getComments().size());\n     }\n \n+    @Test\n+    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n+    {\n+        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n+\n+        GetMethod getMethod = executeGet(commentsUri);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+\n+        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+\n+        int numberOfComments = comments.getComments().size();\n+\n+        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n+            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n+        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n+        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n+\n+        getMethod = executeGet(commentsUri);\n+        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n+\n+        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n+\n+        Assert.assertEquals(numberOfComments, comments.getComments().size());\n+    }\n+\n     @Test\n     public void testGETComment() throws Exception\n     {",
        "function_modified_lines": {
            "added": [
                "    @Test\n",
                "    public void testPOSTCommentWithTextPlainNoCSRF() throws Exception\n",
                "    {\n",
                "        String commentsUri = buildURI(CommentsResource.class, getWiki(), this.spaces, this.pageName).toString();\n",
                "\n",
                "        GetMethod getMethod = executeGet(commentsUri);\n",
                "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
                "\n",
                "        Comments comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
                "\n",
                "        int numberOfComments = comments.getComments().size();\n",
                "\n",
                "        PostMethod postMethod = executePost(commentsUri, \"Comment\", MediaType.TEXT_PLAIN,\n",
                "            TestUtils.SUPER_ADMIN_CREDENTIALS.getUserName(), TestUtils.SUPER_ADMIN_CREDENTIALS.getPassword(), null);\n",
                "        Assert.assertEquals(getHttpMethodInfo(postMethod), HttpStatus.SC_FORBIDDEN, postMethod.getStatusCode());\n",
                "        Assert.assertEquals(\"Invalid or missing form token.\", postMethod.getResponseBodyAsString());\n",
                "\n",
                "        getMethod = executeGet(commentsUri);\n",
                "        Assert.assertEquals(getHttpMethodInfo(getMethod), HttpStatus.SC_OK, getMethod.getStatusCode());\n",
                "\n",
                "        comments = (Comments) unmarshaller.unmarshal(getMethod.getResponseBodyAsStream());\n",
                "\n",
                "        Assert.assertEquals(numberOfComments, comments.getComments().size());\n",
                "    }\n",
                "\n"
            ],
            "deleted": []
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The REST API allows executing all actions via POST requests and accepts `text/plain`, `multipart/form-data` or `application/www-form-urlencoded` as content types which can be sent via regular HTML forms, thus allowing cross-site request forgery. With the interaction of a user with programming rights, this allows remote code execution through script macros and thus impacts the integrity, availability and confidentiality of the whole XWiki installation. For regular cookie-based authentication, the vulnerability is mitigated by SameSite cookie restrictions but as of March 2023, these are not enabled by default in Firefox and Safari. The vulnerability has been patched in XWiki 14.10.8 and 15.2 by requiring a CSRF token header for certain request types that are susceptible to CSRF attacks.\n\n",
        "id": 12390
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424345\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42124343\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424334466\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");",
        "code_after_change": "        // The tests are below this line!\n\n        // Verify that the create template is rendered, so the UI is displayed for the user to enter the missing values.\n        assertEquals(\"create\", result);\n\n        // We should not get this far so no redirect should be done, just the template will be rendered.\n        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void existingDocumentFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n"
            ],
            "deleted": [
                "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n",
                "        String csrfTokenValue = \"token42124343\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12434
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token422112455\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42778900\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4344119982\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");",
        "code_after_change": "        assertNull(result);\n\n        // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X.Y&page=Z\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Z\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n        // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n        verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n        verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI space=X&page=Y&tocreate=space\n        when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"page\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"space\");\n\n        // Run the action\n        String result = action.render(context);\n",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
            ],
            "deleted": [
                "            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
                "        String csrfTokenValue = \"token42778900\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12439
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token424334466\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token429988\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUIButAlreadyExisting() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        // Mock it as existing in the DB as well with non-empty content\n        oldcore.getDocuments().put(new DocumentReference(documentReference, Locale.ROOT), document);\n        when(document.getContent()).thenReturn(\"Some non-empty content\");\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        // No diference if it was a non-terminal document, just easier to mock since we already have Main.WebHome set",
        "code_after_change": "        assertNull(result);\n\n        // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n        verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n            \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUI() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUICheckEscaping() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Z\");\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n        verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n            context);\n    }\n\n    @Test\n    void existingDocumentTerminalFromUIButAlreadyExisting() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        // Mock it as existing in the DB as well with non-empty content\n        oldcore.getDocuments().put(new DocumentReference(documentReference, Locale.ROOT), document);\n        when(document.getContent()).thenReturn(\"Some non-empty content\");\n\n        // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n        // No diference if it was a non-terminal document, just easier to mock since we already have Main.WebHome set\n        // up.\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"Main\");",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n"
            ],
            "deleted": [
                "            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n",
                "        String csrfTokenValue = \"token429988\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12436
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token421198337\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token429866333\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n        // compatibility resolutions. Also using the template extracted from the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedWithSaveAndEdit() throws Exception\n    {\n        // Mock the document to create.\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.getDocumentReferenceWithLocale()).thenReturn(documentReference);",
        "code_after_change": "    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y.WebHome as non-terminal, since the template provider does not specify a \"terminal\"\n        // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenFromUIToTerminal() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n        when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(), null,\n            \"space\");\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n        // compatibility resolutions. Also using the template extracted from the template provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedWithSaveAndEdit() throws Exception\n    {\n        // Mock the document to create.\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.getDocumentReferenceWithLocale()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
            ],
            "deleted": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
                "        String csrfTokenValue = \"token429866333\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12453
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42988733\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4222113555\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);",
        "code_after_change": "        verify(mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(), any(XWikiContext.class));\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIToNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\", \"Y\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            true);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n        // Also using a template, as specified in the template provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
            ],
            "deleted": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
                "        String csrfTokenValue = \"token4222113555\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12442
    },
    {
        "cve_id": "CVE-2023-40572",
        "code_before_change": "\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token4200983331\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n        String csrfTokenValue = \"token42234456\";\n        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n",
        "code_after_change": "            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITerminal() throws Exception\n    {\n        // new document = xwiki:X.Y\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", \"X\", \"Y\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(true);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n        context.setDoc(document);\n\n        // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n        String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n        when(mockRequest.getParameter(\"templateprovider\")).thenReturn(templateProviderFullName);\n        when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n\n        // Mock 1 existing template provider\n        mockExistingTemplateProviders(templateProviderFullName,\n            new DocumentReference(\"xwiki\", Arrays.asList(\"XWiki\"), \"MyTemplateProvider\"), Collections.emptyList(),\n            false);\n\n        // Run the action\n        String result = action.render(context);\n\n        // The tests are below this line!\n\n        // Verify null is returned (this means the response has been returned)\n        assertNull(result);\n\n        // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n        // provider.\n        verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n            null, \"xwiki\", context);\n    }\n\n    @Test\n    void existingDocumentFromUITemplateSpecified() throws Exception\n    {\n        // current document = xwiki:Main.WebHome\n        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"Main\"), \"WebHome\");\n        XWikiDocument document = mock(XWikiDocument.class);\n        when(document.getDocumentReference()).thenReturn(documentReference);\n        when(document.isNew()).thenReturn(false);\n        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n\n        context.setDoc(document);\n",
        "patch": "@@ -72,6 +72,8 @@\n @OldcoreTest\n class CreateActionTest\n {\n+    private static final String CSRF_TOKEN_VALUE = \"token4234343\";\n+\n     @InjectMockitoOldcore\n     MockitoOldcore oldcore;\n \n@@ -125,6 +127,10 @@ public void beforeEach() throws Exception\n         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");\n \n         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);\n+\n+        when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);\n+        when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);\n     }\n \n     @Test\n@@ -137,8 +143,6 @@ void newDocumentFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -149,11 +153,42 @@ void newDocumentFromURL() throws Exception\n         assertNull(result);\n \n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\",\n             context);\n     }\n \n+    @Test\n+    void newDocumentFromURLWithInvalidToken() throws Exception\n+    {\n+        // new document = xwiki:X.Y\n+        DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");\n+        XWikiDocument document = mock(XWikiDocument.class);\n+        when(document.getDocumentReference()).thenReturn(documentReference);\n+        when(document.isNew()).thenReturn(true);\n+        when(document.getLocalReferenceMaxLength()).thenReturn(255);\n+        this.context.setDoc(document);\n+\n+        // Submit an invalid token\n+        when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");\n+\n+        // Run the action\n+        String result = this.action.render(this.context);\n+\n+        // The tests are below this line!\n+\n+        // Verify that the create template is rendered, so the UI is displayed for the user to re-submit with the\n+        // form token.\n+        assertEquals(\"create\", result);\n+\n+        // Verify that we got until the token validation.\n+        verify(this.csrfToken).isTokenValid(\"fakeToken\");\n+\n+        // We should not get this far so no redirect should be done, just the template will be rendered.\n+        verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),\n+            any(XWikiContext.class));\n+    }\n+\n     @Test\n     void newDocumentButNonTerminalFromURL() throws Exception\n     {\n@@ -164,8 +199,6 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token432\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=nonterminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");\n@@ -178,8 +211,11 @@ void newDocumentButNonTerminalFromURL() throws Exception\n         // Verify null is returned (this means the response has been returned)\n         assertNull(result);\n \n+        // Verify that the token has been validated.\n+        verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);\n+\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -216,8 +252,6 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -229,7 +263,7 @@ void newDocumentWebHomeTopLevelFromURL() throws Exception\n \n         // Note: The title is not \"WebHome\", but \"X\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -243,8 +277,6 @@ void newDocumentWebHomeFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token34342\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Run the action\n         String result = action.render(context);\n@@ -257,7 +289,7 @@ void newDocumentWebHomeFromURL() throws Exception\n         // Note1: The bebavior is the same for both a top level space and a child space WebHome.\n         // Note2: The title is not \"WebHome\", but \"Y\" (the space's name) to avoid exposing \"WebHome\" in the UI.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -271,8 +303,6 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4234343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Pass the tocreate=terminal request parameter\n         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");\n@@ -287,7 +317,7 @@ void newDocumentWebHomeButTerminalFromURL() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -355,8 +385,6 @@ void existingDocumentFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424345\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -372,7 +400,7 @@ void existingDocumentFromUI() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -386,8 +414,6 @@ void existingDocumentFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42124343\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -403,7 +429,7 @@ void existingDocumentFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -417,8 +443,6 @@ void existingDocumentTerminalFromUI() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424334466\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&tocreate=terminal\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");\n@@ -435,7 +459,7 @@ void existingDocumentTerminalFromUI() throws Exception\n \n         // Note: We are creating X.Y instead of X.Y.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -449,8 +473,6 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429988\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y&name=Z&tocreate=termina\n         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");\n@@ -467,7 +489,7 @@ void existingDocumentTerminalFromUICheckEscaping() throws Exception\n \n         // Note: We are creating X.Y.Z instead of X.Y.Z.WebHome because the tocreate parameter says \"terminal\".\n         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -581,8 +603,6 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42009\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI name=Y\n         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");\n@@ -597,7 +617,7 @@ void existingDocumentFromUITopLevelDocument() throws Exception\n \n         // Note: We are creating X.Y.WebHome since we default to non-terminal documents.\n         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -615,8 +635,6 @@ void existingDocumentFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4233311\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -632,7 +650,7 @@ void existingDocumentFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.Y since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -646,8 +664,6 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422112455\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&page=Z\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -664,7 +680,7 @@ void existingDocumentFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.Z since the deprecated parameters were creating terminal documents by default.\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -678,8 +694,6 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42778900\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -695,7 +709,7 @@ void existingDocumentNonTerminalFromUIDeprecated() throws Exception\n \n         // Note: We are creating X.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -709,8 +723,6 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4344119982\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X&page=Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");\n@@ -728,7 +740,7 @@ void existingDocumentNonTerminalFromUIDeprecatedIgnoringPage() throws Exception\n         // Note: We are creating X.WebHome instead of X.Y because the tocreate parameter says \"space\" and the page\n         // parameter is ignored.\n         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -742,8 +754,6 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token425553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI space=X.Y&tocreate=space\n         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");\n@@ -760,7 +770,7 @@ void existingDocumentNonTerminalFromUIDeprecatedCheckEscaping() throws Exception\n         // Note1: The space parameter was previously considered as space name, not space reference, so it is escaped.\n         // Note2: We are creating X\\.Y.WebHome because the tocreate parameter says \"space\".\n         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",\n-            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,\n+            \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,\n             \"xwiki\", context);\n     }\n \n@@ -901,8 +911,6 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008766\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -924,7 +932,7 @@ void existingDocumentFromUITemplateProviderSpecified() throws Exception\n \n         // Note: We are creating X.Y and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",\n             context);\n     }\n \n@@ -977,8 +985,6 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4221098\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X.Y.Z&name=W&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1004,7 +1010,7 @@ void existingDocumentFromUITemplateProviderSpecifiedRestrictionExistsOnParentSpa\n         // document\n         // Note2: We are creating X.Y.Z.W and using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1132,8 +1138,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42988733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1155,7 +1159,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminal() throws Excepti\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1169,8 +1173,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4222113555\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1193,7 +1195,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedTerminalOverriddenFromUIT\n         // Note: We are creating the document X.Y.WebHome as non-terminal even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1207,8 +1209,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4200983331\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1230,7 +1230,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1244,8 +1244,6 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42234456\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1268,7 +1266,7 @@ void newDocumentFromURLTemplateProviderSpecifiedNonTerminalButOverriddenFromUITe\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1283,8 +1281,6 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n \n         context.setDoc(document);\n-        String csrfTokenValue = \"token4298833\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&template=XWiki.MyTemplate\n         String templateDocumentFullName = \"XWiki.MyTemplate\";\n@@ -1307,7 +1303,7 @@ void existingDocumentFromUITemplateSpecified() throws Exception\n \n         // Note: We are creating X.Y.WebHome and using the template specified in the request.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1321,8 +1317,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4244112\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1347,7 +1341,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminal() throws Exception\n         // Note: We are creating the document X.Y as terminal and using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1361,8 +1355,6 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token422555987\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1388,7 +1380,7 @@ void existingDocumentFromUITemplateProviderSpecifiedTerminalOverridenFromUIToNon\n         // Note: We are creating the document X.Y.WebHome as non-terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1402,8 +1394,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token424111553\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1428,7 +1418,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminal() throws Excepti\n         // Note: We are creating the document X.Y.WebHome as non-terminal and using a template, as specified in the\n         // template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1442,8 +1432,6 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token42008733\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1469,7 +1457,7 @@ void existingDocumentFromUITemplateProviderSpecifiedNonTerminalOverridenFromUITo\n         // Note: We are creating the document X.Y as terminal, even if the template provider says otherwise.\n         // Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1483,8 +1471,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token423366\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1507,7 +1493,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageType() throws E\n         // property and it used the old \"page\" type instead. Also using a template, as specified in the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1522,8 +1508,6 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         when(document.isNew()).thenReturn(true);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token4265677398\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Specifying a template provider in the URL: templateprovider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1547,7 +1531,7 @@ void newDocumentWebHomeFromURLTemplateProviderSpecifiedButOldPageTypeButOverridd\n         // specify a \"terminal\" property and it used the old \"page\" type, the UI explicitly asked for a non-terminal\n         // document. Also using a template, as specified in the template provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1561,8 +1545,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token421198337\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1587,7 +1569,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceType() throws Exc\n         // property and we fallback on the \"type\" property's value. Also using the template extracted from the template\n         // provider.\n         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n \n@@ -1601,8 +1583,6 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         when(document.isNew()).thenReturn(false);\n         when(document.getLocalReferenceMaxLength()).thenReturn(255);\n         context.setDoc(document);\n-        String csrfTokenValue = \"token429866333\";\n-        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n \n         // Submit from the UI spaceReference=X&name=Y&templateProvider=XWiki.MyTemplateProvider\n         String templateProviderFullName = \"XWiki.MyTemplateProvider\";\n@@ -1627,7 +1607,7 @@ void existingDocumentFromUITemplateProviderSpecifiedButOldSpaceTypeButOverridenF\n         // Note: We are creating X.Y as terminal, since it is overriden from the UI, regardless of any backwards\n         // compatibility resolutions. Also using the template extracted from the template provider.\n         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",\n-            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n+            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n             null, \"xwiki\", context);\n     }\n ",
        "function_modified_lines": {
            "added": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,\n"
            ],
            "deleted": [
                "            \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,\n",
                "        String csrfTokenValue = \"token42234456\";\n",
                "        when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);\n"
            ]
        },
        "lang": "Java",
        "cwe": [
            "CWE-352"
        ],
        "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
        "id": 12444
    }
]